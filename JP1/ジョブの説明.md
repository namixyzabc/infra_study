
---

### 1. JP1/AJS3におけるジョブネットワークの階層構造

JP1/AJS3では、自動化する業務を構成する一つ一つの要素を「ユニット」と呼びます。ユニットは階層構造で管理され、業務の複雑さに応じて柔軟に定義できます。

*   **ジョブ (Job)**:
    *   業務を構成するユニットの**最小単位**です。
    *   コマンド、アプリケーションプログラム、シェルスクリプトなど、個々の作業や処理を指します。
    *   ジョブは、その一つ一つの処理を実行順に並べて順序づけられます。あるジョブの直前に実行されるジョブを「先行ジョブ」、直後に実行されるジョブを「後続ジョブ」と呼びます。
    *   実行ファイルの種類として、Windowsホストでは.exe, .com, .cmd, .bat, JP1/Scriptで作成したスクリプトファイル(.spt)が使用できます。UNIXホストではシェルスクリプトが使用できます。
*   **ジョブネット (Jobnet)**:
    *   複数のジョブをまとめて、作業の順序を定義したものです。
    *   JP1/AJS3で自動化される業務は、ジョブネット単位で実行されます。
    *   作業の順序は単純な直列だけでなく、複数の作業の並行処理や、集計結果による次の処理の分岐など、さまざまな条件に従って業務フローを定義できます。
    *   ジョブネットの中にさらにジョブネットを定義することもでき、これを「ネストジョブネット」と呼びます。
*   **ジョブグループ (Jobgroup)**:
    *   複数のジョブネットをまとめて管理するための「フォルダ」のようなものです。
    *   ジョブグループの下に、さらにジョブグループを作成することも可能です。
    *   ジョブグループ自体は実行できませんが、ジョブネットの管理単位として使用されます。
    *   JP1/AJS3運用上のカレンダー情報を定義でき、その配下のジョブネットに適用されます。
*   **プランニンググループ (Planning Group)**:
    *   複数のルートジョブネットをグループとしてまとめ、実行期間を指定することで**計画的にジョブネットを切り替えて運用する**場合に使用するユニットです。
    *   例えば、8/1から8/5までジョブネットAを実行し、8/6から8/10までジョブネットBに切り替えるといった運用が可能です。
    *   スケジューラーサービス（AJSROOT）またはジョブグループの直下に作成でき、その直下にはルートジョブネットまたはリモートジョブネットのみ作成可能です。
    *   プランニンググループにもJP1/AJS3運用上のカレンダー情報を定義できます。
*   **スケジューラーサービス (Scheduler Service)**:
    *   ジョブネットを実行するスケジュールを管理し、スケジュールに従って処理を実行する制御単位です。
    *   ルートジョブグループ（最上位のジョブグループ）としてデフォルトで「AJSROOT1」のように定義されており、その下位に定義されたユニット全体を管理します。
    *   それぞれ独立した設定環境を持つことができるため、新たな運用のテスト用として使用したり、独立した業務を並行して運用したりできます。

**ジョブネットワーク管理階層の例**:
```
ジョブグループ (Jobgroup)
  └─ ジョブネット (Jobnet)
        ├─ ジョブ (Job)
        ├─ ジョブ (Job)
        └─ ジョブ (Job)
  └─ ジョブネット (Jobnet)
        ├─ ジョブ (Job)
        ├─ ジョブ (Job)
        └─ ジョブ (Job)
  └─ プランニンググループ (Planning Group)
        ├─ ジョブネット (Jobnet)
        │     ├─ ジョブ (Job)
        │     ├─ ジョブ (Job)
        │     └─ ジョブ (Job)
        └─ ジョブネット (Jobnet)
              ├─ ジョブ (Job)
              ├─ ジョブ (Job)
              └─ ジョブ (Job)
```


### 2. ジョブネットの構築と実務での主要な概念

JP1/AJS3で業務を自動化するためのジョブネット定義の一般的な流れは以下の通りです。

1.  必要に応じてジョブグループを作成する。
2.  ジョブネットを作成する。
3.  ジョブを作成する。
4.  必要に応じて作成したジョブを順序づけする。
5.  必要に応じてジョブネットの起動条件を設定する。

#### 2.1 業務内容と実行順序の定義

業務処理の最小単位が「ジョブ」であり、複数のジョブをまとめて作業の順序を定義したものが「ジョブネット」です。例えば、売上伝票作成業務は「データの入力」→「データの集計」→「帳票作成」→「プリンタ出力」といった順序で構成されます。JP1/AJS3では、このような業務フローを定義し、自動実行できます。

**リカバリージョブ (Recovery Job)**:
先行するジョブまたはジョブネットが異常終了したときに自動的に実行されるジョブです。例えば、在庫チェックジョブが異常終了した場合に、発注伝票作成リカバリージョブを実行するといった設定が可能です。

**判定ジョブ (Decision Job)**:
前に実行された処理の終了結果によって、次に実行する処理を振り分けるジョブです。
*   **リターンコードによる判定**: 例えば、「在庫チェック」ジョブが在庫不足を示す戻り値（例: 4）を返した場合に「発注伝票作成」ジョブを実行し、それ以外（例: 3以下）の場合は「受注伝票作成」ジョブを実行するといった分岐が可能です。
    *   設定例:
        *   「在庫チェック」ジョブの終了判定に「しきい値による判定」、異常しきい値に「4」を設定。
        *   判定ジョブの判定条件に「終了コードが判定値と等しい」かつ「判定値: 4」を設定し、「発注伝票作成」ジョブを従属ジョブとして関連付ける。
*   **ファイルの有無による判定**: 特定のファイルが存在するかどうかで処理を分岐させることもできます。

**ORジョブ (OR Job)**:
先行する複数のイベントジョブのうち、どれか一つでも監視している事象が発生した場合に後続のORジョブが実行されます。

**自動リトライ (Automatic Retry)**:
ジョブに定義した実行ファイルが異常終了した場合に、ジョブを自動でリトライする機能です。一時的なエラーからの回復に役立ち、業務の継続性を高めます。
*   設定項目: 終了コードの範囲、最大リトライ回数、リトライ間隔。
*   注意点: 必要最低限の終了コード範囲を設定しないと、回復見込みのないエラーでもリトライを繰り返し、性能に影響を与える可能性があります。

#### 2.2 業務スケジュールの定義

業務を自動運用するには、いつ実行するかを決めるスケジュールの定義が必要です。

*   **カレンダー定義 (Calendar Definition)**:
    *   会社の営業日や休業日（運用日・休業日）を設定し、JP1/AJS3運用上のカレンダーを定義します。
    *   **設定手順 (JP1/AJS3 - View)**:
        1.  ［JP1/AJS3 - View］ウィンドウの機能メニューエリアで［カレンダー定義］を選択。
        2.  ツリーエリアでジョブグループを選択。
        3.  ［編集］−［カレンダー］を選択し、［月間カレンダー編集］ウィンドウを表示。
        4.  ［表示］−［年間カレンダー編集］を選択し、［年間カレンダー編集］ウィンドウを表示。
        5.  ［週間標準値］で、例えば［日］と［土］を1回ずつクリックすると、すべての土曜日と日曜日に休業日が設定され薄い赤色で表示されます。
        6.  ［週間標準値］で［月］〜［金］を2回ずつクリックすると、月曜日〜金曜日がすべて運用日になり薄い青色で表示されます。
        7.  カレンダーの日付部分をクリックして、土日以外の休業日（例: 祝日）を設定します。
    *   **基準日・基準時刻の設定**: 何日から何日までを1か月として扱うか、1日の開始時刻を何時からとするかなどを設定できます。例えば、毎月25日締め処理なら26日を月の開始日とし、AM7:00から翌日のAM6:59までを1日と考える、といった設定が可能です。
    *   **他ジョブグループのカレンダー参照**: 自ジョブネットが属するジョブグループ以外のカレンダー定義を運用スケジュールとして参照できます。
*   **実行登録方法 (Execution Registration Method)**:
    ジョブネットを実行登録することで、JP1/AJS3にスケジュールされ、自動化運用が開始します。ルートジョブネットに対して行い、その下にあるすべてのユニットが実行登録されます。
    主な実行登録方法は以下の3種類です。

    1.  **計画実行 (Planned Execution)**:
        *   設定したスケジュールに従ってジョブネットを実行します。
        *   実行登録後にカレンダーやスケジュールを変更した場合、すぐにスケジュールが再設定され、新しいスケジュールで実行されます。
        *   初回実行予定だけが確定され、それ以降は擬似予定（シミュレーションされたスケジュール）として扱われます。
    2.  **確定実行 (Confirmed Execution)**:
        *   設定したスケジュールに基づいて、あらかじめ実行日時を算出し、その日時に従ってジョブネットを実行します。
        *   実行登録後にカレンダーやスケジュールを変更しても、実行予定は変わりません。変更内容は、その後の確定実行登録から有効になります。
    3.  **即時実行 (Immediate Execution)**:
        *   実行登録と同時にジョブネットを実行します。
        *   カレンダーやスケジュールは無効になり、実行登録ごとに実行を開始します。
        *   JP1/AJS3では、次回実行予定のないジョブネットは複数回即時実行登録できます。

    **実行登録手順の例 (JP1/AJS3 - View)**:
    1.  ［JP1/AJS3 - View］ウィンドウの機能メニューエリアで［実行登録］を選択。
    2.  ツリーエリアでジョブグループを選択し、リストエリアでジョブネットを選択。
    3.  ［操作］−［実行登録］を選択し、［実行登録］ダイアログボックスを表示。
    4.  ［登録方法］から適切な実行登録方法（計画実行、確定実行、即時実行）を選択。
    5.  ［OK］をクリックして実行登録を完了。

#### 2.3 業務開始のきっかけの登録（起動条件）

決まった時刻に業務を開始するだけでなく、ファイルが作成されたときや特定のイベントが発生したときなど、**何らかの事象を契機として業務を開始する**ことができます。これらの条件は「起動条件」として設定されます。

*   **イベントジョブ (Event Job)**:
    *   ファイルの作成・更新・削除、Windowsイベントの発生、JP1イベントの受信、時間経過など、様々な条件を検出してジョブネットの実行をトリガーできます。
    *   例: ファイル作成を検知したら実行開始、業務が異常終了したら10分後に自動でリカバリー処理を開始するなど。
    *   JP1イベント監視の処理性能は、一つのイベントジョブまたは起動条件付きジョブネットが、1件のイベント発生から次のイベントを処理できるようになるまでの時間で見積もられます。イベント発生頻度が速すぎるとボトルネックになる可能性があります。
    *   **監視世代と実行世代**: 起動条件付きジョブネットには「監視世代」と「実行世代」があります。
        *   **監視世代**: 起動条件を監視している状態。
        *   **実行世代**: 起動条件が成立して生成されたジョブネットのインスタンス。
    *   **AND条件での複数イベント監視**: 複数のイベントをAND条件で定義した場合、特定のイベントだけが立て続けに発生すると、「起動条件待ち」状態の実行世代が複数生成されることがあります。これが大量に生成されると性能に影響が出たり、監視世代が「監視打ち切り終了」状態になることがあります（7,680世代が上限）。
    *   **実行抑止**: ジョブネットの実行を一時的に停止する機能で、「実行保留」と「監視停止」の2種類があります。
        *   **実行保留**: 実行世代の実行を保留します。異常終了した後に起動条件が成立しても「保留中」状態となり、運用再開時に実行できます。
        *   **監視停止**: 起動条件の監視を停止します。
    *   **イベントジョブ実行中のサービス再起動に関する注意**: イベントジョブが実行中の状態でJP1/AJS3サービスをウォームスタートまたはホットスタートなどで再起動すると、高負荷状態になったり、実行状態の不整合が発生したりすることがあります。
        *   回避方法: 操作前にジョブネットを強制終了し、操作後に再度実行登録し直す。
        *   マネージャーホスト名固定化オプション (FixedHostnameForAgent) を有効にすることで、マネージャーホスト名の英文字の大文字小文字の変更による不整合を回避できます。

#### 2.4 マネージャー・エージェント構成とジョブ実行環境

JP1/AJS3は、複数のホストと連携して業務を実行する場合でも、1台の「マネージャーホスト」で業務を一元管理できます。実際に業務を実行するホストは「エージェントホスト」と呼ばれます。

*   **ジョブ実行の仕組み**:
    *   マネージャーホストからエージェントホストにジョブが転送され、実行されます。
    *   **実行エージェント (Execution Agent)**: JP1/AJS3のジョブの実行先として定義する論理的な名称です。物理的なホスト名と実行エージェントをマッピングすることで、ジョブの実行先を決定します。これによりジョブ定義のポータビリティが向上します。
    *   **実行エージェントグループ (Execution Agent Group)**: 複数の実行エージェントをグルーピングしたもので、ジョブの実行を複数のエージェントに分散して負荷分散を実現します。優先順位を設定してジョブ配信先を決定することもできます。
    *   **ジョブ実行制御**: 実行登録されたジョブを一時的にメモリにためておき、同時に実行するジョブ数を制御しながら、エージェントホストに順次配信します。
    *   **標準出力・標準エラー出力**: ジョブの実行結果は、デフォルトで標準エラー出力として取得され、JP1/AJS3 - Viewの［実行結果詳細］ダイアログボックスで表示できます。標準出力も表示したい場合は、両方に同じファイル名を指定します。
    *   **ファイル転送時の文字コード**: マネージャーホストとエージェントホスト間でファイルを送受信する際、ファイルの文字コードが転送先のJP1/AJS3サービスの文字コードに変換されます。そのため、それぞれの文字コードを一致させる必要があります。
    *   **ネットワークドライブの指定**: ジョブのバッチファイルなどでネットワークドライブに接続する場合、ネットワークドライブ名から始まるパスではなく、「\\コンピュータ名\共有フォルダ\ファイル名」のようにコンピュータ名から始まるパスを指定してください。
    *   **ユーザー環境変数**: JP1/AJS3サービスの起動アカウントをシステムアカウントからユーザーアカウントに変更すると、ジョブ実行時に起動アカウントのユーザー環境変数が有効になります。これにより、デスクトップヒープ領域の不足を防ぐ運用も可能です。

#### 2.5 ユーザー管理とアクセス制御

JP1/AJS3では、JP1/Baseのユーザー認証機能とユーザーマッピング機能を使ってユーザーのログイン認証や操作権限を管理します。

*   **JP1ユーザーの登録**: JP1/AJS3やJP1シリーズプログラムを使用するユーザーを「JP1ユーザー」と呼び、認証サーバー（JP1/Baseがインストールされたホスト）に登録します。
*   **アクセス権限の設定**: JP1/AJS3のユニットに対する操作権限を「アクセス権限」と呼びます。
    *   **JP1資源グループ (JP1 Resource Group)**: ユニットをグループ分けして管理するための任意の名称です。ユニットにJP1資源グループを設定することで、アクセス制御の対象になります。
    *   **JP1権限レベル (JP1 Privilege Level)**: JP1資源グループに対して設定される、どのような操作ができるかを表す権限です。
        *   **JP1_AJS_Admin**: 管理者権限。ユニットの所有者や資源グループの操作権限、ジョブネットの定義・実行・編集権限など。
        *   **JP1_AJS_Manager**: ジョブネットの定義・実行・編集権限など。
    *   **実行ユーザー種別 (Execution User Type)**: ジョブネットを実行した際に、配下のジョブを実行するJP1ユーザーの種類を選択します。
        *   **登録ユーザー**: ジョブネットを実行登録したJP1ユーザーがジョブを実行します。
        *   **所有ユーザー**: ジョブの所有者に設定されているJP1ユーザーがジョブを実行します。
        *   ORジョブ、判定ジョブ、イベントジョブはJP1/AJS3を起動しているユーザーの権限で実行されるため、実行ユーザー種別は指定できません。
    *   **ユーザーマッピング (User Mapping)**: ジョブやコマンドを実行する際に、実行元ホストのJP1ユーザーと実行先ホストのOSに登録されているOSユーザーを対応づける機能です。
    *   **上位ユニット属性継承機能**: 新規作成またはコピーしたユニットの所有者およびJP1資源グループが、その一つ上の階層のユニットの設定を継承する機能です。
    *   **AJS管理者 (AJS Administrator)**: JP1/AJS3のシステム管理作業（サービス起動/停止、バックアップ、DBメンテナンスなど）を、スーパーユーザー権限を持つユーザーと分担して実施できるユーザーです。インストールやパッチ適用など、一部の操作はスーパーユーザー権限が必要です。

#### 2.6 稼働状況の監視 (Monitoring)

JP1/AJS3では、自動化した業務が正常に運用されているかを確認するため、ジョブネットの実行結果や実行時間を監視します。

*   **JP1/AJS3 - Viewでの監視画面**:
    *   **ステータス監視 (Status Monitoring)**: 実行中のジョブネットの状態、実行結果、詳細情報を確認できます。
    *   **サマリー監視 (Summary Monitoring)**: 監視対象日に実行予定のユニット数、終了したユニット数、進捗度などを確認でき、業務の終了日時を予測することも可能です。
    *   **デイリースケジュール (Daily Schedule)**: 1日ごとのジョブネットやジョブの実行予定、実行状態、実行結果を日単位で確認できます。階層表示と全ジョブ表示があります.
    *   **マンスリースケジュール (Monthly Schedule)**: ジョブネットの実行状態を月単位で監視できます.
    *   **ジョブネットモニタ (Jobnet Monitor)**: ジョブネットやジョブの実行状況、実行の詳細結果を表示・操作するウィンドウです. マップエリアでユニットのアイコンの色と実行状態の関係を確認できます（例: 実行中: 緑、正常終了: 薄い緑、異常終了: 赤、保留中: 黄、先行終了待ち: 水色）.
*   **遅延監視 (Delay Monitoring)**:
    ジョブネットの開始または終了の遅延を監視できます。
    *   **開始遅延監視**: ジョブネットが予定時刻からある時間以内に開始されない場合に異常と見なします。
    *   **終了遅延監視**: ジョブネットが予定時刻からある時間以内に終了しない場合に異常と見なします。

#### 2.7 実行登録後の操作

運用中のジョブネットやジョブの設定変更や制御が可能です。

*   **サスペンド (Suspend)**:
    *   実行登録中のルートジョブネットおよびその下位ユニットの実行を抑止する機能です。
    *   実行中のジョブネットの定義を変更する場合に、一時的に運用を停止するために使用されます。
    *   サスペンド解除により、変更後の定義で運用を再開できます。
*   **強制終了 (Forced Termination)**:
    実行中のジョブネットやジョブの実行を強制的に終了させます。
*   **再実行 (Re-execution)**:
    中断したり、強制終了したりしたジョブネットやジョブを再実行します。
*   **計画一時変更 (Temporary Schedule Change)**:
    実行登録したユニットの実行開始予定日時を一時的に変更したり、即時実行したり、実行を中止したりできます。
*   **リリース登録 (Release Registration)**:
    ジョブネットの定義内容の変更を、運用中に切り替える機能です。あらかじめ変更を加えたジョブネットを定義しておき、ある時点から新しい定義に運用を切り替えたい場合などに使用します。

### 3. 実務でよく使われる処理内容と設定例

JP1/AJS3は、日次・月次などの定型業務だけでなく、先行処理の結果次第で動的に処理が変わる業務、特定の事象発生を契機とする変則的な業務など、様々な自動化に対応しています。

*   **売上集計・データベース更新**:
    *   「毎日終業時に支店内の売り上げ合計を算出し、夜間に全支店の売り上げ合計を本社で集計する。集計が終了したらデータベースを更新する。集計処理に失敗したときにはデータベースを更新しないようにする。」といった業務を自動化できます。
    *   **設定例**: ジョブネットで売上集計ジョブ、データベース更新ジョブを順次実行し、集計ジョブの終了コード判定で成功時のみデータベース更新、失敗時はリカバリージョブを実行する。
*   **定期的な帳票作成と休日振り替え**:
    *   「毎月5・10・15・20・25日に自動的に出納票を作成し、出力する。該当する日が休業日の場合は、翌日に振り替えて処理を実行する。」といった経理業務を自動化できます。
    *   **設定例**: カレンダー定義で土日祝日を休業日と設定し、ジョブネットのスケジュール定義で「毎月特定日実行」と「休業日振り替え（翌日）」を設定します。
*   **受注伝票自動作成・データベース更新**:
    *   「日中は、オペレーターが受注品目や受注金額を入力したときだけ自動的にデータベースを更新し、受注伝票を出力する。夜間に、日中入力された情報を、受注伝票の項目ごとに作成された分野別データベースに登録する。」といった業務を自動化できます。
    *   **設定例**: オペレーターの入力によるファイル作成イベントをトリガーとするイベントジョブを設定し、データベース更新ジョブと受注伝票出力ジョブを実行するジョブネットを定義します。夜間バッチ処理は、時間指定のスケジュールジョブネットで実行します。
*   **ディザスター・リカバリー (Disaster Recovery)**:
    *   大規模災害などによってシステムが停止した場合などの不測の事態に備え、業務中断を防ぎ、システム可用性を高める機能です。
    *   **仕組み**: 通常時、メインサイトのJP1/AJS3情報を共有ディスクに格納し、その情報を遠隔地のリモートサイトの共有ディスクにコピーします。この共有ディスク間のコピーは、ハードウェアのディスクコピー・ミラーリング機能を使用し、JP1/AJS3の機能ではありません。
    *   **災害発生時**: メインサイト停止後、リモートサイトのJP1/AJS3サービスの起動抑止状態が解除され、運用を切り替えて業務を再開します。
    *   **システム構成**: マネージャーホスト、エージェントホスト、JP1/Base、クラスタソフト、共有ディスクを組み合わせた構成例が示されています。エージェントホストをメインサイトとリモートサイトで分ける場合と共有する場合があります.
    *   **切り替え手順**: ハードウェア操作による共有ディスク間のコピー停止、リモートサイトをメインサイトとして運用するための論理ホスト設定、JP1/AJS3 - Managerの起動（ジョブ実行抑止状態）、必要な作業の実施、ジョブ実行抑止解除、業務再開といった流れで運用を切り替えます。
*   **他のJP1製品との連携**:
    *   JP1/AJS3は、JP1/IM（統合管理）などの他プログラムと連携し、他プログラムが実行する処理をJP1/AJS3の処理の一部として定義できます。これにより、JP1/AJS3の柔軟なスケジュール機能や統合的な監視機能を活用しながら、他プログラムの処理を実行できます。
    *   **設定例**: JP1イベント送信ジョブでJP1イベントを発行し、JP1/IMでそのイベントを監視して自動アクション（例: メール通知）を実行する。
*   **仮想マシン複製時の考慮**:
    *   JP1/AJS3のインストール・セットアップ後に仮想マシンを複製する場合、ホスト名の正しい設定や、複製元の仮想マシンでJP1/AJS3サービスをコールドスタートで終了させるなどの対処が必要です。これにより、サービス起動時のエラーや、エージェントプロセスが記憶するマネージャーホスト名の不整合などを回避できます。

### 4. ジョブ実行環境と関連する考慮事項

JP1/AJS3は、ジョブ実行時に複数の環境要因を考慮して動作します。

*   **ウイルス対策ソフトの影響**:
    *   ウイルス対策ソフトがJP1/AJS3が使用するファイルやフォルダに排他制御ロックをかけることで、JP1/AJS3の起動失敗、ジョブの実行失敗や遅延、スケジュール生成の失敗、定義変更不可、ログ出力不可、コマンド異常終了などの問題が発生する可能性があります。
    *   **対策**: ウイルス対策ソフトの除外設定などで影響を回避する必要があります（ソースには具体的な設定方法は記載されていませんが、一般的なベストプラクティスとして行われます）。
*   **ISAMデータベースのメンテナンス**:
    *   JP1/AJS3は組み込みDBを使用しており、そのデータベースのメンテナンスが必要です。
    *   **ISAMファイル自動再編成機能**: クラスタシステム運用時、フェールオーバー時にデータ部と索引部が不整合になった場合、ISAMデータベースの再編成が必要になることがあります。この機能を有効にすることで、JP1/AJS3起動時に自動的に回復するように設定できます。ただし、ジョブ情報保存数が多いと再編成時間が長くなるため、クラスタソフトの起動タイムアウト時間の調整や、ISAMファイルが肥大化しない設定（ジョブ情報保存日数の調整など）を検討する必要があります。
*   **キューレスジョブ (Queueless Job)**:
    *   ジョブをキューへ直接登録して実行依頼する形態のジョブです。
    *   JP1/AJS3では、UNIXジョブ、PCジョブ、フレキシブルジョブ、HTTP接続ジョブ、イベントジョブ、アクションジョブ、カスタムジョブで実行先サービスに「キューレス」を指定できます。
    *   **ログファイルのサイズ見積もり**: キューレスジョブに関するログファイル（キューレスログ、キューレストレースログ、キューレスジョブ実行内部ログ）のサイズを適切に見積もる必要があります。これは障害発生時の原因調査に不可欠です。



---

