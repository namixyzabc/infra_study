

基本原則は**「自分に近いところから、徐々に遠いところへ」**と確認範囲を広げていくことです。これにより、問題の切り分けが効率的に行えます。

---

### 疎通確認の推奨手順

以下の順序で確認を進めることを推奨します。

| 順序 | 確認対象 | 使用コマンド例 | 目的・意味 |
| :--- | :--- | :--- | :--- |
| **Step 0** | **自分自身の状態確認** | `ip addr` / `ifconfig` | ネットワークインターフェースが有効か、IPアドレスが割り当てられているかを確認する。 |
| **Step 1** | **自分自身のネットワークスタック** | `ping localhost` / `ping 127.0.0.1` | TCP/IPプロトコルスタックが正常に動作しているかを確認する。 |
| **Step 2** | **デフォルトゲートウェイ** | `ip route` でGWを確認後、`ping <GWのIP>` | LAN内のルーター（ゲートウェイ）まで到達できるかを確認する。 |
| **Step 3** | **外部のIPアドレス（DNSを経由しない）** | `ping 8.8.8.8` | ルーターを越えてインターネット上のサーバーまで到達できるかを確認する。（DNSの問題を切り分ける） |
| **Step 4** | **名前解決（DNS）** | `nslookup google.com` / `dig google.com` | ドメイン名からIPアドレスを正しく引けるか（名前解決）を確認する。 |
| **Step 5** | **外部のホスト名（DNSを経由する）** | `ping google.com` | 名前解決を含めた、インターネット全体への基本的な接続を確認する。 |
| **Step 6** | **特定ポートへの接続** | `curl`, `telnet`, `nc` | Webサーバーなど、特定のアプリケーション（ポート）への接続を確認する。 |

---

### 各ステップの詳細解説

#### Step 0: 自分自身の状態確認
まず、自分のマシンがネットワークに接続する準備ができているかを確認します。

*   **コマンド:**
    ```bash
    ip addr show
    # または古い環境の場合
    # ifconfig
    ```
*   **確認すること:**
    *   利用したいネットワークインターフェース（例: `eth0`, `enp0s3`）が `UP` 状態になっているか。
    *   `inet` の行に、想定したIPアドレスとサブネットマスクが割り当てられているか。
*   **失敗した場合:**
    *   物理的な接続（LANケーブルが抜けている、Wi-Fiが無効など）を確認します。
    *   `sudo ip link set <interface> up` でインターフェースを有効化します。
    *   DHCPクライアントや静的IP設定を見直します。

#### Step 1: 自分自身のネットワークスタックの確認 (ループバック)
自分のマシン内で通信が完結するかを確認します。これにより、OSのネットワーク機能が正常に動いているかを判断します。

*   **コマンド:**
    ```bash
    ping localhost
    # または
    # ping 127.0.0.1
    ```
*   **確認すること:**
    *   即座に応答が返ってくること。
*   **失敗した場合:**
    *   OSのネットワーク設定や、ローカルのファイアウォール設定（`iptables`, `firewalld`など）に重大な問題がある可能性が高いです。

#### Step 2: デフォルトゲートウェイへの疎通確認
LANからインターネットへ出るための出口である「デフォルトゲートウェイ」（通常はルーター）まで通信できるかを確認します。

1.  **ゲートウェイのIPアドレスを調べる:**
    ```bash
    ip route show
    # 出力例: default via 192.168.1.1 dev eth0
    # この場合、ゲートウェイは 192.168.1.1 です。
    ```
2.  **ゲートウェイへpingを打つ:**
    ```bash
    ping 192.168.1.1
    ```
*   **確認すること:**
    *   ゲートウェイから応答が返ってくること。
*   **失敗した場合:**
    *   自分のマシンのIPアドレスやサブネットマスクの設定が間違っている可能性があります。
    *   ルーターとの物理的な接続（LANケーブル、スイッチングハブなど）に問題がある可能性があります。
    *   ルーター自体がフリーズしている可能性も考えられます。

#### Step 3: 外部IPアドレスへの疎通確認
DNS（名前解決）を介さずに、インターネット上のサーバーと直接通信できるかを確認します。これにより、純粋なインターネット接続能力をテストします。

*   **コマンド:**
    ```bash
    # GoogleのパブリックDNSサーバー（覚えやすい）
    ping 8.8.8.8
    ```
*   **確認すること:**
    *   `8.8.8.8` から応答が返ってくること。
*   **失敗した場合:**
    *   ルーターの設定（特にNATやファイアウォール）に問題がある可能性があります。
    *   契約しているインターネット回線（ISP）側で障害が発生している可能性があります。

#### Step 4: 名前解決（DNS）の確認
ドメイン名（例: `google.com`）をIPアドレスに変換する「名前解決」が機能しているかを確認します。

*   **コマンド:**
    ```bash
    # nslookupやhostでも可
    dig google.com
    ```
*   **確認すること:**
    *   `ANSWER SECTION` に `google.com` に対応するIPアドレスが表示されること。
*   **失敗した場合:**
    *   `/etc/resolv.conf` ファイルに設定されているDNSサーバーのIPアドレスが正しいか確認します。
    *   そのDNSサーバーへ `ping` が通るか確認します（例: `ping <DNSサーバーのIP>`）。
    *   DNSサーバー自体がダウンしているか、ファイアウォールでDNSの通信（UDP/53）がブロックされている可能性があります。

#### Step 5: 外部ホスト名への疎通確認
名前解決とインターネット接続を組み合わせた、総合的な疎通確認です。

*   **コマンド:**
    ```bash
    ping google.com
    ```
*   **確認すること:**
    *   `ping` が開始され、応答が返ってくること。
*   **失敗した場合:**
    *   **Step 3が成功していてこれが失敗する場合** → ほぼDNSの問題です（Step 4に戻る）。
    *   **Step 3から失敗している場合** → ゲートウェイより先のネットワークの問題です。

#### Step 6: 特定ポートへの接続確認
`ping` (ICMPプロトコル)は通るが、Webサイトが見えない（HTTP/HTTPS）といった場合に、特定のサービス（ポート）が待ち受けているかを確認します。

*   **コマンド例:**
    *   **curl:** HTTP/HTTPSの疎通確認に最適。ヘッダー情報も見れます。
        ```bash
        # -v オプションで詳細な通信過程を表示
        curl -v google.com
        ```
    *   **telnet:** 古典的ですが、指定したホストのTCPポートが開いているか簡単に確認できます。
        ```bash
        # google.com のWebサーバー(80番ポート)に接続試行
        telnet google.com 80
        # "Connected to..." と表示されればOK
        ```
    *   **nc (netcat):** `telnet`より高機能なツール。ポートスキャンにも使えます。
        ```bash
        # -z: データ送信なしで接続試行のみ, -v: 詳細表示
        nc -zv google.com 443
        # "succeeded!" と表示されればOK
        ```
*   **確認すること:**
    *   `Connection refused`（接続拒否） → サーバー側でサービスが動いていないか、ポートが開いていない。
    *   タイムアウト → サーバーまでの経路、またはサーバー自身のファイアウォールでそのポートがブロックされている。
*   **失敗した場合:**
    *   相手先のサーバーでサービスが起動しているか確認します。
    *   自分、相手、または経路上にあるファイアウォールの設定を確認します。

---

### 問題の切り分けに役立つ追加コマンド

*   **traceroute / mtr**
    目的のホストまでのネットワーク経路をリストアップし、どこで通信が途絶えているか（遅延しているか）を特定するのに役立ちます。

    ```bash
    traceroute google.com

    # mtr は traceroute と ping を組み合わせたようなツールで、継続的に経路の品質を監視できる
    mtr google.com
    ```

