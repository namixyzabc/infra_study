**1\. マルチステージビルドの概念**

従来のコンテナイメージ構築では、ビルドに必要なツールやライブラリを含んだイメージをベースに、アプリケーションのコードを追加して最終的なイメージを作成していました。しかし、この方法では、最終的なイメージにビルドツールが残ってしまうため、イメージサイズが大きくなり、セキュリティリスクも高まる可能性がありました。

マルチステージビルドでは、**複数のステージでイメージを構築することで、最終的なイメージに必要なものだけを含める**ことができます。

**2\. マニフェストによる記述例**

以下は、Go言語で書かれたアプリケーションをビルドするDockerfileの例です。マルチステージビルドを用いて、ビルドステージと最終ステージに分けてイメージを構築しています。

\# ビルドステージ  
FROM golang:1.19 AS builder

WORKDIR /app  
COPY go.mod go.sum ./  
RUN go mod download

COPY . .  
RUN CGO\_ENABLED=0 GOOS=linux go build \-a \-installsuffix cgo \-o main .

\# 最終ステージ  
FROM alpine:latest

RUN apk \--no-cache add ca-certificates

WORKDIR /app  
COPY \--from=builder /app/main .

CMD \["./main"\]

**3\. マニフェストの詳細解説**

* **ステージ1: ビルドステージ（builder）**

  * `golang:1.19`イメージをベースイメージとして使用します。  
  * アプリケーションのソースコードをイメージにコピーします。  
  * Goモジュールをダウンロードし、アプリケーションをビルドします。  
* **ステージ2: 最終ステージ**

  * `alpine:latest`イメージをベースイメージとして使用します。Alpine Linuxは軽量でセキュリティに優れているため、最終的なイメージサイズを小さくすることができます。  
  * ビルドステージで作成された実行ファイルを最終ステージのイメージにコピーします。  
  * コンテナ起動時に実行するコマンドを指定します。

**4\. マルチステージビルドのメリット**

* **イメージサイズの縮小:** ビルドツールや中間ファイルを最終的なイメージに含める必要がないため、イメージサイズを大幅に縮小できます。  
* **セキュリティの向上:** 不要なツールやライブラリをイメージから削除することで、攻撃対象を減らし、セキュリティを向上させることができます。  
* **ビルド速度の向上:** ステージごとにキャッシュを利用できるため、ビルド速度を向上させることができます。

**5\. まとめ**

マルチステージビルドは、Kubernetesにおけるコンテナイメージ構築のベストプラクティスです。イメージサイズを縮小し、セキュリティを向上させ、ビルド速度を向上させることができます。

Kubernetesの公式ドキュメントや、Dockerのマルチステージビルドに関する資料も参考に、ぜひ活用してみてください。
