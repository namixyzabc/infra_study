## 「POODLE攻撃」 解説

### 第1章 POODLE攻撃とは？

#### 1.1 概要と影響

POODLE攻撃（Padding Oracle On Downgraded Legacy Encryption）は、2014年にGoogleの研究者によって発表された、SSL/TLSの古いバージョンであるSSL 3.0に存在する脆弱性を悪用する攻撃手法です。 この攻撃が成功すると、暗号化されているはずの通信内容の一部、特にWebサイトのログイン状態を維持するためのCookie情報などが解読される可能性があります。

攻撃者は、盗み出したCookieを利用して、被害者になりすましてサービスにログインする「セッションハイジャック」を行うことができます。 この攻撃は、攻撃者が被害者と同じネットワーク（例：公衆無線LANなど）にいるなど、通信に割り込める「中間者攻撃（Man-in-the-Middle Attack）」が可能な状況で実行されます。

#### 1.2 名前の由来

「POODLE」という名前は、"**P**adding **O**racle **O**n **D**owngraded **L**egacy **E**ncryption" の頭文字を取ったものです。

*   **Padding Oracle（パディングオラクル）**: 暗号化されたデータのパディング（詰め物）が正しいかどうかという情報（Oracle：神託）を手がかりに、暗号を解読する手法です。
*   **Downgraded Legacy Encryption（ダウングレードされたレガシー暗号）**: 通信プロトコルを、より安全な新しいバージョン（TLS 1.2など）から、意図的に脆弱な古いバージョン（Legacy Encryption）、すなわちSSL 3.0に格下げ（Downgrade）させることを指します。

つまり、POODLE攻撃とは、「**通信を意図的に古いSSL 3.0にダウングレードさせ、その上でパディングオラクルという手法を用いて暗号を解読する攻撃**」ということになります。

#### 1.3 攻撃の対象

POODLE攻撃の主な標的は、SSL 3.0プロトコルです。 SSL 3.0は1996年に登場した古いプロトコルで、多くの脆弱性が発見されたため、2015年6月にはRFC 7568によって使用が禁止（非推奨化）されました。

しかし、発表当時は、古いブラウザやサーバーとの互換性を維持するために、多くのWebサーバーがSSL 3.0を有効にしたまま運用していました。 POODLE攻撃は、この互換性のための設定を逆手に取ります。

### 第2章 POODLE攻撃を理解するための技術的背景

POODLE攻撃の仕組みを深く理解するために、いくつかの重要な技術要素について解説します。

#### 2.1 SSL/TLSと暗号化通信の仕組み

SSL/TLSは、インターネット上でデータを安全に送受信するためのプロトコル（通信規約）です。 WebサイトのURLが `https://` で始まる場合、このSSL/TLSによって通信が暗号化されています。通信は主に以下の要素で保護されます。

1.  **ハンドシェイク**: 通信開始時に、クライアント（ブラウザ）とサーバーが互いに使用する暗号化方式やプロトコルのバージョン（TLS 1.2, SSL 3.0など）を取り決めるプロセスです。
2.  **共通鍵暗号**: ハンドシェイクで合意した「共通鍵」を使って、実際のデータを暗号化・復号します。この方式は高速ですが、事前に鍵を安全に共有する必要があります。
3.  **メッセージ認証コード (MAC)**: データが改ざんされていないかを検証するための値です。送信者はデータと共通鍵からMACを生成し、受信者は受け取ったデータから再度MACを計算して一致するかを確認します。

#### 2.2 ブロック暗号とCBCモード

共通鍵暗号の一種に「ブロック暗号」があります。これは、データを固定長のブロック（かたまり）に分割して、ブロック単位で暗号化処理を行うものです。

CBC（Cipher Block Chaining）モードは、ブロック暗号の利用モードの一つです。 その特徴は、**前のブロックの暗号文を、次のブロックの平文（暗号化前のデータ）とXOR（排他的論理和）演算してから暗号化する**点にあります。これにより、同じ平文ブロックが続いても、異なる暗号文が生成され、安全性が高まります。

*   **暗号化**: `C_i = Enc(P_i XOR C_{i-1})`
*   **復号**: `P_i = Dec(C_i) XOR C_{i-1}`
    *   `P_i`: i番目の平文ブロック
    *   `C_i`: i番目の暗号文ブロック
    *   `C_0`: 初期化ベクトル(IV)というランダムな値
    *   `Enc`: 暗号化処理, `Dec`: 復号処理

この「連鎖」の仕組みが、POODLE攻撃の鍵となります。

#### 2.3 パディング (Padding)

ブロック暗号は固定長のデータを扱うため、最後の平文ブロックがブロック長に満たない場合、足りない部分を特定のデータで埋める必要があります。この処理または埋められるデータを「パディング」と呼びます。

例えば、ブロック長が8バイトで、最後のデータが3バイトしかない場合、残りの5バイトをパディングで埋めます。PKCS#7という一般的なパディング方式では、埋めるバイト数と同じ値でパディングします。この例では、5バイトなので「0x05」という値を5つ続けます。

`[データ(3バイト)] [0x05] [0x05] [0x05] [0x05] [0x05]`

受信側（サーバー）は、データを復号した後、このパディングルールに従ってパディングを取り除きます。もしパディングの形式が正しくなければ、「パディングエラー」として処理を中断します。

#### 2.4 パディングオラクル攻撃の基本原理

パディングオラクル攻撃は、サーバーが「パディングが正しいか、間違っているか」という2種類のエラー応答を返すこと（これが「神託(Oracle)」の役割を果たす）を利用して、暗号文を1バイトずつ解読する手法です。

攻撃者は暗号文の一部を改ざんしてサーバーに送り、その応答を観察します。

*   **応答A（パディングエラーなど）**: 「改ざんした結果、パディングが不正になった」
*   **応答B（エラーなし、または別の種類のエラー）**: 「改ざんした結果、たまたま正しいパディング形式になった」

攻撃者は、応答Bが得られるまで暗号文の改ざんを繰り返します。応答Bが得られたということは、改ざん後の復号結果の末尾が、有効なパディング形式（例: `... 0x01` や `... 0x02 0x02`）になったことを意味します。この情報から、CBCモードの数式を利用して、元の平文を1バイトずつ特定できるのです。

### 第3章 POODLE攻撃の具体的な仕組み

POODLE攻撃は、大きく分けて2つのフェーズで実行されます。

#### フェーズ1: ダウングレード攻撃

1.  **中間者攻撃 (MitM)**: 攻撃者は、公衆無線LANなどを利用して、標的となるユーザー（クライアント）とWebサーバーの間の通信に割り込みます。
2.  **接続妨害**: クライアントがサーバーに対して、安全なTLS 1.2などの新しいプロトコルで接続しようとすると、攻撃者はこの接続要求を妨害し、意図的に失敗させます。
3.  **プロトコルのダウングレード**: 多くのブラウザは、上位のプロトコルでの接続に失敗すると、互換性のために自動的に下位のプロトコルで再接続を試みる「フォールバック機能」を持っています。 攻撃者はこの接続失敗を繰り返させ、クライアントが最終的に脆弱なSSL 3.0で接続するように仕向けます。

この段階で、クライアントとサーバー間の通信は、攻撃者が解読可能な土俵であるSSL 3.0上で行われることになります。

#### フェーズ2: SSL 3.0に対するパディングオラクル攻撃

SSL 3.0のCBCモード実装には、パディングオラクル攻撃を容易にする決定的な欠陥がありました。それは、**パディングのバイト値が何であるべきかを規定していなかった**点です。そのため、サーバーはパディング長さえ正しければ、パディングの中身の値が何であっても受け入れてしまう場合がありました。

攻撃者はこの欠陥を利用して、Cookie情報などを1バイトずつ盗み出します。以下に、暗号化されたCookieの1バイトを解読する手順を示します。

**前提:**
*   盗みたい情報（平文）を含むHTTPリクエストが暗号化されている。
*   攻撃者はこの暗号化されたデータ（暗号文ブロックの連続 `C_1, C_2, ..., C_n`）を傍受・改ざんできる。
*   ブロック長は8バイトとする。

**手順:**

1.  **標的の選定**: 攻撃者は、解読したい平文1バイトが含まれる暗号文ブロック `C_i` と、その一つ前の暗号文ブロック `C_{i-1}` に注目します。
2.  **ブロックの入れ替え**: 攻撃者は、リクエストの最後の暗号文ブロック `C_n` を、先ほど選んだ `C_i` で置き換えます。これにより、サーバーが復号を試みる最後のブロックが、攻撃者の選んだ `C_i` となります。
3.  **中間値の推測**: CBCモードの復号プロセス (`P_i = Dec(C_i) XOR C_{i-1}`) において、`Dec(C_i)` の結果を中間値 `I_i` とします。つまり `P_i = I_i XOR C_{i-1}` です。攻撃者が知りたいのは平文 `P_i` です。この式を変形すると `P_i XOR I_i = C_{i-1}` となります。攻撃者は `C_{i-1}` は知っていますが、`I_i` と `P_i` は知りません。
4.  **オラクルの利用**: 攻撃者は、改ざんした `C_{i-1}`（これを `C'_{i-1}` とする）を作成し、サーバーに送信します。サーバーはこれを `P'_i = I_i XOR C'_{i-1}` として復号します。攻撃者は、この復号結果 `P'_i` の末尾のパディングが正しくなるように `C'_{i-1}` を調整します。
    SSL 3.0では、パディングの検証はパディング長バイトのみをチェックします。末尾1バイトのパディングが正しいと判定される（パディング長が1で、その値が0x00）状態を狙います。
5.  **バイトの特定**: 攻撃者は、`C'_{i-1}` の末尾バイトを0から255まで順番に試します（総当たり）。サーバーからパディングエラーが返ってこなかった試行が成功です。
    このとき、復号結果の末尾バイト `P'_i[7]` は `0x00` になったはずです。数式 `P'_i[7] = I_i[7] XOR C'_{i-1}[7]` が `0x00` なので、`I_i[7] = C'_{i-1}[7]` であることがわかります。
    これで中間値 `I_i` の末尾バイトが特定できました。
6.  **平文の計算**: 最後に、元の数式 `P_i[7] = I_i[7] XOR C_{i-1}[7]` に、今特定した `I_i[7]` と、傍受済みの `C_{i-1}[7]` を代入することで、目的の平文1バイト `P_i[7]` が計算できます。
7.  **繰り返しの実行**: このプロセスを繰り返すことで、暗号文を1バイトずつ順番に解読していきます。1バイトを特定するのに最大256回の試行で済み、例えば16バイトのCookieであれば、平均して約4096回のリクエスト（数分程度）で全体を解読できる可能性があります。

### 第4章 POODLE攻撃の亜種

#### TLSを対象としたPOODLE攻撃 (CVE-2014-8730)

当初、POODLE攻撃はSSL 3.0特有の問題とされていました。しかし、2014年12月に、一部のTLS 1.x実装においても同様の脆弱性が存在することが報告されました (CVE-2014-8730)。

これは、TLSの仕様ではパディングの値を厳密にチェックすることが求められているにもかかわらず、一部のベンダー製品の実装がそのチェックを怠っていたために発生しました。 その結果、サーバーがSSL 3.0を無効にしていても、実装の不備があればTLS通信に対してPOODLE攻撃が成功する可能性がありました。 この亜種は「POODLE Bites」と呼ばれることもあります。

この事実は、プロトコルの仕様が安全であっても、その実装が正しくなければ脆弱性が生まれるという重要な教訓を示しています。

### 第5章 具体的な対処手順

POODLE攻撃への対策は、サーバー側とクライアント側の両方で行う必要があります。

#### 5.1 サーバー管理者向けの対策

Webサイトやサービスの運用者が行うべき対策は以下の通りです。

##### **対策1: SSL 3.0の無効化（最善策）**

最も根本的で効果的な対策は、サーバー設定でSSL 3.0を完全に無効化することです。 これにより、POODLE攻撃の前提となるダウングレード攻撃そのものを防ぎます。

**具体的な設定例:**

*   **Apache httpd:**
    `httpd.conf` や `ssl.conf` などの設定ファイルで、`SSLProtocol` ディレクティブを修正します。SSLv3を明示的に除外します。
    ```apache
    # 修正前 (例)
    # SSLProtocol all -SSLv2

    # 修正後
    SSLProtocol all -SSLv2 -SSLv3
    # または、より安全なプロトコルのみを許可
    # SSLProtocol TLSv1.2 TLSv1.3
    ```

*   **Nginx:**
    `nginx.conf` 内の `server` ブロックで `ssl_protocols` ディレクティブを修正します。
    ```nginx
    # 修正前 (例)
    # ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;

    # 修正後 (安全なプロトコルのみを指定)
    ssl_protocols TLSv1.2 TLSv1.3;
    ```

設定変更後は、必ずWebサーバーを再起動して設定を反映させる必要があります。

##### **対策2: TLS_FALLBACK_SCSVのサポート（次善の策）**

TLS_FALLBACK_SCSVは、ダウングレード攻撃を防ぐための仕組みです。 これは、クライアントが上位プロトコルでの接続に失敗し、下位プロトコルで再接続を試みる際に、その事実をサーバーに伝えるための特殊な信号（Cipher Suite Value）です。

サーバーがこの信号を受け取ると、「クライアントはもっと新しいプロトコルをサポートしているはずなのに、なぜ古いプロトコルで接続してきたのか？」を検知できます。サーバーがクライアントがサポートするバージョンより上位のプロトコルに対応している場合、その接続を意図的なダウングレード攻撃と判断し、接続を拒否します。

この機能は、やむを得ない理由でSSL 3.0を無効にできないレガシーシステムを保護するための一時的な対策として推奨されました。 主要なブラウザやOpenSSLライブラリは早期にこの機能に対応しました。

##### **設定の確認方法**

サーバーがSSL 3.0を無効化できているかを確認するには、`openssl` コマンドラインツールや、オンラインのSSL/TLS診断サイトが利用できます。

*   **opensslコマンドでの確認:**
    以下のコマンドを実行し、`sslv3 alert handshake failure` といったエラーが表示されれば、SSL 3.0が無効になっていることを示します。
    ```bash
    openssl s_client -connect your-server.com:443 -ssl3
    ```

*   **オンライン診断ツール:**
    Qualys SSL Labsの「SSL Server Test」などが有名で、ウェブサイトのURLを入力するだけで、サポートしているプロトコルバージョンや脆弱性の有無を詳細に診断してくれます。

#### 5.2 クライアント（ブラウザ利用者）向けの対策

一般のインターネット利用者側で必要な対策は以下の通りです。

*   **ブラウザのアップデート:**
    主要なブラウザ（Google Chrome, Mozilla Firefox, Microsoft Edge, Safariなど）は、POODLE脆弱性が公表された後、速やかにアップデートでSSL 3.0をデフォルトで無効化しました。 常にブラウザを最新のバージョンに保つことが、最も簡単で重要な対策です。

*   **古いOSやブラウザの使用中止:**
    Internet Explorer 6のように、TLS 1.1以降をサポートしない非常に古いブラウザやOSを使い続けることは、POODLE攻撃だけでなく、他の多くのセキュリティリスクにも晒されるため、危険です。

現在では、主要なブラウザはすべて対策済みのため、利用者がPOODLE攻撃を意識して特別な設定を行う必要はほとんどありません。

### 第6章 近年の傾向とまとめ

#### 6.1 POODLE攻撃の現状

2014年の発表から年月が経ち、インターネット全体でSSL 3.0からTLSへの移行が進んだ結果、POODLE攻撃が直接的な脅威となる場面は大幅に減少しました。主要なWebサイトや最新のブラウザ環境において、この攻撃を心配する必要はほぼありません。

しかし、脅威が完全になくなったわけではありません。

*   **レガシーシステム:** 企業内の古いシステムや、更新が止まっている組み込み機器、IoTデバイスなどでは、互換性のために未だにSSL 3.0が使われているケースがあります。 2020年時点でも、公開ウェブサーバーの約4%がSSL 3.0をサポートしていたという調査結果もあります。
*   **脆弱なTLS実装:** POODLEの亜種が示したように、TLSの実装に不備があれば同様の攻撃を受ける可能性があります。

#### 6.2 POODLE攻撃が残した教訓

POODLE攻撃は、現代のサイバーセキュリティにいくつかの重要な教訓を残しました。

1.  **古い暗号プロトコルは使わない:** 脆弱性が発見された古いプロトコルを互換性のためだけに使い続けることは、重大なリスクとなります。速やかに安全な後継プロトコルへ移行することが不可欠です。
2.  **ダウングレード攻撃への対策:** プロトコルのフォールバック機能は利便性をもたらす一方で、攻撃に悪用される危険性をはらんでいます。TLS_FALLBACK_SCSVのような、ダウングレードを検知・防止する仕組みの重要性が示されました。
3.  **プロトコルと実装の両輪の重要性:** 安全なプロトコル仕様があっても、それを正しく実装しなければ意味がありません。開発者は仕様を遵守し、実装の不備をなくす必要があります。

#### 6.3 まとめ

POODLE攻撃は、SSL 3.0というレガシープロトコルの「寿命」を決定づけ、インターネット全体のセキュリティレベルを向上させるきっかけとなった重要な脆弱性でした。その仕組みは、ダウングレード攻撃とパディングオラクル攻撃を組み合わせた巧妙なもので、暗号通信の安全性がプロトコルの設計だけでなく、その運用や実装にも大きく依存することを示しています。

現代において、直接POODLE攻撃の被害に遭う可能性は低いですが、この攻撃から得られた教訓は、今後も安全なシステムを構築・維持していく上で普遍的な指針となります。常にソフトウェアを最新の状態に保ち、安全性が確認された暗号プロトコル（現在はTLS 1.2およびTLS 1.3）を利用することが、今も変わらず最も重要なセキュリティ対策です。
