## SSL/TLSダウングレード攻撃解説

### 1. SSL/TLSダウングレード攻撃とは？

SSL/TLSダウングレード攻撃とは、クライアントとサーバー間の暗号化通信を意図的に古く脆弱なバージョンや暗号方式に「格下げ（ダウングレード）」させ、その脆弱性を突いて通信を盗聴、改ざんするサイバー攻撃の一種です。

通常、SSL/TLS通信を開始する際、クライアント（Webブラウザなど）とサーバーは、互いに対応しているプロトコルバージョン（例：TLS 1.3, TLS 1.2）や暗号スイート（暗号化アルゴリズムの組み合わせ）の中で、最も安全性の高いものを選択して通信路を確立します。 しかし、多くのシステムは古いクライアントとの互換性を維持するために、旧バージョンのプロトコル（例：SSL 3.0, TLS 1.0）もサポートしている場合があります。

この後方互換性を悪用するのがダウングレード攻撃です。攻撃者は、通信の初期段階（ハンドシェイク）に介入し、最新の安全なプロトコルでの接続を意図的に失敗させ、クライアントとサーバーに「より古い、脆弱な方式で再接続」するよう仕向けます。 結果として、本来であれば安全なはずの通信が、攻撃者によって容易に解読・改ざん可能な状態に陥ってしまうのです。

この攻撃は、攻撃者が通信経路の途中に割り込む「中間者攻撃（Man-in-the-Middle Attack, MitM攻撃）」として実行されるのが一般的です。 そのため、ユーザーやサーバー管理者が攻撃に気づくことは非常に困難です。

### 2. 攻撃の仕組み

SSL/TLSダウングレード攻撃は、クライアントとサーバーが通信を開始する際のネゴシエーション（折衝）プロセスに介入することで成立します。

**攻撃が成立する前提条件:**
攻撃者が、標的となるユーザーの通信経路上に割り込める環境が必要です。具体的には、以下のような状況が考えられます。
*   **公衆Wi-Fi:** 暗号化されていない、あるいはセキュリティの甘い公衆Wi-Fiスポット。
*   **マルウェア感染:** ユーザーのPCがマルウェアに感染し、通信がプロキシされる。
*   **ネットワーク機器の侵害:** 企業のルーターやスイッチなどが乗っ取られている。

**攻撃のステップ:**

1.  **中間者としての介在:** 攻撃者は、クライアント（ユーザーのブラウザ）と正規のサーバーとの間に割り込み、すべての通信を中継できる状態を作ります（中間者攻撃）。

2.  **ClientHelloメッセージの妨害・改ざん:**
    *   クライアントは通信を開始するため、対応可能な最も新しいTLSバージョン（例：TLS 1.3）や暗号スイートのリストを含んだ「ClientHello」メッセージをサーバーに送信します。
    *   攻撃者はこのメッセージを傍受し、ブロックするか、内容を改ざんします。例えば、対応リストから最新のバージョンを削除し、脆弱なSSL 3.0しかサポートしていないかのように偽装します。

3.  **サーバーの応答とダウングレード:**
    *   サーバーは、攻撃者によって改ざんされた「ClientHello」メッセージを受け取ります。
    *   最新バージョンでの接続要求が届かないため、サーバーは「このクライアントは古いバージョン（SSL 3.0）にしか対応していない」と判断し、その古いバージョンで通信を確立しようと応答します（ServerHello）。

4.  **脆弱な通信の確立:**
    *   クライアントはサーバーからの応答を受け、本来意図していなかった脆弱なプロトコル（SSL 3.0など）で通信を開始してしまいます。多くのクライアントは、上位バージョンでの接続に失敗した場合、下位バージョンで再試行するフォールバック機能を備えているため、この攻撃が成功しやすくなります。

5.  **盗聴・改ざんの実行:**
    *   一度、脆弱なプロトコルでの通信が確立されると、攻撃者はそのプロトコルに存在する既知の脆弱性を利用して、暗号化された通信内容を解読したり、不正な情報を注入したりすることが可能になります。

このように、攻撃者は通信当事者を騙して、意図的にセキュリティレベルを引き下げることで、本来は保護されているはずの情報を窃取するのです。

### 3. 代表的なSSL/TLSダウングレード攻撃

過去に発見され、大きな影響を与えた代表的なダウングレード攻撃には、以下のようなものがあります。

#### POODLE攻撃 (Padding Oracle On Downgraded Legacy Encryption)
2014年に発見されたPOODLE攻撃は、SSL 3.0プロトコルのCBC（Cipher Block Chaining）モードにおけるパディングの脆弱性を悪用するものです。
*   **攻撃手法:** 攻撃者は中間者攻撃によって、クライアントとサーバーの間のTLS接続を意図的に失敗させ、SSL 3.0での再接続を強制します（ダウングレード）。 その後、SSL 3.0のパディングに関する脆弱性を利用して、暗号化された通信（Cookieなど）の内容を1バイトずつ解読していきます。
*   **影響:** この攻撃により、セッションCookieやパスワードなどの機密情報が盗まれ、アカウントの乗っ取りなどにつながる可能性がありました。
*   **対策:** この攻撃への根本的な対策は、サーバーとクライアントの両方でSSL 3.0を無効化することです。

#### FREAK攻撃 (Factoring RSA Export Keys)
FREAK攻撃は、1990年代に米国が定めていた暗号輸出規制に起因する脆弱性を悪用します。 当時、米国外へ輸出されるソフトウェアの暗号強度は意図的に弱く（RSA鍵長が512ビット以下に）制限されていました。
*   **攻撃手法:** 攻撃者は、クライアントとサーバーの間に介在し、サーバーがこの「輸出グレード」の脆弱なRSA暗号をサポートしている場合、クライアントに強制的にその暗号を使用させます。 512ビットのRSA鍵は、2015年当時の計算能力で数時間で解読可能であり、攻撃者は通信を復号できました。
*   **影響:** 通信内容が完全に解読され、盗聴や改ざんの被害を受けました。
*   **対策:** サーバー側で輸出グレードの暗号スイートを無効化すること、そしてクライアント側で脆弱性の修正されたバージョンのソフトウェア（ブラウザやOS）を使用することです。

#### Logjam攻撃
Logjam攻撃は、FREAK攻撃と同様に、輸出グレードの暗号にダウングレードさせる攻撃ですが、対象はDiffie-Hellman（DH）鍵交換アルゴリズムです。
*   **攻撃手法:** 攻撃者は、TLSのハンドシェイク中に介入し、サーバーに対して強固なDH鍵交換の代わりに、512ビットのような非常に脆弱な「輸出グレード」のDHパラメータを使用するように強制します。この弱いパラメータで生成された共通鍵は、攻撃者によって比較的容易に計算され、通信が解読されてしまいます。
*   **影響:** 通信の機密性が失われ、盗聴される危険性があります。
*   **対策:** サーバー側で弱いDHパラメータの使用を禁止し、2048ビット以上の強固なパラメータを使用すること、クライアント側は最新のブラウザを使用することが求められます。

#### SLOTH攻撃 (Security Losses from Obsolete and Truncated Transcript Hashes)
SLOTH攻撃は、TLSハンドシェイクのデジタル署名の検証プロセスを悪用するものです。
*   **攻撃手法:** 攻撃者は、クライアントとサーバーのネゴシエーションに介入し、本来使用されるべき安全なハッシュアルゴリズム（SHA-256など）の代わりに、古くて脆弱なアルゴリズム（MD5やSHA-1）を使用するように仕向けます。これにより、攻撃者は署名を偽造し、サーバーやクライアントになりすますことが可能になります。
*   **影響:** 認証プロセスの突破、なりすましによるフィッシング詐欺や情報窃取。
*   **対策:** サーバーおよびクライアントで、MD5やSHA-1などの古いハッシュアルゴリズムを署名に使用することを禁止する設定が必要です。

### 4. 攻撃による影響・被害

ダウングレード攻撃が成功すると、暗号化が無力化または弱体化するため、以下のような深刻な被害につながる可能性があります。

*   **通信内容の盗聴:**
    *   ID、パスワード、マイナンバー、口座情報などの認証情報や個人情報の漏洩。
    *   クレジットカード番号やセキュリティコードの窃取。
    *   企業の機密情報やプライベートなメッセージの盗聴。

*   **通信内容の改ざん:**
    *   **フィッシングサイトへの誘導:** 正規のウェブサイトの通信内容を改ざんし、ユーザーを偽のログインページへ誘導して認証情報を盗む。
    *   **マルウェアの注入:** ユーザーがファイルをダウンロードする際に、通信内容を改ざんしてマルウェアを注入する。
    *   **不正な送金:** オンラインバンキングの通信を改ざんし、送金先や金額を不正に書き換える。

*   **なりすまし:**
    *   攻撃者が正規のユーザーになりすましてサービスを不正利用する（セッションハイジャック）。
    *   攻撃者が正規のサーバーになりすまし、偽の情報をユーザーに提供する。

### 5. 具体的な対処手順

ダウングレード攻撃への対策は、サーバー管理者側、クライアント（利用者）側、そして開発者側のそれぞれで実施する必要があります。基本原則は「古い技術を捨て、最新の状態を維持する」ことです。

#### サーバー側の対策

Webサーバーや各種サービスの管理者は、以下の対策を徹底する必要があります。

##### ① 古いプロトコルの無効化
最も重要かつ効果的な対策は、脆弱性の原因となる古いプロトコル（SSLv2, SSLv3, TLS 1.0, TLS 1.1）を完全に無効化し、TLS 1.2およびTLS 1.3のみを許可することです。

**【Apacheでの設定例】**
`ssl.conf` や各サイトのconfファイルで `SSLProtocol` ディレクティブを編集します。

```apache
# 古いプロトコルをすべて無効化し、TLS 1.2とTLS 1.3のみを有効化
SSLProtocol -all +TLSv1.2 +TLSv1.3
```

**【Nginxでの設定例】**
`nginx.conf` や各サーバーブロックのconfファイルで `ssl_protocols` ディレクティブを編集します。

```nginx
# TLS 1.2とTLS 1.3のみを有効化
ssl_protocols TLSv1.2 TLSv1.3;
```

##### ② 脆弱な暗号スイートの無効化
輸出グレードの暗号、RC4、3DES、匿名のDH鍵交換（aNULL）、CBCモードの暗号など、既知の脆弱性を持つ暗号スイートを無効化し、強力なものだけを許可します。

**【Apacheでの設定例】**

```apache
SSLCipherSuite HIGH:!aNULL:!MD5:!3DES:!RC4
SSLHonorCipherOrder on
```
`SSLHonorCipherOrder on` は、クライアントが提示するリストではなく、サーバー側が指定した優先順位で暗号スイートを選択するように強制する設定で、より安全です。

**【Nginxでの設定例】**

```nginx
ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384';
ssl_prefer_server_ciphers on;
```
`ssl_prefer_server_ciphers on;` がApacheの`SSLHonorCipherOrder on`に相当します。

##### ③ HSTS (HTTP Strict Transport Security) の導入
HSTSは、一度HTTPSでアクセスしたサイトに対して、以降はブラウザが強制的にHTTPSで接続するようになる仕組みです。 これにより、攻撃者がHTTPへのダウングレードを試みる攻撃（SSL Strippingなど）を防ぐことができます。

**【Apacheでの設定例】** (`mod_headers` が有効である必要があります)

```apache
<IfModule mod_headers.c>
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
</IfModule>
```

**【Nginxでの設定例】**

```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```
`max-age`はHSTSを有効にする期間（秒）、`includeSubDomains`はそのドメインのすべてのサブドメインにも適用するオプションです。

##### ④ TLS_FALLBACK_SCSV のサポート
これは、プロトコルのダウングレードを検知するための仕組みです。 クライアントが一度新しいプロトコル（例: TLS 1.2）での接続に失敗し、意図的に古いプロトコル（例: TLS 1.0）で再接続を試みる際、そのことを示す特殊な信号（`TLS_FALLBACK_SCSV`）をサーバーに送ります。 サーバーがこの信号を受け取り、かつ自身がクライアントが最初に試したであろう、より新しいプロトコルに対応している場合、「これは攻撃の可能性がある」と判断して接続を拒否します。

幸いなことに、この仕組みはPOODLE攻撃が発見された2014年以降、主要なブラウザやサーバーソフトウェア（OpenSSLなど）で標準的にサポートされるようになっています。 したがって、ソフトウェアを最新に保っていれば、基本的には有効になっています。

##### ⑤ 定期的な脆弱性診断
設定が正しく行われているか、新たな脆弱性が発生していないかを確認するため、定期的に外部のツール（Qualys SSL LabsのSSL Server Testなど）を使ってサーバーのTLS設定を診断することが非常に重要です。

#### クライアント（ブラウザ）側の対策

一般の利用者ができる対策はシンプルですが、非常に重要です。

##### ① 最新バージョンの利用
Webブラウザ、OS、その他のアプリケーションを常に最新の状態に保つことが最も重要です。主要なブラウザベンダー（Google, Mozilla, Microsoft, Apple）は、2020年頃にはTLS 1.0およびTLS 1.1をデフォルトで無効化しており、脆弱なプロトコルへの接続を標準でブロックしています。

##### ② VPNの利用
特に信頼性の低い公衆Wi-Fiなどを利用する際は、信頼できるVPN（Virtual Private Network）サービスを利用することで、通信経路全体が暗号化され、中間者攻撃のリスクを大幅に低減できます。

#### 開発者・運用者向けの対策

##### ① ライブラリのアップデート
アプリケーションが利用しているSSL/TLSライブラリ（OpenSSL, GnuTLS, BoringSSLなど）を常に最新のバージョンにアップデートし、脆弱性を修正してください。

##### ② セキュアコーディング
アプリケーション自身がSSL/TLS接続をハンドリングする場合、許容するプロトコルのバージョンや暗号スイートを明示的に指定し、安全な設定を強制することが重要です。

### 6. 近年の傾向と今後の展望

##### TLS 1.3の普及
近年の大きな進展は、**TLS 1.3**の標準化と普及です。 TLS 1.3は、セキュリティとパフォーマンスの両面で大幅な改善がなされています。
*   **ハンドシェイクの高速化・単純化:** ハンドシェイクのプロセスが効率化され、攻撃者が介入する隙が少なくなりました。
*   **古い暗号方式の廃止:** 脆弱性の原因となりやすかった多くの古い暗号アルゴリズムや鍵交換方式が完全に廃止されました。
*   **ダウングレード攻撃への耐性強化:** TLS 1.3の`ServerHello`メッセージには、サーバーがダウングレード攻撃を検知するためのランダムな値が含まれており、プロトコルのバージョンロールバック攻撃への耐性が設計レベルで組み込まれています。

##### 主要プラットフォームによる古いプロトコルの廃止
前述の通り、主要なブラウザベンダーはすでにTLS 1.0/1.1を廃止しました。 これにより、一般的なWebブラウジングにおけるダウングレード攻撃のリスクは大幅に減少しました。しかし、レガシーシステムや特殊なクライアントソフトウェアでは依然として古いプロトコルが使われている可能性があり、注意が必要です。

##### IoTデバイスの脆弱性
アップデートが困難、あるいは全く提供されない安価なIoTデバイス（ネットワークカメラ、スマート家電など）は、ダウングレード攻撃の格好の標的です。これらのデバイスが出荷時の古いTLSライブラリを使い続けているケースは多く、家庭内や企業内ネットワークの深刻なセキュリティホールとなる可能性があります。

##### 新たな攻撃手法の出現
TLSプロトコル自体が強化されても、その「実装」のバグや、他の技術と組み合わせた新たな攻撃手法が出現する可能性は常にあります。例えば、サイドチャネル攻撃とダウングレード攻撃を組み合わせることで、より少ない試行回数で情報を窃取する研究なども考えられます。

### 7. まとめ

SSL/TLSダウングレード攻撃は、通信の安全性を確保するための根幹である暗号化プロトコルを無力化する、巧妙かつ危険な攻撃手法です。攻撃者は、システムが持つ後方互換性を悪用し、意図的に脆弱な状態を作り出すことで情報を盗み見ます。

この脅威からシステムと情報を守るための対策は明確です。
*   **サーバー側:** SSL 3.0, TLS 1.0, TLS 1.1といった古いプロトコルと、脆弱な暗号スイートを完全に無効化する。
*   **クライアント側:** ブラウザやOSを常に最新の状態に保つ。

TLS 1.3の普及により、プロトコルレベルでの安全性は大きく向上しました。しかし、古いシステムやIoTデバイスなど、依然としてリスクを抱える領域は存在します。システム管理者、開発者、そして利用者の三者がそれぞれの立場でセキュリティ意識を高く持ち、適切な設定と継続的なアップデートを怠らないことが、安全なインターネット通信を維持するために不可欠です。
