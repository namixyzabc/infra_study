

### 第1章: Datadogとは何か？

まず、Datadogがどのようなツールであり、なぜ現代のITインフラにおいて不可欠とされているのかを理解しましょう。

#### 1-1. Datadogの基本: Observability (可観測性) プラットフォーム

Datadogは、クラウド時代のアプリケーションとインフラストラクチャのための**統合監視および分析プラットフォーム**です。その中心的な思想は「**Observability（オブザーバビリティ、可観測性）**」にあります。

*   **Observability (可観測性)とは？**
    *   システムの内部状態を、外部から得られるデータ（出力）のみを用いて、どれだけ深く理解できるかを示す指標です。
    *   従来の「監視（Monitoring）」が「既知の異常（例：CPU使用率が90%を超えた）」を検知するのに対し、オブザーバビリティは「**未知の異常（例：なぜか特定のエンドポイントだけレスポンスが遅い）**」の原因を調査し、理解することを目指します。
    *   このオブザーバビリティを実現するために、Datadogは以下の「**3本柱**」となるデータを収集・分析します。

    1.  **メトリクス (Metrics):**
        *   **説明:** 一定間隔で収集される数値データです。CPU使用率、メモリ使用量、ネットワークトラフィック、リクエスト数など、システムのパフォーマンスや状態を定量的に示します。
        *   **役割:** システム全体の健全性の把握、パフォーマンスの傾向分析、異常の兆候検知（アラート）に使われます。

    2.  **トレース (Traces):**
        *   **説明:** 個々のリクエストがシステム内の複数のサービスをどのように経由していくかの詳細な記録です。リクエストの開始から終了までの各処理（スパン）の所要時間や親子関係を可視化します。
        *   **役割:** パフォーマンスのボトルネック特定、マイクロサービス間の依存関係の理解、エラーが発生した具体的な処理箇所の特定に使われます。

    3.  **ログ (Logs):**
        *   **説明:** アプリケーションやシステムが生成する、タイムスタンプ付きのテキストベースのイベント記録です。エラーメッセージ、アクセス記録、デバッグ情報などが含まれます。
        *   **役割:** 特定のイベント発生時の詳細なコンテキストの把握、エラーの原因調査、セキュリティインシデントの監査証跡として使われます。

Datadogは、これら3種類のデータを一つのプラットフォームに集約し、それらを相互に関連付けて分析することを可能にします。これにより、例えば「CPU使用率の急上昇（メトリクス）」が「特定APIへのリクエスト急増（トレース）」によって引き起こされ、その結果「データベース接続エラー（ログ）」が多発している、といった一連の事象をシームレスに追跡できるのです。

#### 1-2. Datadogの主な特徴

*   **SaaS型プラットフォーム:**
    *   **SaaS (Software as a Service) とは、** ソフトウェアをインターネット経由でサービスとして提供する形態です。ユーザーは自身でサーバーを構築・管理する必要がなく、アカウントを作成すればすぐに利用を開始できます。
    *   DatadogもSaaSであるため、監視サーバーの運用・保守といった手間から解放され、本来の目的であるシステムの監視と分析に集中できます。

*   **統合されたビュー:**
    *   前述のメトリクス、トレース、ログがすべて単一のUIで提供されます。これにより、複数のツールを行き来することなく、問題の全体像を俯瞰し、ドリルダウンして詳細を調査できます。

*   **豊富なインテグレーション:**
    *   AWS, Google Cloud, Microsoft Azureといった主要なクラウドプロバイダーはもちろん、Kubernetes, Docker, Nginx, MySQL, Slack, PagerDutyなど、**700以上の技術やサービスとの連携（インテグレーション）**が標準で提供されています。
    *   これにより、既存の環境に簡単に追加でき、あらゆる場所からデータを収集することが可能です。

*   **AI/MLを活用した機能 (Watchdog):**
    *   機械学習アルゴリズムを用いて、システム内の異常なパターンを自動的に検出・通知する機能です。人間が設定した閾値ベースのアラートでは見逃しがちな、潜在的な問題を早期に発見するのに役立ちます。

#### 1-3. Datadog Agent: データ収集の要

Datadogがこれらのデータを収集するために中心的な役割を果たすのが「**Datadog Agent**」です。

*   **Agentの役割:**
    *   監視対象のホスト、コンテナ、サーバーレス環境などにインストールされる軽量なソフトウェアです。
    *   ホストのメトリクス（CPU, メモリ, ディスクなど）を収集します。
    *   アプリケーションのトレース情報やカスタムメトリクスを収集します (DogStatsDプロトコル経由)。
    *   指定されたファイルやポートからログを収集します。
    *   収集したデータを圧縮・暗号化し、セキュアにDatadogのバックエンドへ送信します。

*   **Agentのアーキテクチャ:**
    *   Agentはコアコンポーネントと、特定の技術（例: Nginx, MySQL）を監視するための「インテグレーションチェック」で構成されています。設定ファイル (`datadog.yaml` や `conf.d/` ディレクトリ内のYAMLファイル) を編集することで、何を監視するかを柔軟に設定できます。

*   **インストール方法の概要:**
    *   **Linux (Debian/Ubuntu):**
        ```bash
        # APIキーを環境変数に設定
        DD_AGENT_MAJOR_VERSION=7 DD_API_KEY="<YOUR_API_KEY>" DD_SITE="datadoghq.com" bash -c "$(curl -L https://s3.amazonaws.com/dd-agent/install_script.sh)"
        ```
    *   **Dockerコンテナ:**
        ```bash
        docker run -d --name dd-agent \
               -v /var/run/docker.sock:/var/run/docker.sock:ro \
               -v /proc/:/host/proc/:ro \
               -v /sys/fs/cgroup/:/host/sys/fs/cgroup:ro \
               -e DD_API_KEY="<YOUR_API_KEY>" \
               -e DD_LOGS_ENABLED=true \
               -e DD_APM_ENABLED=true \
               gcr.io/datadoghq/agent:latest
        ```
    *   **Kubernetes:**
        *   一般的には[Helmチャート](https://github.com/DataDog/helm-charts)や[DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/)としてデプロイされ、クラスタ内の全ノードでAgentを自動的に実行させます。

---

### 第2章: Datadogのコア機能 - Observabilityの3本柱

ここでは、オブザーバビリティの3本柱であるメトリクス、トレース、ログをDatadogでどのように扱うか、具体的な製品と実践例を交えて解説します。

#### 2-1. Infrastructure Monitoring (メトリクス)

システムの健全性を最も直感的に把握できるのがメトリクスです。Datadogの「Infrastructure Monitoring」は、インフラ全体のメトリクスを収集・可視化・監視する機能です。

*   **ダッシュボードの作成と活用:**
    *   ダッシュボードは、複数のメトリクスをグラフや表形式で自由に配置し、システムの状態を一覧できる画面です。
    *   **実践例: Webサーバーのパフォーマンスダッシュボードを作成する**
        1.  Datadog UIの左メニューから `Dashboards` > `New Dashboard` を選択します。
        2.  `New Screenboard` または `New Timeboard` を選択します。（Screenboardは自由配置、Timeboardは時間軸で固定）
        3.  ウィジェットの選択画面で `Timeseries` (時系列グラフ) を選びます。
        4.  **グラフ定義 (Graph your data):**
            *   **Metric:** `system.cpu.user` (CPUのユーザー空間使用率) を選択します。
            *   **From:** `host:<YOUR_WEB_SERVER_HOST>` のように、監視したいホストで絞り込みます。タグを使えば `service:web-server` のように複数のホストをまとめて可視化できます。
        5.  同様に、`system.mem.used` (使用メモリ量)、`nginx.net.connections` (Nginxのコネクション数) などのウィジェットを追加していきます。
        6.  `Save` ボタンでダッシュボードを保存します。
    *   これにより、CPU、メモリ、Nginxのコネクション数の相関関係を一つの画面で視覚的に確認できるようになります。

*   **モニター (アラート) の設定:**
    *   モニターは、メトリクスが特定の閾値を超えたり、異常な状態になったりした際に、アラートを通知する仕組みです。
    *   **実践例: CPU使用率が閾値を超えたらSlackに通知する**
        1.  Datadog UIの左メニューから `Monitors` > `New Monitor` を選択します。
        2.  モニターのタイプとして `Metric` を選択します。
        3.  **メトリクスの定義 (Define the metric):**
            *   `system.cpu.idle` (CPUのアイドル時間) を選択し、`avg by host` でホストごとに平均値を取るように設定します。アイドル時間が低い = 使用率が高い、という考え方です。
        4.  **アラート条件の設定 (Set alert conditions):**
            *   `Alert threshold` を `20` % `below` (より下) に設定します。これは、CPUアイドル時間が20%を下回った（= CPU使用率が80%を超えた）場合にアラートを発することを意味します。
            *   `for the last 5 minutes` のように、一時的なスパイクで誤報しないように評価期間を設定します。
        5.  **通知設定 (Say what's happening):**
            *   通知メッセージを記述します。`@slack-<channel_name>` のように記述することで、指定したSlackチャンネルに通知を送ることができます。（事前にSlackインテグレーションの設定が必要です）
            *   `@pagerduty` でインシデント管理ツールに連携することも可能です。
        6.  `Save` ボタンでモニターを保存します。

#### 2-2. APM (Application Performance Monitoring) (トレース)

APMは、アプリケーションの内部動作を可視化し、パフォーマンス問題を特定するための機能です。中心となるのが「**分散トレーシング**」です。

*   **APMと分散トレーシングとは？**
    *   **分散トレーシング (Distributed Tracing):** マイクロサービスアーキテクチャのように、リクエストが複数のサービスをまたいで処理される際に、その一連の流れ全体を追跡する技術です。
    *   **トレース (Trace):** あるリクエストの一連の処理全体を表します。
    *   **スパン (Span):** トレースを構成する個々の処理単位です。例えば、「APIゲートウェイでの処理」「ユーザー認証サービスでの処理」「DBクエリの実行」などがそれぞれスパンになります。各スパンは開始時刻、終了時刻、処理時間、親子関係などの情報を持ちます。

*   **Datadog APMの主要機能:**
    *   **サービスマップ (Service Map):** サービス間の依存関係と通信状況（リクエスト数、レイテンシー、エラー率）をリアルタイムに地図のように可視化します。
    *   **レイテンシー分析:** 各エンドポイントや処理のレイテンシー（応答時間）の分布を分析し、遅延の原因となっている箇所を特定します。
    *   **エラー追跡:** 発生したエラーをトレースと紐付けて集計し、どのリクエストで、どのコード箇所でエラーが起きたかを即座に特定できます。

*   **実践例: Python (Flask) アプリケーションにAPMを導入する**
    1.  **トレーシングライブラリのインストール:**
        ```bash
        pip install ddtrace
        ```
    2.  **アプリケーションコードの修正:**
        `ddtrace-run` コマンドを使ってアプリケーションを起動するだけで、自動的に多くのフレームワーク（Flask, Django, FastAPIなど）の処理をトレースしてくれます。
        ```python
        # app.py (簡単なFlaskアプリケーション)
        from flask import Flask
        
        app = Flask(__name__)
        
        @app.route('/')
        def hello():
            return "Hello, World!"
        
        @app.route('/slow')
        def slow_endpoint():
            import time
            time.sleep(2) # 意図的に遅延させる
            return "This was slow."
        
        if __name__ == '__main__':
            # 通常の起動方法
            # app.run(host='0.0.0.0', port=5000)
            pass
        ```
    3.  **ddtrace-run を使った起動:**
        `DATADOG_SERVICE_NAME` などの環境変数を設定し、`ddtrace-run` コマンドで起動します。
        ```bash
        export DD_AGENT_HOST=localhost # Agentが同じホストで動いている場合
        export DD_SERVICE_NAME=my-flask-app
        export DD_ENV=development
        export DD_VERSION=1.0.0
        
        ddtrace-run python app.py
        ```
    4.  **Datadog UIでの確認:**
        *   アプリケーションにアクセス（例: `curl http://localhost:5000/slow`）すると、数秒後にDatadog UIの `APM` > `Traces` にリクエストのトレースが表示されます。
        *   `/slow` エンドポイントのトレースを見ると、2秒間の`time.sleep(2)`が「フレームグラフ」として明確に可視化され、ボトルネックが一目で分かります。

#### 2-3. Log Management (ログ)

ログは、何が起こったかを記録する最も基本的な情報源です。DatadogのLog Managementは、膨大なログを効率的に収集、検索、分析する機能を提供します。

*   **ログ収集、処理、分析:**
    *   Datadog AgentがファイルやDockerコンテナの標準出力などからログを収集します。
    *   収集されたログは、Datadog側で自動的にパース（解析）されます。例えば、Nginxのアクセスログであれば、IPアドレス、リクエストメソッド、ステータスコードなどが自動的に属性（ファセット）として抽出されます。
    *   これにより、`status_code:500` のように、特定の条件でログを高速に検索・フィルタリングできます。

*   **ログパターンの自動検出:**
    *   類似した構造を持つログを自動的にグルーピングし、ノイズを削減します。これにより、「いつもと違うパターンのログ」が急増した場合などに素早く気づくことができます。

*   **ログからメトリクスを生成:**
    *   ログの内容に基づいて、カスタムメトリクスを作成できます。例えば、「ステータスコード5xxのエラーログの数」をメトリクスとして生成し、ダッシュボードで可視化したり、モニターでアラートを設定したりすることが可能です。

*   **実践例: Nginxのアクセスログを収集し、特定のステータスコードを検索する**
    1.  **Agentの設定:**
        Datadog AgentのNginxインテグレーションを有効にします。Agentの設定ディレクトリ（例: `/etc/datadog-agent/conf.d/`）に `nginx.d/conf.yaml` を作成します。
        ```yaml
        # nginx.d/conf.yaml
        init_config:
        
        instances:
          - nginx_status_url: http://localhost/nginx_status/
        
        # ログ収集の設定
        logs:
          - type: file
            path: /var/log/nginx/access.log
            service: nginx
            source: nginx
        ```
    2.  Agentを再起動すると、ログの収集が開始されます。
    3.  **Datadog UIでの検索:**
        *   UIの `Logs` メニューに移動します。
        *   検索バーに `source:nginx` と入力すると、Nginxから収集されたログのみが表示されます。
        *   さらに、`source:nginx status_code:404` と入力すると、リソースが見つからなかった（404 Not Found）リクエストのログだけをフィルタリングできます。
        *   左側のファセットパネルで、`status_code` をクリックし、`404` や `500` などの値を選択して絞り込むことも直感的に行えます。

---

### 第3章: セキュリティエンジニアのためのDatadog活用法

ここからが本題です。Datadogは単なるパフォーマンス監視ツールではなく、**セキュリティ運用を強力に支援するプラットフォーム**でもあります。Observabilityの考え方をセキュリティに応用することで、脅威の検知、調査、対応を劇的に効率化できます。

#### 3-1. なぜObservabilityがセキュリティに重要なのか？

*   **セキュリティインシデントの早期発見:**
    *   攻撃の兆候は、しばしばシステムのパフォーマンスや振る舞いの異常として現れます。例えば、ブルートフォース攻撃はログイン試行のログ急増やCPU負荷上昇として、マルウェアの活動は不審なネットワーク通信やプロセスの実行として現れます。これらの兆候をメトリクス、トレース、ログから早期に検知できます。

*   **インシデントレスポンスの迅速化:**
    *   インシデント発生時、「いつ、どこで、何が、どのように」起きたのかを迅速に把握する必要があります。Datadogの統合されたデータを使えば、攻撃の侵入経路から内部での活動、影響範囲までを一気通貫で調査でき、対応時間を短縮します。

*   **脅威ハンティング (Threat Hunting):**
    *   既知のシグネチャに頼るだけでなく、システム全体のデータの中から「通常とは異なる怪しい振る舞い」を能動的に探し出す活動です。Datadogの強力な検索・分析機能は、脅威ハンティングの強力な武器となります。

*   **コンプライアンス監査:**
    *   誰がいつどのリソースにアクセスしたか、設定がセキュリティ基準に準拠しているか、といった監査証跡をログや設定情報から効率的に収集・レポートできます。

#### 3-2. Datadog Cloud Security Management (CSM)

Datadogは、これらのセキュリティユースケースに対応するため、「**Cloud Security Management (CSM)**」という包括的なセキュリティ製品群を提供しています。これは、インフラからアプリケーションまで、クラウド環境全体を保護するための複数の機能で構成されています。

##### a. Cloud Security Posture Management (CSPM)

*   **役割:** クラウド環境（AWS, Azure, GCPなど）の**設定ミスや構成の不備を自動的に検出**し、セキュリティリスクを可視化する機能です。
*   **หลักการ:** CISベンチマークやNISTフレームワークといった業界標準のセキュリティ基準に基づき、クラウドリソースの設定を継続的にスキャンします。
*   **検出できる不備の例:**
    *   **パブリックに公開されているS3バケットやBlobストレージ**
    *   **広すぎる範囲（`0.0.0.0/0`）に開かれているセキュリティグループやファイアウォールルール**
    *   **MFA（多要素認証）が有効になっていない特権ユーザー**
    *   暗号化が有効になっていないデータベースやディスク
*   **実践例: AWSアカウントで公開設定のS3バケットを検出する**
    1.  DatadogのAWSインテグレーションを設定する際に、CSPM用のIAMロールを追加で設定します。（Datadogのドキュメントに詳細な手順があります）
    2.  設定が完了すると、Datadogは自動的にAWSアカウント内のリソース設定をスキャンし始めます。
    3.  UIの `Security` > `Configuration` (CSPM) に移動します。
    4.  `S3 bucket is publicly accessible` のような検出ルールがトリガーされている場合、問題のあるS3バケットの一覧が表示されます。
    5.  各検出結果には、問題のリソース、推奨される修正手順、関連するコンプライアンス基準（CIS, PCI DSSなど）が詳細に表示され、迅速な対応を支援します。

##### b. Cloud Workload Security (CWS)

*   **役割:** サーバー（ホスト）やコンテナといった**ワークロードのランタイム（実行時）における脅威を検出**する機能です。ホストベースの侵入検知システム（HIDS）に近い役割を果たします。
*   **หลักการ:** Datadog Agentがカーネルレベルでシステムコールを監視し、リアルタイムで不審なアクティビティを検出します。
*   **検出できる脅威の例:**
    *   **予期しないプロセスの実行** (例: Webサーバー上でシェルが起動される、`nmap` や `curl` が実行される)
    *   **ファイルの改ざん検知 (File Integrity Monitoring - FIM):** `/etc/passwd` や `/bin` ディレクトリ配下など、重要なシステムファイルの変更を監視します。
    *   **不審なネットワーク接続:** 未知のIPアドレスへのアウトバウンド通信、クリプトマイニングプールへの接続などを検出します。
*   **実践例: コンテナ内で予期しないプロセスが実行されたことを検知する**
    1.  Datadog AgentでCWSを有効にします。これには `system-probe` と呼ばれるAgentのコンポーネントが必要です。
    2.  UIの `Security` > `Workload Security` に移動します。
    3.  デフォルトで有効になっている検出ルール（Detection Rules）が多数あります。例えば、「Execution of Unexpected Child Process」ルールは、NginxのようなWebサーバープロセスから `bash` などのシェルが起動された場合にアラートを生成します。
    4.  もし攻撃者がWebアプリケーションの脆弱性を突いてコンテナ内でリバースシェルを実行しようとすると、このルールがトリガーされ、セキュリティイベントが生成されます。
    5.  イベントには、実行されたプロセス、親プロセス、コンテナID、ホスト名、関連するユーザー情報などが含まれ、詳細な調査が可能です。

##### c. Cloud SIEM (Security Information and Event Management)

*   **役割:** 様々なソース（ログ、CWSのイベント、CSPMの検出結果、その他サードパーティのセキュリティ製品）から収集した**セキュリティ関連の情報を集約し、相関分析することで、高度な脅威を自動的に検出**する機能です。
*   **หลักการ:** 「Detection Rules」と呼ばれる数百の定義済みルールセットを用いて、ログやイベントのストリームをリアルタイムで分析します。これらのルールは、MITRE ATT&CKフレームワークなどの攻撃テクニックに対応しています。
*   **検出できる脅威の例:**
    *   **ブルートフォース攻撃:** 短時間に大量の認証失敗ログが特定のIPアドレスから記録される。
    *   **クレデンシャルスタッフィング:** 複数のアカウントに対して、漏洩した認証情報を使ったログイン試行が検出される。
    *   **不審なAWS APIコール:** 通常とは異なる地域から特権的なAPI（例: `CreateUser`, `AttachUserPolicy`）が呼び出される。
*   **実践例: ブルートフォース攻撃の試みを検出する**
    1.  認証ログ（例: SSHの `auth.log`, Webアプリのログインログ）をDatadogに収集するように設定します。ログには認証の成否、ユーザー名、ソースIPアドレスが含まれている必要があります。
    2.  UIの `Security` > `SIEM` > `Detection Rules` に移動します。
    3.  `Brute Force Attempt` などのルールを探し、内容を確認します。ルールのロジックは通常、「同一のIPアドレスから、X分以内に、Y回以上の認証失敗が記録された場合」といった形になっています。
    4.  このルールがトリガーされると、`Security Signals` としてイベントが生成されます。
    5.  シグナルには、攻撃元のIPアドレス、標的となったユーザー、関連するログのサンプルなどが集約されており、調査担当者は状況を即座に把握できます。

##### d. Application Security Management (ASM)

*   **役割:** アプリケーション自体に潜む脆弱性を悪用する**攻撃を、アプリケーションの実行時に検知・防御**する機能です。RASP (Runtime Application Self-Protection) や IAST (Interactive Application Security Testing) の考え方を取り入れています。
*   **หลักการ:** APMで使用するトレーシングライブラリを拡張し、アプリケーション内部のデータフロー（HTTPリクエスト、データベースクエリ、ライブラリ呼び出しなど）を監視します。
*   **検出できる脅威の例:**
    *   **SQLインジェクション (SQLi)**
    *   **クロスサイトスクリプティング (XSS)**
    *   **サーバーサイドリクエストフォージェリ (SSRF)**
    *   **コマンドインジェクション**
    *   **安全でないライブラリ（既知の脆弱性を持つ依存関係）の使用**
*   **実践例: SQLインジェクション攻撃を検知する**
    1.  APMを導入済みのアプリケーションで、ASMを有効にします。通常は環境変数を設定するだけです。
        ```bash
        export DD_APPSEC_ENABLED=true
        ```
    2.  攻撃者がWebフォームに `admin' OR '1'='1` のような悪意のあるペイロードを入力してSQLインジェクションを試みます。
    3.  Datadogのトレーシングライブラリは、このHTTPリクエストがアプリケーション内部でどのように処理され、最終的にどのようなSQLクエリとして実行されるかを監視しています。
    4.  ライブラリは、入力されたペイロードがSQLクエリの構文を破壊していることを検知し、攻撃としてフラグを立てます。
    5.  `Security` > `Application Security` にセキュリティシグナルが生成されます。シグナルには、攻撃のタイプ（SQL Injection）、攻撃元IP、ターゲットのURL、脆弱なコード箇所に紐づくスタックトレース、そして関連するAPMトレースへのリンクが含まれます。
    6.  これにより、開発者はどのコードを修正すべきかを正確に特定できます。また、ASMをブロッキングモードで動作させれば、このような攻撃を未然に防ぐことも可能です。

#### 3-3. ログ管理とセキュリティ分析

CSM製品群に加えて、コア機能であるLog Managementもセキュリティ分析において極めて重要です。

*   **セキュリティ関連ログの収集:**
    *   OSの監査ログ (Linux `auditd`, Windows Event Log)
    *   クラウドの監査ログ (AWS CloudTrail, Azure Activity Log, Google Cloud Audit Logs)
    *   ファイアウォールやWAF (Web Application Firewall) のログ
    *   認証サーバー (Okta, Active Directory) のログ
    *   これらのログをすべてDatadogに集約することで、組織全体のセキュリティイベントを横断的に分析できます。

*   **ログ分析による脅威ハンティング:**
    *   **実践例: 認証失敗ログを分析して、特定のIPアドレスからの異常なアクセス試行を特定する**
        1.  DatadogのLogs Explorerを開きます。
        2.  検索クエリで認証失敗イベントを絞り込みます。例えば、`source:authlog status:error "failed password"` のように検索します。
        3.  `Analytics` ビューに切り替えます。
        4.  `Group by` で `client_ip` (ソースIPアドレス) を選択し、`Measure` で `Count of Events` を選択します。
        5.  `Top List` を表示すると、認証失敗回数が最も多いIPアドレスのランキングが表示されます。
        6.  もし特定のIPアドレスからの試行回数が突出して多ければ、それはブルートフォース攻撃やパスワードスプレー攻撃の兆候である可能性が高いです。そのIPアドレスをクリックして、さらにそのIPからの他のアクティビティ（どのユーザー名を試しているか、他のサービスへのアクセスはあるかなど）をドリルダウンして調査できます。

#### 3-4. インシデントレスポンスにおけるDatadogの活用

インシデントが発生した際、Datadogはタイムラインの再構築と影響範囲の特定に絶大な威力を発揮します。

1.  **検知 (Detection):**
    *   CWSが「不審なプロセスの実行」を検知、またはSIEMが「ブルートフォース攻撃」のシグナルを生成。これがインシデントレスポンスの起点となります。

2.  **トリアージと初期調査 (Triage & Initial Investigation):**
    *   生成されたセキュリティシグナルを確認します。シグナルには、影響を受けたホスト/コンテナ、関連するログ、MITRE ATT&CKのタクティクス・テクニックなどが含まれており、事態の深刻度を素早く判断できます。

3.  **タイムラインの再構築 (Timeline Reconstruction):**
    *   シグナルに関連付けられたログやトレースをワンクリックで表示します。
    *   例えば、CWSのイベント（例：`curl`実行）の直前のNginxのアクセスログを確認し、「特定の脆弱なURLへのPOSTリクエスト」が攻撃の起点であったことを特定します。
    *   次に、そのホストのメトリクスを確認し、「`curl`実行」の直後にCPU使用率やネットワークアウトバウンドが急上昇していることを確認します。これにより、データ窃取が行われた可能性を推測できます。

4.  **影響範囲の特定 (Scoping):**
    *   APMのサービスマップやインフラのホストマップを使って、攻撃を受けたホストがどのサービスと通信しているか、他に影響が及んでいる可能性のあるホストはどれか、を視覚的に特定します。
    *   Logs Explorerで、攻撃者のIPアドレスをクエリに入れ、組織内の他のシステムへのアクセス試行がなかったかを横断的に検索します。

5.  **封じ込めと根絶 (Containment & Eradication):**
    *   調査結果に基づき、ファイアウォールで攻撃者のIPをブロックしたり、侵害されたホストをネットワークから隔離したりします。

6.  **復旧と事後対応 (Recovery & Post-Mortem):**
    *   システムを正常な状態に復旧させた後、Datadogのデータを使ってインシデントレポートを作成します。
    *   再発防止策として、新しいモニター（例: 特定URLへのアクセス急増アラート）や、より厳格なCWS/SIEMの検出ルールを設定します。

---

### 第4章: Datadogの高度な機能とエコシステム

コア機能やセキュリティ機能に加えて、Datadogにはユーザー体験の監視やエコシステムの拡張に役立つ高度な機能があります。

#### 4-1. Synthetic Monitoring (合成監視)

*   **役割:** 実際のユーザーがアクセスする前に、アプリケーションの可用性とパフォーマンスの問題をプロアクティブに検出する機能です。世界中の拠点から定期的に仮想的なリクエストを送信し、WebサイトやAPIを監視します。
*   **主なテストの種類:**
    *   **APIテスト:** REST APIエンドポイントの可用性、応答時間、レスポンス内容（ステータスコード、ヘッダー、ボディ）を検証します。マルチステップAPIテストでは、ログイン→データ取得→ログアウトといった一連のシナリオをテストできます。
    *   **ブラウザテスト:** 実際のChromeブラウザを使って、ユーザー操作をシミュレートするテストです。ログインフォームへの入力、ボタンのクリック、ページの表示内容の確認など、複雑なユーザーフローをテストできます。
*   **実践例: Webサイトのログイン処理が正常に完了するかを定期的にチェックする**
    1.  UIの `Synthetics` > `New Test` > `Browser Test` を選択します。
    2.  監視したいログインページのURLを入力します。
    3.  画面レコーダーが起動し、実際のWebページが表示されます。
    4.  ユーザー名とパスワードの入力欄をクリックしてテキストを入力し、ログインボタンをクリックする、という操作を記録します。
    5.  ログイン後のページで、「ようこそ、〇〇さん」といった特定のテキストが表示されることを `Assert` (表明) します。
    6.  テストを実行する頻度（例: 5分ごと）と、実行するロケーション（東京、オレゴン、フランクフルトなど）を選択して保存します。
    *   これにより、ログイン機能に問題が発生した場合、実際のユーザーが影響を受ける前に、即座にアラートを受け取ることができます。

#### 4-2. Real User Monitoring (RUM)

*   **役割:** 実際のユーザーがアプリケーションをどのように体験しているかを可視化する機能です。フロントエンドのパフォーマンス問題やJavaScriptエラー、ユーザーの行動フローを分析します。
*   **収集するデータ:**
    *   **ページの読み込み時間 (Core Web Vitals):** LCP, FID, CLSといったユーザー体験に直結する指標。
    *   **JavaScriptエラー:** フロントエンドで発生したエラーとそのスタックトレース。
    *   **リソースの読み込み:** 画像やCSS、JSファイルの読み込みにかかる時間。
    *   **ユーザーセッション:** ユーザーがサイトにアクセスしてから離脱するまでの一連の操作（ページビュー、クリックなど）を記録・再生。

#### 4-3. Watchdog: AIによる自動異常検知

*   **役割:** Datadogが収集した膨大なメトリクスやログのデータを機械学習で自動分析し、人間が見逃しがちな異常や潜在的な問題を「インサイト」として提示する機能です。
*   **検出例:**
    *   「このホストのレイテンシーは、通常と比較して異常に高くなっています。原因は、`redis.command` メトリクスの急増と相関があるようです。」
    *   「`service:checkout` で、ある特定のバージョンのアプリケーションだけエラー率が突出しています。」
    *   このように、根本原因の推定まで行ってくれるため、問題解決の時間を大幅に短縮できます。

#### 4-4. インテグレーションとマーケットプレイス

*   **インテグレーション:** 前述の通り、700以上のサービスとの連携が可能です。これにより、あらゆるデータをDatadogに集約できます。`Datadog Marketplace` では、サードパーティのベンダーが開発したインテグレーションやアプリケーションを追加することもでき、プラットフォームの機能をさらに拡張できます。

---

### 第5章: 学習と実践のための次のステップ

#### 5-1. Datadogの学習リソース

*   **公式ドキュメント:** 最も正確で網羅的な情報源です。機能ごとの詳細な説明や設定方法が記載されています。
    *   [https://docs.datadoghq.com/](https://docs.datadoghq.com/)
*   **Datadog Learning Center:** ハンズオン形式のインタラクティブな学習コースが多数提供されています。無料で利用できるものも多く、実際に手を動かしながら学べます。
    *   [https://learn.datadoghq.com/](https://learn.datadoghq.com/)
*   **無料トライアル:** Datadogは14日間の無料トライアルを提供しています。自分の環境やサンドボックス環境で、実際にAgentをインストールし、本稿で解説した機能を試してみることが、最も効果的な学習方法です。

#### 5-2. まとめ: セキュリティエンジニアとしてのDatadogマスターへの道

Datadogは、現代の複雑なクラウドネイティブ環境において、システムの安定稼働とセキュリティを確保するための強力な武器です。セキュリティエンジニアにとって、Datadogを使いこなすことは以下の価値をもたらします。

*   **プロアクティブな脅威検知:** CSPMやCWSを活用し、攻撃を受ける前にリスクを低減し、実行時の脅威を早期に検知できます。
*   **効率的なインシデント対応:** メトリクス、トレース、ログを横断した調査により、インシデントの全体像を迅速に把握し、対応時間を短縮できます。
*   **DevSecOpsの推進:** APM/ASMを通じて開発の早い段階でセキュリティを組み込み、SIEMやログ分析によって運用フェーズでの継続的な監視を実現することで、開発、運用、セキュリティの連携を深めることができます。

