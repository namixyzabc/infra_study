
### 1. Datadogとは何か？

Datadogは、クラウド時代のアプリケーションとインフラストラクチャのために構築された、**監視およびセキュリティのSaaSプラットフォーム**です。SaaS（Software as a Service）とは、ソフトウェアをインターネット経由で利用する形態を指します。

従来、システムの監視はサーバーのCPU使用率やメモリ使用量といった「インフラ監視」、アプリケーションのエラーログを追う「ログ管理」、アプリケーションの処理速度を測る「パフォーマンス監視」などが、それぞれ別のツールで行われるのが一般的でした。

しかし、システムがコンテナやマイクロサービスといった複雑なアーキテクチャに移行するにつれて、これらの情報がバラバラに存在すると、問題の発見や原因究明に時間がかかるようになりました。

Datadogは、これらのバラバラだった監視データを**一つのプラットフォームに集約し、横断的に分析する**ことで、システム全体の状態を把握しやすくします。この「システム内部の状態を外部からどれだけ推測できるか」という性質を**オブザーバビリティ（Observability, 可観測性）**と呼びます。

#### 1.1. オブザーバビリティの三本柱

Datadogは、オブザーバビリティの主要な要素である「三本柱」を包括的にサポートしています。

1.  **メトリクス (Metrics)**
    *   **概要:** システムの状態を時系列で表す**数値データ**です。例えば、「CPU使用率」「メモリ使用量」「リクエスト数」「レイテンシー（応答時間）」などが該当します。
    *   **特徴:** 軽量で集計しやすく、長期間の傾向分析やアラート設定に適しています。システムの「何が」おかしいのか（例: CPU使用率が急上昇している）を教えてくれます。

2.  **トレース (Traces)**
    *   **概要:** あるリクエストがシステム内をどのように伝播し、どの処理にどれくらいの時間がかかったかを示す**一連の処理記録**です。特に、複数の小さなサービスが連携して動作する**マイクロサービスアーキテクチャ**において強力です。
    *   **特徴:** リクエストの全体像と、その中での個々の処理（スパン）の関係性を可視化します。システムの「どこで」問題が起きているのか（例: データベースへのクエリが遅い）を特定するのに役立ちます。

3.  **ログ (Logs)**
    *   **概要:** アプリケーションやシステムが特定のイベント発生時に出力する、**タイムスタンプ付きのテキストレコード**です。エラーメッセージ、デバッグ情報、アクセス記録などが含まれます。
    *   **特徴:** イベントの文脈や詳細な情報を提供します。システムの「なぜ」問題が起きたのか（例: `NullPointerException`が発生した）という根本原因を調査するために不可欠です。

Datadogは、これら三本柱を一つの画面でシームレスに切り替えながら調査できる点が最大の強みです。例えば、メトリクスでCPU使用率の異常を検知し、その時間帯のトレースを見てパフォーマンスが劣化したリクエストを特定し、最後にログで具体的なエラーメッセージを確認する、といった一連の調査がスムーズに行えます。

#### 1.2. なぜセキュリティエンジニアがDatadogを学ぶべきか？

近年、Datadogは単なる監視プラットフォームから、**セキュリティ機能を統合したプラットフォーム**へと進化しています。セキュリティエンジニアにとって、Datadogは以下の点で非常に強力なツールとなります。

*   **コンテキストの提供:** セキュリティアラートが発生した際に、そのアラートに関連するインフラのメトリクス、アプリケーションのトレース、詳細なログを即座に確認できます。これにより、「攻撃がシステムにどのような影響を与えたか」を迅速に把握できます。
*   **脅威検知と調査の効率化:** 従来の**SIEM (Security Information and Event Management)** 製品のように、ログやイベントを分析して脅威を検知します。しかし、Datadogはオブザーバビリティのデータと統合されているため、検知から調査、根本原因の特定までを同じプラットフォームで完結できます。
*   **DevSecOpsの推進:** 開発（Dev）、運用（Ops）、セキュリティ（Sec）が連携するDevSecOpsの文化において、全員が同じデータと同じツールを見ることは非常に重要です。Datadogは、開発者、運用者、セキュリティ担当者が共通の基盤で協力するためのハブとなります。

---

### 2. Datadogのコア機能：オブザーバビリティの三本柱

ここでは、Datadogの基本となるオブザーバビリティ関連の機能を詳しく解説します。

#### 2.1. Infrastructure Monitoring（インフラストラクチャ監視）

システムの土台となるサーバー、コンテナ、データベース、ネットワーク機器などの健全性を監視する機能です。

*   **Datadog Agent:**
    *   監視対象のホストやコンテナにインストールする軽量なソフトウェアです。AgentがCPU、メモリ、ディスクI/O、ネットワークトラフィックなどの基本的なシステムメトリクスを収集し、Datadogのバックエンドに送信します。
    *   Agentはオープンソースで、プラグイン機構（インテグレーション）により、Nginx, MySQL, Redisなど200種類以上のミドルウェアやサービスのメトリクスも収集できます。

*   **タグ付け (Tagging):**
    *   Datadogにおける**最も重要な概念の一つ**です。収集したすべてのデータ（メトリクス、ログ、トレース）に「タグ」と呼ばれるキーバリュー形式のラベルを付与できます。
    *   **例:** `env:prod`（本番環境）、`service:web-api`（Web APIサービス）、`region:ap-northeast-1`（東京リージョン）、`availability-zone:ap-northeast-1a`
    *   タグを使うことで、膨大なデータを柔軟にフィルタリング、グループ化、集計できます。「本番環境（`env:prod`）のWeb APIサービス（`service:web-api`）における、アベイラビリティゾーンごとの平均CPU使用率」といった複雑な分析が容易になります。

*   **実践例：EC2インスタンスの監視**
    1.  監視したいEC2インスタンスにDatadog Agentをインストールします。インストールコマンドはDatadogのUIから簡単に取得できます。
    2.  Agentが自動的にEC2のインスタンスID、インスタンスタイプ、AMI IDなどの情報をタグとして収集し始めます。
    3.  Datadogの `Infrastructure > Host Map` を見ると、EC2インスタンスがCPU使用率やメモリ使用率に応じて色分けされたマップで可視化されます。
    4.  特定のホストをクリックすると、そのホストに関する詳細なメトリクス（CPU、メモリ、ディスク、ネットワーク）のダッシュボードが表示されます。

![Infrastructure Host Mapのイメージ](https://docs.datadoghq.com/assets/images/dashboards/widgets/hostmap/host_map.png)
*(出典: Datadog Docs)*

#### 2.2. APM (Application Performance Monitoring)

アプリケーション自体のパフォーマンスを監視し、ボトルネックを特定するための機能です。

*   **トレースとスパン:**
    *   APMのデータは**トレース (Trace)**という単位で収集されます。トレースは、ユーザーからの1つのリクエストが完了するまでの一連の処理の流れ全体を表します。
    *   トレースは、**スパン (Span)**と呼ばれる個々の処理単位で構成されます。スパンは、特定の関数呼び出し、データベースクエリ、外部APIへのリクエストなどに対応します。
    *   各スパンには、処理名、開始時刻、処理時間、関連するサービス、タグなどの情報が含まれます。
    *   これらのスパンが親子関係を持つツリー構造を形成し、リクエスト全体の処理の流れ（＝トレース）を可視化します。これを**フレームグラフ (Flame Graph)**と呼びます。

![トレースのフレームグラフのイメージ](https://docs.datadoghq.com/assets/images/apm/trace_view_flame_graph.png)
*(出典: Datadog Docs)*

*   **導入方法:**
    *   APMを利用するには、アプリケーションのコードにDatadogのトレーシングライブラリを組み込みます。多くの言語（Java, Python, Ruby, Go, Node.js, .NET, PHPなど）に対応したライブラリが提供されています。
    *   例えば、Pythonの場合は `dd-trace-py` をインストールし、アプリケーションの起動時に `ddtrace-run` コマンドを使用するだけで、主要なウェブフレームワーク（Django, Flaskなど）やライブラリ（requests, psycopg2など）へのリクエストが自動でトレースされます。

    ```bash
    # Pythonでの例
    pip install dd-trace-py

    # アプリケーションの起動
    ddtrace-run python my_app.py
    ```

*   **サービスマップ:**
    *   収集したトレース情報を元に、システム内のサービス間の依存関係、リクエスト数、レイテンシー、エラー率を自動的にマッピングして可視化します。
    *   どのサービスがどのサービスを呼び出しているのか、どこがボトルネックになっているのかが一目でわかります。

*   **Continuous Profiler:**
    *   APMをさらに一歩進めた機能です。アプリケーションのコードを継続的にプロファイリングし、**CPUやメモリを最も消費しているコード行（関数）**を特定します。
    *   従来のプロファイラとは異なり、本番環境で常に動作させていてもオーバーヘッドが非常に小さいのが特徴です。パフォーマンス問題の原因をコードレベルで特定するのに非常に役立ちます。

#### 2.3. Log Management（ログ管理）

アプリケーションやインフラから出力される大量のログを一元的に収集、検索、分析、可視化する機能です。

*   **ログの収集:**
    *   Datadog Agentを設定することで、ファイルやコンテナの標準出力、ジャーナルなどからログを収集できます。
    *   また、AWS Kinesis/Firehose, GCP Pub/Sub, Azure Event Hubなどのクラウドサービスや、Fluentd/Logstashといったログ転送ツール経由でログを送信することも可能です。

*   **ログパイプラインとプロセッサ:**
    *   収集したログは、Datadog側で**パイプライン (Pipeline)**という処理フローを通ります。パイプライン内では、**プロセッサ (Processor)**を使ってログをパース（解析）したり、属性を追加・変更したりできます。
    *   例えば、Nginxのアクセスログのような非構造化ログは、**Grokパーサー**を使ってIPアドレス、リクエストメソッド、ステータスコードなどの情報を抽出し、検索可能な属性（ファセット）に変換します。
    *   **構造化ログ (Structured Logging)**を推奨します。初めからJSON形式でログを出力しておけば、パース処理が不要になり、より効率的にログを分析できます。

    ```json
    // 構造化ログの例
    {
      "timestamp": "2023-10-27T10:00:00Z",
      "level": "error",
      "message": "Failed to connect to database",
      "service": "auth-service",
      "user_id": "usr-12345",
      "db_host": "db.prod.internal"
    }
    ```

*   **ログエクスプローラー:**
    *   収集・処理されたログを検索、フィルタリング、分析するための強力なUIです。
    *   タグや属性（ファセット）で絞り込み、特定のパターンのログを時系列でグラフ化したり、出現頻度を分析したりできます。

*   **ログベースメトリクス (Logs-to-Metrics):**
    *   ログの内容からメトリクスを生成する機能です。例えば、「`level:error` というログの出現回数」をメトリクスとして作成し、ダッシュボードで可視化したり、アラートを設定したりできます。
    *   これにより、メトリクスとして直接収集できないような、アプリケーション固有のイベント数を監視できます。

---

### 3. Datadog Security Platform：セキュリティエンジニア向け機能

ここからが、セキュリティエンジニアにとって特に重要な機能群です。Datadog Security Platformは、オブザーバビリティのデータ基盤の上に構築されており、セキュリティイベントの検知から調査までをシームレスに行えるように設計されています。

#### 3.1. Cloud SIEM (Security Information and Event Management)

組織全体のログやセキュリティイベントを一元的に収集・分析し、リアルタイムで脅威を検知・調査するための機能です。

*   **機能:**
    *   **ログソースの統合:** クラウドプロバイダー（AWS CloudTrail, GCP Audit Logs, Azure Activity Logs）、SaaSアプリケーション（Okta, Google Workspace）、OS、ネットワーク機器など、様々なソースからログを取り込みます。
    *   **脅威検知ルール:** Datadogが提供する数百種類のアウトオブボックス（すぐに使える）な検知ルールと、自組織の要件に合わせて作成できるカスタムルールがあります。ルールは、MITRE ATT&CKフレームワークなどの業界標準にマッピングされています。
    *   **セキュリティシグナル:** 検知ルールに合致したイベントは、**セキュリティシグナル (Security Signal)**として生成されます。シグナルには、関連するログ、エンティティ（ユーザー、IPアドレス、ホストなど）、推奨される調査ステップが含まれます。

*   **検知ルールの例:**
    *   `Impossible Travel Detected`: あるユーザーが東京からログインした直後に、物理的に移動不可能な短時間でニューヨークからログインするなど、地理的に矛盾したログインを検知します。
    *   `AWS S3 Bucket Made Public`: プライベートなS3バケットが意図せずパブリックに公開される設定変更を検知します。
    *   `Anomalous number of password resets`: 特定のユーザーに対して、短時間に異常な回数のパスワードリセットが試行されたことを検知します。

*   **調査フロー:**
    1.  セキュリティシグナルが発生すると、担当者に通知が飛びます。
    2.  エンジニアはシグナルの詳細画面を開き、攻撃の概要（誰が、何を、どこで）を把握します。
    3.  画面には、そのシグナルに関連する**生のログ**が自動で紐づけられています。クリック一つで、CloudTrailのログや認証ログの詳細を確認できます。
    4.  さらに、シグナルに関連する**ホストのメトリクス**や**アプリケーションのトレース**にもワンクリックでジャンプできます。「この攻撃はシステムのパフォーマンスに影響を与えたか？」「特定のAPIエンドポイントが狙われたか？」といった影響範囲の調査が迅速に行えます。

この**オブザーバビリティデータとの連携**が、従来のSIEM製品に対するDatadog Cloud SIEMの最大の優位点です。

#### 3.2. CSM (Cloud Security Management)

クラウド環境のワークロードと設定のセキュリティを管理・強化するための機能群です。以前はCWPPとCSPMという2つの製品でしたが、統合されてCSMとなりました。

##### a. CWPP (Cloud Workload Security) - ワークロードのセキュリティ

サーバー、コンテナ、Kubernetesクラスターなど、実際にコードが動く環境（ワークロード）のランタイムセキュリティを監視します。

*   **主な機能:**
    *   **ファイル整合性監視 (FIM - File Integrity Monitoring):** `/etc/passwd` や `/bin/bash` といった重要なシステムファイルやディレクトリへの変更をリアルタイムで検知します。
    *   **ランタイム脅威検知:** カーネルレベルでシステムコールを監視し、実行中のプロセスの異常な振る舞いを検知します。例えば、「Webサーバーのプロセス（`nginx`）が予期せずシェル（`/bin/sh`）を起動した」といった、攻撃の兆候となりうる活動を捉えます。
    *   **脆弱性スキャン:** ホストやコンテナイメージに含まれるOSパッケージやライブラリの脆弱性（CVE）をスキャンし、一覧表示します。

*   **実践例：コンテナセキュリティ**
    *   コンテナ内で予期せぬパッケージがインストールされたり、機密情報を含むファイルが読み取られたり、外部への不審なネットワーク接続が確立されたりした場合に、それを検知してアラートを生成します。
    *   これにより、コンテナへの侵入やコンテナエスケープ（コンテナからホストOSへ権限を奪う攻撃）の試みを早期に発見できます。

##### b. CSPM (Cloud Security Posture Management) - クラウド設定のセキュリティ

AWS, GCP, Azureといったクラウドプラットフォーム自体の設定ミスや不備を継続的にスキャンし、セキュリティリスクを可視化します。

*   **主な機能:**
    *   **設定ミスの検知:** 「IAMユーザーにMFA（多要素認証）が設定されていない」「セキュリティグループでSSHポート（22）が全開放（0.0.0.0/0）されている」「データベースが暗号化されていない」といった、よくある設定ミスを自動で検知します。
    *   **コンプライアンス準拠:** **CIS Benchmarks**, **PCI DSS**, **SOC 2**, **GDPR** といった業界標準のセキュリティフレームワークや規制に基づいたチェックを自動で行い、準拠状況をレポートします。
    *   **リソースカタログ:** クラウド上のすべてのリソース（EC2, S3, IAM Roleなど）をインベントリ化し、タグや設定で検索できます。「`env:prod` タグが付いているが、暗号化されていないRDSインスタンスはどれか？」といった調査が可能です。

*   **実践例：S3バケットの公開設定ミス検知**
    1.  Datadog CSPMは、定期的にAWSアカウントのS3バケット設定をスキャンします。
    2.  ある開発者が誤って機密情報を含むバケットをパブリックに設定してしまいました。
    3.  CSPMは、この設定変更を数分以内に検知し、「S3 Bucket is publicly accessible」という内容の調査結果（Finding）を生成します。
    4.  この調査結果はCloud SIEMにセキュリティシグナルとして送られ、担当者にアラートが通知されます。
    5.  担当者は、どのバケットが、誰によって、いつ公開設定にされたかをCloudTrailのログと突き合わせて確認し、迅速に対応できます。

#### 3.3. ASM (Application Security Management)

アプリケーションコード自体に潜む脆弱性を悪用しようとする攻撃を、アプリケーションの実行時に検知・防御する機能です。

*   **仕組み:**
    *   ASMは、前述の**APM (Application Performance Monitoring) のトレーシング技術**を基盤としています。APMエージェントが、アプリケーション内部のデータフローやコード実行を監視します。
    *   この監視機能を利用して、SQLインジェクション（SQLi）、クロスサイトスクリプティング（XSS）、コマンドインジェクション、サーバーサイドリクエストフォージェリ（SSRF）といった攻撃パターンを検知します。
    *   このアプローチは **IAST (Interactive Application Security Testing)** や **RASP (Runtime Application Self-Protection)** と呼ばれる技術領域に近いです。

*   **APMとの強力な連携:**
    *   ASMの最大の特徴は、**攻撃がAPMのトレース情報と完全に紐づく**点です。
    *   例えば、SQLインジェクション攻撃を検知した場合、Datadogは単に「攻撃があった」と報告するだけではありません。
    *   その攻撃が「どのAPIエンドポイント（例: `/api/v1/users`）に対して」「どのユーザーから行われ」「アプリケーションコードの**どの関数**で処理され」「最終的に**どのSQLクエリ**としてデータベースに発行されたか」までを、APMのトレースビューで正確に可視化します。
    *   これにより、セキュリティエンジニアは脆弱性がコードのどの部分にあるのかを即座に特定し、開発者に的確な修正依頼ができます。

*   **攻撃のブロック（防御モード）:**
    *   ASMは、検知した攻撃をブロックする機能もベータ版として提供されています。これにより、脆弱性の修正が間に合わない場合の緊急対策（仮想パッチ）として機能します。

---

### 4. Datadogのその他の重要な機能

オブザーバビリティとセキュリティの中核機能に加え、それらのデータを活用するための周辺機能も非常に強力です。

#### 4.1. Dashboards（ダッシュボード）

*   **概要:** メトリクス、ログ、トレースなど、Datadog内のあらゆるデータを組み合わせて自由に可視化できるカスタムダッシュボード機能です。
*   **ウィジェット:** 時系列グラフ、クエリ値、トップリスト、ヒートマップ、地理マップ、サービスマップ、ログストリームなど、多彩なウィジェットが用意されています。
*   **テンプレート変数:** `$env`, `$service` のようなテンプレート変数を定義することで、ダッシュボードをインタラクティブに操作できます。例えば、プルダウンメニューで `env:prod` と `env:staging` を切り替えて、同じダッシュボードで本番環境とステージング環境の状況を比較できます。
*   **セキュリティダッシュボードの例:**
    *   Cloud SIEMで検知されたセキュリティシグナルの深刻度別件数
    *   攻撃元IPアドレスのトップリストと地理的分布
    *   CSPMで検知された設定ミスの種類別件数
    *   特定の機微なサービスにおけるエラーレートとレイテンシー

#### 4.2. Monitors（モニター）

*   **概要:** 特定の条件に基づいてアラートを生成・通知する仕組みです。システムの異常を能動的に検知し、問題が深刻化する前に対応するための重要な機能です。
*   **モニターの種類:**
    *   **Metric Alert:** メトリクスが設定した閾値を超えた、または下回った場合にアラートを発行します（例: CPU使用率が5分間継続して90%を超えた）。
    *   **Log Alert:** 特定の文字列（例: `FATAL`）を含むログが、一定時間内に一定数以上出現した場合にアラートを発行します。
    *   **APM Alert:** サービスのレイテンシー（p99）やエラー率が閾値を超えた場合にアラートを発行します。
    *   **Anomaly Detection:** 機械学習を用いて、メトリクスの通常の振る舞い（季節性やトレンド）を学習し、それから外れた**異常な挙動**を自動で検知します。閾値を手動で設定するのが難しい場合に非常に有効です。
    *   **Forecast:** メトリクスの将来の値を予測し、閾値に達する前に警告します（例: ディスク使用量が24時間以内に100%に達すると予測された）。
    *   **Security Rule Alert:** Cloud SIEMの検知ルールに合致した場合にアラートを発行します。

*   **通知:** アラートはEmail, Slack, PagerDuty, Opsgenieなど、様々なチャネルに通知できます。

#### 4.3. Synthetic Monitoring（合成監視）

*   **概要:** 世界中の複数の拠点（管理ロケーション）から、自社のWebサイトやAPIエンドポイントに対して能動的にリクエストを送り、パフォーマンスや可用性を外部から監視する機能です。**実際のユーザーが問題に遭遇する前に、問題をプロアクティブに検知する**ことが目的です。
*   **テストの種類:**
    *   **APIテスト:** REST APIのエンドポイントに対してGET, POSTなどのリクエストを送信し、ステータスコード、レスポンスタイム、レスポンスボディの内容が期待通りか（例: `{"status": "ok"}` を含むか）を検証します。多段階のAPI呼び出し（ログインAPIを叩いてトークンを取得し、そのトークンを使ってデータ取得APIを叩く）も可能です。
    *   **ブラウザテスト:** 実際のChromeブラウザを使って、ユーザーの一連の操作をシミュレートします。「トップページを開く -> ログインボタンをクリック -> ユーザー名とパスワードを入力 -> ログイン -> マイページが表示される」といったシナリオを記録し、定期的に実行します。Webアプリケーションの機能が壊れていないかを確認するE2E（End-to-End）テストとして利用できます。

#### 4.4. RUM (Real User Monitoring)

*   **概要:** Synthetic Monitoringが「ロボットによる外形監視」であるのに対し、RUMは**「実際のユーザーの体験」**を収集・分析する機能です。WebサイトやモバイルアプリにJavaScriptスニペットやSDKを組み込むことで、実際のユーザーのパフォーマンスデータや操作ログを収集します。
*   **収集データ:**
    *   **パフォーマンス:** ページロード時間（LCP, FCP）、インタラクティブになるまでの時間（TTI）、JavaScriptのエラーなど。
    *   **ユーザー行動:** ユーザーがどのページを閲覧し、どのボタンをクリックしたかといったセッション情報。
    *   **セッションリプレイ:** ユーザーの操作を動画のように再生し、ユーザーがどこでつまずいたのか、どんなエラーに遭遇したのかを視覚的に確認できます。

---

### 5. 実践的な使い方とベストプラクティス

#### 5.1. タグ付け戦略の重要性

前述の通り、**タグはDatadogを使いこなす上での鍵**です。全社で統一されたタグ付け戦略を立てることが非常に重要です。最低限、以下の3つのタグは標準化することを強く推奨します。

*   `env`: 環境（例: `prod`, `staging`, `dev`）
*   `service`: サービス名（例: `user-api`, `payment-gateway`, `frontend-web`）
*   `version`: デプロイされているアプリケーションのバージョン（例: `1.2.5`, `git-commit-hash`）

これらのタグをすべてのメトリクス、ログ、トレースに一貫して付与することで、以下のようなメリットが生まれます。

*   **分析の容易化:** 「`env:prod` の `service:payment-gateway` で、バージョン `1.2.5` をデプロイしてからエラーが増えた」といった分析が瞬時に行えます。
*   **コスト管理:** `team` タグ（例: `team:billing`）を付与することで、どのチームがどれだけDatadogのコストを使用しているかを可視化できます。
*   **アクセス制御:** DatadogのRBAC（ロールベースアクセス制御）機能とタグを連携させ、特定のチームのメンバーには自分たちの `service` のデータしか見せない、といった制御が可能です。

#### 5.2. TerraformによるDatadogリソースの管理 (IaC)

ダッシュボードやモニターを手動でWeb UIから作成するのは簡単ですが、数が増えてくると管理が煩雑になり、「誰がいつ何のために作ったのかわからない」状態になりがちです。

そこで、**Terraform**のような**IaC (Infrastructure as Code)**ツールを使って、Datadogのリソース（特にモニターやダッシュボード）をコードで管理することをお勧めします。

*   **メリット:**
    *   **バージョン管理:** Gitで変更履歴を管理できます。
    *   **再現性:** 同じ設定を別の環境に簡単にデプロイできます。
    *   **レビュー:** コードレビューを通じて、アラートの閾値が適切かなどをチームで確認できます。

*   **Terraformコードの例 (モニター作成):**

```terraform
# main.tf

provider "datadog" {
  api_key = var.datadog_api_key
  app_key = var.datadog_app_key
}

# 本番環境のWebサーバーのCPU使用率を監視するモニター
resource "datadog_monitor" "cpu_alert_prod" {
  name    = "[Prod] High CPU Usage on web-service"
  type    = "metric alert"
  message = "CPU usage is high on {{host.name}}. @slack-alerts-critical"

  # クエリ: env:prodかつservice:web-serviceのホストのCPU使用率（system）の平均が
  # 過去5分間、90%を超えたらトリガー
  query = "avg(last_5m):avg:system.cpu.system{env:prod,service:web-service} > 90"

  monitor_thresholds {
    critical = 90
    warning  = 80
  }

  tags = ["env:prod", "service:web-service", "terraform:true"]
}
```

#### 5.3. セキュリティインシデント調査のシナリオ例

ここでは、Datadogを使ってセキュリティインシデントを調査する一連の流れをシミュレートします。

**シナリオ: あるWebアプリケーションで、機密情報への不正アクセスが疑われるアラートが発生**

1.  **[検知] Cloud SIEMからのアラート**
    *   SlackにDatadog Cloud SIEMから「`Anomalous IP connecting to a sensitive endpoint`」というセキュリティシグナルが通知される。
    *   見慣れない海外のIPアドレスから、管理者用のAPIエンドポイント (`/api/v1/admin/users`) へ大量のアクセスがあったことが示されている。

2.  **[調査①] シグナルの詳細確認**
    *   シグナルの詳細画面に移動。攻撃元IPアドレス、標的となったホスト、関連するユーザーアカウントを確認。
    *   画面下部には、このシグナルを生成する元となった**Nginxのアクセスログ**が自動で紐づけられている。ログを見ると、`POST`リクエストで何らかのペイロードが送られていることがわかる。

3.  **[調査②] アプリケーションへの影響分析 (ASM & APM)**
    *   シグナル画面からワンクリックで、関連する**APMトレース**にジャンプする。
    *   トレースを見ると、リクエストがアプリケーション内部でどのように処理されたかがわかる。
    *   ここで、**Datadog ASM**が同じトレース上で「`SQL Injection Attack Detected`」という脅威を検知していることを発見。攻撃者は、ユーザー検索機能でSQLインジェクションを試みていたことが判明。
    *   フレームグラフをドリルダウンし、脆弱なコードが実行した**生のSQLクエリ** (`SELECT * FROM users WHERE name = '' OR '1'='1'`) を特定。これにより、全ユーザー情報が漏洩した可能性が高いと判断。

4.  **[調査③] ワークロードへの影響分析 (CSM - CWPP)**
    *   攻撃者がサーバーへの侵入に成功していないかを確認するため、標的となったホストの**CSM (CWPP)**の画面に移動。
    *   **ファイル整合性監視 (FIM)** を確認し、`/etc/` 配下などに不審な変更がないことを確認。
    *   **ランタイムセキュリティ**のイベントを確認し、`nginx` プロセスから不審なシェルが起動されていないかなどをチェック。幸い、侵入の痕跡は見つからない。

5.  **[調査④] クラウド環境への影響分析 (CSPM)**
    *   念のため、**CSPM**のダッシュボードで、関連するAWSアカウントに新たな設定ミスが発生していないかを確認。例えば、攻撃者が不正に取得した認証情報を使って、新たなIAMユーザーを作成したり、セキュリティグループを変更したりしていないかをチェックする。

6.  **[対応と報告]**
    *   調査結果をまとめ、インシデントレポートを作成。
    *   緊急対応として、攻撃元IPアドレスをWAF (Web Application Firewall) でブロック。
    *   開発チームに、ASMが特定した脆弱なコード箇所とSQLクエリの情報を提供し、即時修正を依頼。
    *   Datadogの**Notebooks**機能を使って、調査過程（確認したログ、トレース、メトリクスグラフなど）を時系列で記録し、事後レビューや報告書作成に活用する。

このシナリオのように、Datadogはセキュリティイベントの検知から、インフラ、アプリケーション、クラウド設定の各レイヤーにおける影響調査までを、**プラットフォームを切り替えることなく、一気通貫で実行できる**点が大きな強みです。

---

### 6. まとめ

Datadogは、もはや単なる「監視ツール」ではありません。それは、複雑なクラウドネイティブ環境の健全性を維持し、セキュリティを確保するための**統合オブザーバビリティ＆セキュリティプラットフォーム**です。

*   **三本柱（メトリクス、トレース、ログ）**を統合し、システムの「何が」「どこで」「なぜ」を迅速に解明します。
*   **セキュリティ製品群（SIEM, CSM, ASM）**は、オブザーバビリティのデータと深く連携し、脅威の検知から調査、根本原因の特定までをシームレスに支援します。
*   **タグ付け**と**IaC**による管理は、Datadogを大規模環境で効果的に運用するための鍵です。

