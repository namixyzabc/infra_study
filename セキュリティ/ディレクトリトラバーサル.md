### ディレクトリトラバーサル解説

### 1. ディレクトリトラバーサルとは

ディレクトリトラバーサルは、Webアプリケーションに存在するセキュリティ上の脆弱性の一種です。 攻撃者は、Webサーバー上のファイルやディレクトリのパスを不正に操作することで、本来アクセスが許可されていないファイルやディレクトリにアクセスします。

この攻撃は、Webアプリケーションの設計や実装の不備を突くもので、古くから知られていますが、現在でも多くのシステムで発見される深刻な脆弱性です。

**別名**
この攻撃は、その手法から様々な名前で呼ばれています。

*   **パストラバーサル (Path Traversal)**
*   **../（ドット・ドット・スラッシュ）攻撃**
*   **ディレクトリクライミング (Directory Climbing)**
*   **バックトラッキング (Backtracking)**

**攻撃の目的**
攻撃者の主な目的は、Webサーバーの公開領域（ドキュメントルート）の外に存在する、通常は閲覧できないはずのファイルにアクセスすることです。 これにより、以下のような情報を窃取しようとします。

*   **機密情報**: データベースの接続情報、APIキー、パスワードなどが記述された設定ファイル。
*   **個人情報**: ユーザー情報や顧客リストなどが含まれるファイル。
*   **システム情報**: OSのユーザー情報（例: `/etc/passwd`）や、アプリケーションのソースコードなど。

場合によっては、ファイルの読み取りだけでなく、ファイルの改ざんや削除、さらにはサーバーの完全な乗っ取りにまで発展する可能性があります。

**攻撃が成立する状況**
ディレクトリトラバーサル攻撃は、Webアプリケーションが以下の条件を満たす場合に成立します。

*   ユーザー（ブラウザ）からの入力値（URLのパラメータ、フォームの送信データなど）をファイル名やパスの一部として利用している。
*   その入力値に対して、危険な文字列（`../`など）を除去・検証する仕組み（サニタイズやバリデーション）が不十分である。

例えば、`https://example.com/show.php?file=document.pdf` のように、URLのパラメータで表示するファイル名を指定するアプリケーションがあったとします。この`file`パラメータの値を不正に操作することで、攻撃者は意図しないファイルにアクセスを試みます。

---

### 2. 攻撃の仕組みと具体例

ディレクトリトラバーサル攻撃は、コンピュータのファイルシステムにおける「パス」の仕組み、特に「相対パス」を悪用します。

**前提知識：絶対パスと相対パス**
ファイルの位置を示す「パス」には、大きく分けて2種類あります。

*   **絶対パス**: ファイルシステムの最上位階層（ルートディレクトリ）から目的のファイルまでの経路をすべて記述する方法です。 どの場所からアクセスしても、常に同じ記述になります。
    *   例 (Linux): `/var/www/html/images/photo.jpg`
    *   例 (Windows): `C:\inetpub\wwwroot\images\photo.jpg`

*   **相対パス**: 現在いるディレクトリ（カレントディレクトリ）を基準として、目的のファイルまでの相対的な位置関係を示す方法です。 特殊な記号が使われます。
    *   `.` : 現在のディレクトリ
    *   `..` : ひとつ上の階層のディレクトリ（親ディレクトリ）

ディレクトリトラバーサル攻撃では、この「`..`」を意図的に多数含んだパスをアプリケーションに渡すことで、ディレクトリ階層を不正に遡り（トラバースし）、目的のファイルにアクセスします。

#### 実践的な脆弱性の例と攻撃コード

以下に、プログラミング言語ごとの脆弱なコードの例と、それに対する具体的な攻撃リクエストを示します。

**PHPの例**

ユーザーが指定したファイルを表示する、以下のような脆弱なPHPコードがあったとします。

```php
<?php
  $template = $_GET['template'];
  include("/var/www/html/templates/" . $template);
?>
```

このコードは、URLパラメータ `template` の値をそのまま `include` 関数の引数に連結しています。

*   **正常なリクエスト**: `https://example.com/page.php?template=menu.php`
    *   サーバー内部では `/var/www/html/templates/menu.php` が読み込まれます。

*   **攻撃リクエスト**: `https://example.com/page.php?template=../../../../etc/passwd`
    *   サーバー内部では `/var/www/html/templates/../../../../etc/passwd` というパスが解釈されます。
    *   `../` が4回繰り返されることで、`/var/www/html/templates/` から4階層遡り、ルートディレクトリ `/` に到達します。
    *   結果として、Linux/UNIXシステムのパスワード情報が保存されている `/etc/passwd` ファイルの内容が読み取られ、Webページ上に表示されてしまいます。

**Javaの例**

Javaでファイルを扱う際にも同様の脆弱性が作り込まれる可能性があります。

```java
import java.io.File;
import java.io.FileInputStream;
import javax.servlet.http.HttpServletRequest;

// requestはHttpServletRequestオブジェクト
String filename = request.getParameter("filename");
File file = new File("/var/webapp/data/" + filename);
// この後、fileオブジェクトを使ってファイルの内容を読み取り、レスポンスとして返す
FileInputStream fis = new FileInputStream(file);
// ...
```

このコードも、外部からの入力 `filename` を検証せずにファイルパスを組み立てています。

*   **攻撃リクエスト**: `https://example.com/download?filename=../../../../../../windows/win.ini`
    *   サーバー内部では `/var/webapp/data/../../../../../../windows/win.ini` というパスが解釈されます。
    *   `../`を繰り返すことで、Windowsシステムの初期化情報が格納されている `win.ini` ファイルにアクセスされてしまう可能性があります。

#### 多様な攻撃パターン

攻撃者は、単純な `../` だけでなく、Webサーバーやアプリケーション、WAF（Web Application Firewall）による防御策を回避するために、様々な手口を用います。

*   **URLエンコーディング**:
    多くのWebシステムでは、URL内の特殊文字を `%` から始まる16進数コードに変換（URLエンコード）して送信します。攻撃者はこれを利用し、防御フィルターをすり抜けようとします。
    *   `../` → `%2e%2e%2f`
    *   `..\` → `%2e%2e%5c`
    *   **攻撃例**: `?file=%2e%2e%2f%2e%2e%2fetc%2fpasswd`

*   **ダブルURLエンコーディング**:
    一度デコードされた後にもう一度デコード処理を行うようなシステムの場合、エンコーディングを二重にかけることで、さらにフィルターを回避しようとします。
    *   `%2e%2e%2f` → `%252e%252e%252f` (`%`自体が`%25`にエンコードされる)

*   **OS固有のパス区切り文字**:
    Unix/Linux系では `/` ですが、Windowsでは `\` もパス区切り文字として利用できます。両方を試すことで、OSを特定したり、フィルターを回避したりします。
    *   **攻撃例**: `?file=..\..\..\..\windows\system.ini`

*   **絶対パス指定**:
    相対パスを使わずに、システムのルートディレクトリからの絶対パスを直接指定する手口です。
    *   **攻撃例**: `?file=/etc/passwd`

*   **Nullバイト文字 (`%00`)**:
    一部の古いプログラミング言語やライブラリでは、文字列の終端をNullバイト文字（`\0`）で判断します。攻撃者はこれを利用し、意図しない場所でファイルパスを終端させ、検証を回避しようとします。
    *   **脆弱なコードの例**: `include($_GET['lang'] . '.php');`
    *   **攻撃例**: `?lang=../../../../etc/passwd%00`
    *   この場合、末尾の `.php` が無視され、`/etc/passwd` が直接読み込まれる可能性があります。

---

### 3. ディレクトリトラバーサルによる影響

ディレクトリトラバーサル攻撃が成功すると、企業や組織は甚大な被害を受ける可能性があります。

*   **情報漏洩**: 最も一般的で直接的な被害です。
    *   **設定ファイル**: データベースの認証情報（ホスト名、ユーザー名、パスワード）、APIキー、外部サービスの秘密鍵などが漏洩し、さらなる不正アクセスの足がかりとなります。
    *   **システムファイル**: `/etc/passwd` や `/etc/shadow` ファイルからユーザーアカウント情報が漏洩したり、サーバーの設定情報が盗まれたりします。
    *   **ソースコード**: Webアプリケーションのソースコードが漏洩すると、他の脆弱性を見つけ出すためのヒントを攻撃者に与えてしまいます。
    *   **業務データ**: 非公開の顧客情報、財務情報、個人情報などが含まれるファイルが漏洩した場合、事業継続に深刻な影響を及ぼし、損害賠償問題に発展する可能性もあります。

*   **ファイルの改ざん・削除**:
    アプリケーションの作りによっては、ファイルの読み取りだけでなく、書き込みや削除が可能になる場合があります。
    *   Webサイトのコンテンツを改ざんされる。
    *   ログファイルを改ざん・削除し、攻撃の痕跡を隠蔽される。
    *   設定ファイルを書き換えられ、システムの挙動を不正に変更される。

*   **不正なコマンド実行（他の脆弱性との組み合わせ）**:
    ディレクトリトラバーサルは、他の脆弱性と組み合わせることで、より深刻な攻撃（リモートコード実行など）に発展することがあります。
    *   **例1**: ログファイルに悪意のあるスクリプトを注入し、ディレクトリトラバーサルを利用してそのログファイルをWebサーバーに読み込ませて実行させる。
    *   **例2**: ファイルアップロード機能と組み合わせ、任意の場所に不正なプログラムを設置し、それを実行させる。

*   **アカウントの乗っ取り**:
    パスワードファイルやセッション情報が保存されたファイルにアクセスされることで、正規ユーザーや管理者アカウントが乗っ取られる危険性があります。

これらの被害は、企業の金銭的損失、ブランドイメージや社会的信用の失墜、顧客からの信頼喪失など、計り知れないダメージにつながります。

---

### 4. 脆弱性の診断・検出方法

自社のWebアプリケーションにディレクトリトラバーサルの脆弱性が存在しないかを確認するためには、専門的な診断が必要です。診断方法は、手動で行う方法と、ツールを用いて自動化する方法に大別されます。

*   **手動での診断**:
    セキュリティ専門家が、プロキシツール（例: Burp Suite, OWASP ZAP）を使用して、アプリケーションとサーバー間のHTTPリクエストを監視・改ざんします。
    1.  ファイル名やパスらしきものが含まれるURLパラメータやフォームデータを見つけます。
    2.  そのパラメータに `../` やそのエンコードされた亜種、絶対パスなどを挿入したリクエストを送信します。
    3.  サーバーからのレスポンスを分析し、エラーメッセージの変化、非公開ファイルの内容が表示されるか、通常とは異なる挙動をするかなどを確認します。エラーメッセージから、ファイルシステムの構造を推測できることもあります。

*   **自動化ツールによる診断（脆弱性スキャナ）**:
    Webアプリケーション脆弱性スキャナは、対象のWebサイトを自動的に巡回（クロール）し、既知の脆弱性パターン（ディレクトリトラバーサルを含む）を網羅的に検査するツールです。
    *   **代表的なツール**: Acunetix, Burp Suite Pro, OWASP ZAPなど。
    *   **利点**: 網羅的かつ高速に診断が可能で、専門家でなくても基本的な検査を実施できます。
    *   **注意点**: ツールによる診断は、誤検知や検知漏れの可能性があるため、最終的には手動での確認（トリアージ）が必要です。

---

### 5. 具体的な対処手順（セキュリティ対策）

ディレクトリトラバーサルの脆弱性を防ぐための対策は、複数の防御層を設ける「多層防御」の考え方が基本となります。

#### 根本的な対策（アプリケーション設計・実装）

最も効果的な対策は、アプリケーションのコードレベルで脆弱性を生まないようにすることです。

1.  **外部からの入力をファイルパスとして直接使用しない**: これが最も重要かつ根本的な対策です。 どうしても外部入力に応じてファイルを提供する必要がある場合は、以下の方法を検討します。
    *   **ファイルIDとのマッピング**:
        ユーザーには `fileid=1` のように安全な識別子（連番やランダムな文字列）だけを渡し、サーバー側でそのIDに対応する実際のファイルパスを決定する仕組みにします。 これにより、ユーザーはファイルシステムの構造を一切操作できなくなります。
        ```
        // 例: IDとファイルパスの対応表（データベースや設定ファイルで管理）
        $file_map = [
          '1' => '/var/www/data/document1.pdf',
          '2' => '/var/www/data/image_abc.jpg',
        ];
        
        $id = $_GET['fileid'];
        if (array_key_exists($id, $file_map)) {
          $filepath = $file_map[$id];
          // ファイルを読み込む処理
        } else {
          // エラー処理
        }
        ```

2.  **入力値の検証（バリデーション）**:
    やむを得ずファイル名を入力値として受け取る場合でも、その内容を厳密に検証し、想定外の文字列が含まれていればリクエストを拒否します。
    *   **ホワイトリスト方式**: 許可する文字（英数字、ドット、アンダースコアなど）のリストを定義し、それ以外の文字が少しでも含まれていたらエラーとします。 これは、危険な文字列を列挙するブラックリスト方式よりも安全です。
    *   **危険な文字列のチェック**: `../` や `..\\`, `/`, `\` などのディレクトリトラバーサルシーケンスが含まれていないかを確認し、含まれていれば処理を中断します。

3.  **パスの正規化（無害化）と検証**:
    入力値から危険な文字列を削除・置換する「無害化（サニタイゼーション）」という手法もありますが、攻撃者が巧妙な手口で回避する可能性があるため、バリデーションで拒否する方がより安全です。
    もしパスを扱う場合は、各プログラミング言語が提供するパスを正規化（絶対パスに変換し、`../`などを解決する）する関数を利用し、その結果が意図したディレクトリ配下に収まっているかを確認します。
    *   **例 (PHP)**: `realpath()`
    *   **例 (Java)**: `File.getCanonicalPath()`
    *   **検証ロジックの例**:
        ```php
        $base_dir = '/var/www/html/uploads/';
        $user_input = $_GET['filename'];
        $filepath = realpath($base_dir . $user_input); // パスを正規化
        
        // 正規化後のパスが、意図したベースディレクトリから始まっているかを確認
        if ($filepath && strpos($filepath, $base_dir) === 0) {
          // 安全なファイルパスとして処理
        } else {
          // ディレクトリトラバーサルの可能性ありとしてエラー処理
        }
        ```

#### 保険的な対策（サーバー・インフラ設定）

アプリケーションに万が一脆弱性があった場合に備え、サーバーやインフラレベルでの対策も重要です。

1.  **実行権限の最小化**:
    Webサーバーを実行するユーザーの権限を、必要最低限に設定します（最小権限の原則）。 例えば、WebサーバーのユーザーがWeb公開ディレクトリ以外のファイル（`/etc`や`/root`など）を読み取れないようにパーミッションを設定しておけば、万が一攻撃を受けても被害を限定できます。

2.  **ドキュメントルート外に機密情報を置かない**:
    設定ファイルやソースコードなど、Web経由でアクセスされるべきでないファイルは、そもそもWebサーバーの公開ディレクトリ（ドキュメントルート）の外に配置します。

3.  **WAF (Web Application Firewall) の導入**:
    WAFは、既知のディレクトリトラバーサル攻撃パターンを含む不正なリクエストを検知し、ブロックするセキュリティツールです。 根本的な解決策ではありませんが、新たな攻撃手法や未知の脆弱性に対する防御層として有効です。

4.  **定期的な脆弱性診断とソフトウェア更新**:
    使用しているWebサーバー、OS、フレームワーク、ライブラリなどに脆弱性が見つかることがあるため、定期的に脆弱性情報を収集し、セキュリティパッチを適用することが不可欠です。

---

### 6. 近年の傾向

ディレクトリトラバーサルは古典的な攻撃ですが、その手口や発生箇所は時代と共に変化しています。

*   **APIにおける脆弱性**:
    近年のWeb開発では、REST APIやGraphQLが多用されています。これらのAPIがファイル名などをパラメータとして受け取る場合、従来のWebページと同様にディレクトリトラバーサルの脆弱性が作り込まれることがあります。特にJSON形式のリクエストボディ内でファイルパスが指定されるケースなど、攻撃の対象が多様化しています。

*   **クラウドストレージ連携における脆弱性**:
    Amazon S3やGoogle Cloud Storageなどのクラウドストレージサービスと連携するアプリケーションが増えています。ユーザーからの入力をもとにこれらのストレージ上のオブジェクトキー（ファイルパスに相当）を生成する際に、適切な検証が行われていないと、意図しないバケットやオブジェクトにアクセスされる可能性があります。

*   **ライブラリやミドルウェア自体の脆弱性**:
    アプリケーション開発者が直接コードを書いた部分だけでなく、利用しているライブラリやフレームワーク、Webサーバー自体にディレクトリトラバーサルの脆弱性が発見されるケースも後を絶ちません。
    *   **事例1**: Apache HTTP Server 2.4.49の脆弱性(CVE-2021-41773)では、特定の条件下でディレクトリトラバーサルが可能となり、リモートでコードが実行される可能性も指摘されました。
    *   **事例2**: FortiGateファイアウォールのOSであるFortiOSにも、過去にディレクトリトラバーサルの脆弱性(CVE-2018-13379)が見つかっています。
    *   **事例3**: Trend Micro社のウイルスバスター コーポレートエディションにも、ファイル操作に関するディレクトリトラバーサルの脆弱性(CVE-2019-18187)が存在したことがあります。

*   **コンテナ環境におけるリスク**:
    Dockerなどのコンテナ技術が普及していますが、コンテナの設定不備（例：ホストOSのファイルシステムを不適切にコンテナ内にマウントしている）があると、コンテナ内でのディレクトリトラバーサルが、ホストOS全体のファイルシステムへのアクセスに繋がり、より深刻な被害を引き起こす可能性があります。

*   **IoTデバイス**:
    ネットワークに接続されたカメラや家電製品などのIoTデバイスのWeb管理画面に、ディレクトリトラバーサルの脆弱性が存在する事例も報告されています。 これにより、デバイスの設定情報や認証情報が漏洩するリスクがあります。

