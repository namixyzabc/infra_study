## SQLインジェクション解説
SQLインジェクションは、Webアプリケーションの脆弱性を利用した最も古典的かつ、今なお深刻な被害をもたらすサイバー攻撃の一つです。 この攻撃は、アプリケーションが予期しないSQL文をデータベースに「注入（Injection）」されることで、データベースを不正に操作されてしまうものです。

本記事では、SQLインジェクションの基本的な仕組みから、具体的な攻撃の種類、引き起こされる甚大な被害、そして最も重要な対策方法について、網羅的かつ実践的な視点で詳しく解説します。

### 1. SQLインジェクションとは何か？

多くのWebアプリケーションは、ユーザー情報や商品情報などを「データベース」に保存しています。アプリケーションは、このデータベースと「SQL」という言語を使って対話し、データの参照、追加、更新、削除などを行っています。

SQLインジェクションとは、攻撃者がWebサイトの入力フォーム（ログイン画面、検索窓、アンケートなど）に、不正なSQL文を意図的に入力することで、アプリケーション開発者が想定していないデータベース操作を引き起こす攻撃手法です。

**例えるなら：**

銀行の窓口で、正規の書類（SQL文）ではなく、不正な指示を書き加えた偽の書類（不正なSQL文）を渡し、預金を引き出そうとする行為に似ています。窓口担当者（Webアプリケーション）がその書類を疑わずに処理してしまう（脆弱性がある）と、不正な取引（データベースの不正操作）が成立してしまいます。

### 2. SQLインジェクションの仕組み

SQLインジェクションがどのように機能するのか、ログイン認証を例に見てみましょう。

**脆弱なアプリケーションの例（PHP）**

一般的なログイン処理では、ユーザーが入力したIDとパスワードを元に、データベースを検索するSQL文を組み立てます。

```php
// ユーザーが入力したIDとパスワードを取得
$userId = $_POST['userId'];
$password = $_POST['password'];

// SQL文を文字列として組み立てる（脆弱な例）
$sql = "SELECT * FROM users WHERE user_id = '" . $userId . "' AND password = '" . $password . "'";

// SQLを実行し、結果を取得
$result = $db->query($sql);

if ($result->num_rows > 0) {
    // ログイン成功
} else {
    // ログイン失敗
}
```

このコードでは、ユーザーが入力した `$userId` と `$password` を直接文字列として連結してSQL文を作成しています。これが脆弱性の原因となります。

**攻撃の実行**

攻撃者は、この仕組みを悪用し、次のような値を入力します。

*   **ユーザーID:** `admin' --`
*   **パスワード:** （空欄）

この入力により、アプリケーション内部で組み立てられるSQL文は次のようになります。

```sql
SELECT * FROM users WHERE user_id = 'admin' --' AND password = ''```

SQLでは「`--`」以降はコメントとして扱われ、実行時に無視されます。 そのため、実際にデータベースで実行されるSQL文は以下の部分だけになります。

```sql
SELECT * FROM users WHERE user_id = 'admin'
```

結果として、パスワードのチェック部分（`AND password = ...`）が無効化され、`user_id` が `admin` であるという条件だけで認証が成功してしまいます。 これにより、攻撃者は管理者権限を不正に奪取できてしまうのです。

### 3. SQLインジェクションの多様な種類

SQLインジェクションは、その手口や目的によっていくつかの種類に分類されます。

#### 3.1. インバンドSQLインジェクション (In-band SQLi)

攻撃と結果の取得を同じ通信チャネルで行う、最も直接的で一般的な手法です。

*   **エラーベースSQLインジェクション**: 意図的に不正なSQL文を送信してデータベースエラーを発生させ、そのエラーメッセージからデータベースの構造（テーブル名、カラム名など）や脆弱性の情報を探る手口です。 これ自体で直接データを盗むわけではなく、本格的な攻撃のための偵察として利用されます。

*   **UNIONベースSQLインジェクション**: SQLの `UNION` 演算子を悪用し、本来のクエリ結果に加えて、攻撃者が指定した別のテーブルの情報を結合させて窃取する手法です。 例えば、商品検索の結果に、ユーザー情報のテーブルを不正に結合させ、個人情報を一覧で盗み出すことが可能です。

#### 3.2. ブラインドSQLインジェクション (Blind SQLi)

エラーメッセージやデータそのものが直接返ってこない場合に用いられる、より高度な手法です。 データベースからの応答の「真偽」や「応答時間」の違いを手がかりに、少しずつ情報を盗み出します。

*   **ブール値ベース・ブラインドSQLインジェクション**: 条件が真（True）の時と偽（False）の時で、ページの表示内容が僅かに異なることを利用します。「ユーザー名の1文字目は 'a' か？」「'b' か？」といったクエリを大量に送り、その応答の違いから一文字ずつデータを特定していきます。

*   **時間差攻撃ベース・ブラインドSQLインジェクション**: データベースに意図的に時間を遅延させる命令（例：`WAITFOR DELAY '0:0:5'`）を注入します。条件が真の場合にだけ処理が遅延するように仕込み、「応答が5秒遅れたら、条件は真である」と判断することで情報を特定します。

#### 3.3. アウトオブバンドSQLインジェクション (Out-of-band SQLi)

Webアプリケーションの通信チャネルとは別に、外部のサーバー（DNSサーバーやHTTPサーバーなど）へデータを送信させる手法です。 サーバーのファイアウォール設定が甘い場合などに利用される、特殊な攻撃です。

#### 3.4. セカンドオーダーSQLインジェクション (Second-order SQLi)

一度データベースに保存された悪意のある入力値が、後から別の処理で呼び出されて実行されるという、時間差攻撃の一種です。 例えば、ユーザー登録時に無害に見える文字列（内部にSQL文を隠し持つ）を登録させ、後でそのユーザー情報がプロファイルページなどで表示される際に、隠されていたSQL文が実行される、といった手口です。

### 4. SQLインジェクションが引き起こす深刻な被害

SQLインジェクション攻撃が成功すると、企業や組織は壊滅的な被害を受ける可能性があります。

*   **情報漏洩**: 最も代表的な被害であり、顧客の個人情報（氏名、住所、電話番号）、クレジットカード情報、企業の機密情報などが大量に流出する可能性があります。 盗まれた情報は、不正利用やブラックマーケットでの売買など、二次被害につながります。
*   **データの改ざん・破壊**: データベース内のデータが不正に書き換えられたり、削除されたりします。 これにより、Webサイトのコンテンツが改ざんされたり、重要な業務データが失われたりする可能性があります。
*   **システムの乗っ取り・不正操作**: 認証を回避して管理者としてシステムにログインされ、システムを完全に制御される可能性があります。 乗っ取られたサーバーは、他のシステムへの攻撃の踏み台として悪用されることもあります。
*   **サービス停止 (DoS)**: データベースに高負荷をかけるSQL文を意図的に実行され、Webサービスが停止に追い込まれることがあります。
*   **マルウェア感染の踏み台**: Webサイトを改ざんし、閲覧したユーザーをマルウェアに感染させるためのコードを埋め込まれるケースもあります。

**実際の被害事例**

過去には国内外で数多くのSQLインジェクションによる被害が発生しています。

*   **事務用品ECサイトからの情報流出**: SQLインジェクション攻撃により、最大で約12万件の顧客情報（クレジットカード情報を含む）が流出した可能性があると発表されました。
*   **市場調査会社の会員サイトからの情報流出**: SQLインジェクションの被害により、会員のメールアドレスとパスワードが10万件単位で漏洩した可能性があると報告されています。
*   **子ども向け会員サイトからのメールアドレス流出**: SQLインジェクション攻撃を受け、数万件のメールアドレスが流出した事例も報告されています。

これらの事例は、SQLインジェクションが企業規模や業種を問わず、深刻な経営リスクであることを示しています。

### 5. SQLインジェクションへの具体的な対策手順

SQLインジェクションを防ぐためには、複数の対策を組み合わせた多層防御が不可欠です。

#### 5.1. 根本的対策：セキュアな実装

攻撃の根本原因はアプリケーションの脆弱性にあるため、開発段階でのセキュアな実装が最も重要です。

##### **最重要対策：プレースホルダ（プリペアードステートメント）の使用**

プレースホルダは、SQLインジェクション対策における「銀の弾丸」とも言える最も効果的で推奨される方法です。

これは、SQL文の「骨格（テンプレート）」と、そこにはめ込む「値（パラメータ）」を別々にデータベースへ送る仕組みです。 データベース側で「値」はあくまでデータとして扱われ、SQL文の一部として解釈されることがないため、攻撃が無効化されます。

**脆弱なコード（再掲）:**
```php
$sql = "SELECT * FROM users WHERE user_id = '" . $userId . "' AND password = '" . $password . "'";
```

**プレースホルダを使用した安全なコード（PHP PDOの例）:**
```php
// 1. SQL文のテンプレートを準備（値の部分を '?' にする）
$sql = "SELECT * FROM users WHERE user_id = ? AND password = ?";
$stmt = $pdo->prepare($sql);

// 2. テンプレートに値を紐付け（バインド）する
$stmt->bindValue(1, $userId);
$stmt->bindValue(2, $password);

// 3. SQL文を実行する
$stmt->execute();
$result = $stmt->fetchAll();
```
このように、値が後から安全な方法で「バインド」されるため、入力値にSQL文が含まれていても、それは単なる文字列として扱われ、攻撃にはつながりません。

##### **次善の策：エスケープ処理**

やむを得ずプレースホルダが使用できない環境では、エスケープ処理が次善の策となります。 これは、SQL文で特別な意味を持つ文字（例: `'`、`"`、`\` など）を、無害な別の文字列に変換する処理です。

ただし、エスケープ処理は実装が複雑で、対象文字の漏れや、データベースの種類による方言など、考慮すべき点が多く、ミスが発生しやすいという大きな欠点を抱えています。基本的にはプレースホルダの利用を第一に検討すべきです。

#### 5.2. 保険的対策：多層防御

セキュアな実装を基本としつつ、万が一の脆弱性に備えて複数の防御壁を設けることが重要です。

*   **WAF (Web Application Firewall) の導入**: WAFは、Webアプリケーションへの通信を監視し、SQLインジェクションを含む不正な攻撃パターンを検知・ブロックするセキュリティ製品です。 既存のアプリケーションに手を加えることなく、迅速に防御レベルを高めることができます。ただし、WAFは全ての攻撃を防げるわけではなく、未知の攻撃や巧妙な攻撃をすり抜ける可能性もあるため、根本対策と組み合わせることが前提です。

*   **入力値の検証（バリデーション）**: ユーザーからの入力値が、想定されるデータ型、文字数、フォーマット（メールアドレス形式など）に合致しているかを厳密にチェックします。これにより、明らかに不正な入力値を早い段階で弾くことができます。

*   **データベースアカウントの権限最小化**: Webアプリケーションがデータベースに接続する際に使用するアカウントの権限を、必要最低限（例：特定のテーブルへの参照権限のみ）に絞ります。 これにより、万が一インジェクション攻撃が成功しても、データベースの全削除や他テーブルへのアクセスといった被害を最小限に抑えることができます。

*   **詳細なエラーメッセージの非表示**: エラーベースSQLインジェクションで見たように、詳細なエラーメッセージは攻撃者に多くのヒントを与えてしまいます。 本番環境では、ユーザーには汎用的なエラーメッセージのみを表示し、詳細なエラー内容はサーバーの内部ログにのみ記録するように設定すべきです。

### 6. 近年のSQLインジェクションの傾向と新たな脅威

SQLインジェクションは古い攻撃手法ですが、その手口は進化し続けており、依然として主要な脅威です。 2023年第1四半期の調査では、前年同期比で攻撃数が150%増加したという報告もあります。

*   **攻撃の自動化**: `sqlmap` に代表される攻撃ツールが高度化し、脆弱性の発見から情報の窃取までを自動で行うことが容易になっています。 これにより、専門知識のない攻撃者でも容易に攻撃を実行できるようになりました。

*   **NoSQLインジェクション**: 近年利用が増えているMongoDBなどのNoSQLデータベースも、SQLインジェクションと同様の脅威に晒されています。 NoSQLはSQLとは異なるクエリ言語や構造を持ちますが、ユーザー入力を適切に処理しなければ、同様に不正な操作を許してしまいます。

*   **ORM (Object-Relational Mapping) に起因する脆弱性**: ORMライブラリは、オブジェクト指向言語でデータベースを容易に扱うための便利なツールですが、その仕組みを理解せずに不適切な使い方をすると、内部で脆弱なクエリが生成され、インジェクションの標的となることがあります。

*   **API経由の攻撃**: スマートフォンアプリやIoTデバイスのバックエンドとして利用されるWeb API（REST APIなど）が、新たな攻撃対象として増加しています。 これらのAPIが適切なセキュリティ対策なしに公開されていると、SQLインジェクションの格好の標的となります。

### 7. まとめ

SQLインジェクションは、Webアプリケーション開発において決して軽視できない基本的な脆弱性です。その被害は情報漏洩にとどまらず、企業の社会的信用の失墜や事業継続の危機にまで発展する可能性があります。

この脅威からシステムを守るためには、以下の点を徹底することが不可欠です。

1.  **プレースホルダの利用を絶対的な原則とする。**
2.  **WAFや入力値検証など、多層的な防御策を講じる。**
3.  **データベースアカウントの権限を最小化する。**
4.  **NoSQLインジェクションなど、新たな脅威についても継続的に情報を収集し、対策を行う。**

