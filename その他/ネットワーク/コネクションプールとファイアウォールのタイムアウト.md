# コネクションプールとファイアウォールのタイムアウトについて

## 1. コネクションプールの未使用タイムアウト

### 概要
データベース接続などを再利用するために保管しておく「接続の在庫」に対する時間制限です。

### 仕組み
```
アプリケーション
    ↓
[コネクションプール]
 ├─ 接続1 (使用中)
 ├─ 接続2 (待機中) ← 一定時間使われないと破棄
 └─ 接続3 (待機中)
    ↓
データベース
```

### 目的
- **リソースの無駄を防ぐ**: 使われない接続を保持し続けない
- **古い接続の排除**: 長時間放置された不安定な接続を削除
- **メモリ効率**: 不要な接続情報を解放

### 実例
```java
// 設定例
maxIdleTime = 300秒  // 5分間未使用なら破棄
```

---

## 2. ファイアウォールの無通信タイムアウト

### 概要
ファイアウォールが「通信がない接続」を自動的に切断する仕組みです。

### 仕組み
```
クライアント ←→ [ファイアウォール] ←→ サーバー
                    ↓
              通信状態を監視
              (60秒間何もなし)
                    ↓
              「もう終わった」と判断
                    ↓
              接続情報を削除
```

### 目的
- **セキュリティ**: 放置された接続経路を閉じる
- **リソース管理**: 接続テーブルの容量を節約
- **不正利用防止**: 乗っ取られた接続を自動切断

### 典型的な値
- **一般的なファイアウォール**: 60〜300秒
- **NAT機器**: 30〜60秒程度
- **クラウド環境**: 50〜350秒

---

## よくある問題と対策

### 問題のシナリオ
```
1. アプリがDBと接続確立
2. コネクションプールに保管(5分間保持設定)
3. ファイアウォールは60秒で切断
   ↓
4. 2分後、アプリがその接続を再利用しようとする
   → エラー！(実際は切断済み)
```

### 対策

| 対策方法 | 説明 |
|---------|------|
| **タイムアウト値の調整** | プールのタイムアウト < ファイアウォールのタイムアウト |
| **Keep-Alive送信** | 定期的に小さなパケットを送って「生存確認」 |
| **接続の検証** | 使用前に接続が有効か確認する |

### 設定例
```
ファイアウォールタイムアウト: 60秒
         ↓
コネクションプール設定: 50秒 (余裕を持たせる)
Keep-Alive間隔: 30秒 (さらに安全)
```

---

## まとめ

- **コネクションプール**: アプリ側の「使わない接続を捨てる」仕組み
- **ファイアウォール**: ネットワーク側の「通信がない接続を切る」仕組み

**重要**: 両者のタイムアウト値が不一致だとエラーが発生するため、連携して設定する必要があります。
