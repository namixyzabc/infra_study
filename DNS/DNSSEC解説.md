### DNSSECの仕組みと信頼の連鎖

DNSSEC（DNS Security Extensions）は、DNS応答の正当性を保証するための拡張機能です。インターネット利用者がドメイン名からIPアドレスを取得する際に、その応答が改ざんされていない「本物」であることを確認できます。これにより、DNSキャッシュポイズニングなどの攻撃を防ぎ、インターネットの安全性を高めます。

---

### 1. なぜDNSSECが必要か？

DNSは、私たちが「www.example.com」のようなドメイン名でウェブサイトにアクセスできるように、そのドメイン名に対応するIPアドレス（例: 192.0.2.1）を教えてくれる、インターネットの住所録のようなシステムです。

しかし、**通常のDNSには、応答が本当に正しいサーバーから送られてきたものか、途中で改ざんされていないかを確認する仕組みがありませんでした。** この脆弱性を悪用するのが「DNSキャッシュポイズニング」などの攻撃です。攻撃者はDNSサーバーに偽の情報を送り込み、利用者を偽のウェブサイトに誘導して個人情報を盗んだり、マルウェアに感染させたりします。

DNSSECは、この問題を解決するために開発されました。公開鍵暗号方式を利用した「デジタル署名」をDNS応答に付与することで、以下の2点を保証します。

*   **出自の証明**: 応答が正当な管理者から送られてきたこと。
*   **完全性**: 応答データが途中で改ざんされていないこと。

---

### 2. DNSSECの基本的な仕組み

DNSSECは、「デジタル署名」を用いてDNS応答の正しさを検証します。その中心的な役割を担うのが、新たに追加されたDNSレコードです。

#### **DNSSECで使われる主要なDNSレコード**

*   **DNSKEY (DNS Public Key)**
    *   ゾーンの署名に使われる公開鍵の情報を格納するレコードです。
    *   後述する**KSK（鍵署名鍵）**と**ZSK（ゾーン署名鍵）**の2種類の鍵があります。

*   **RRSIG (Resource Record Signature)**
    *   AレコードやMXレコードといったDNSレコードセット（RRset）に対するデジタル署名そのものを格納します。
    *   DNSリゾルバは、このRRSIGとDNSKEYを使って署名を検証します。

*   **DS (Delegation Signer)**
    *   **「信頼の連鎖」を構築するための最も重要なレコード**です。
    *   子ゾーンのDNSKEYレコード（正確にはKSK）のハッシュ値を格納し、親ゾーンに登録されます。これにより、親ゾーンが子ゾーンの鍵の正しさを保証します。

*   **NSEC / NSEC3 (Next Secure)**
    *   問い合わせたドメイン名が**「存在しない」ことを証明するため**のレコードです。
    *   これにより、「そのドメインは存在しません」という応答（否定応答）が偽造されていないことを保証できます。

---

### 3. 信頼の連鎖 (Chain of Trust)

DNSSECの信頼性は、DNSの階層構造を利用した「**信頼の連鎖**」によって担保されています。 これは、一つ上の階層（親ゾーン）が一つ下の階層（子ゾーン）の正しさを証明する、という関係がルートゾーンを頂点として連続的につながっている状態を指します。

#### **検証プロセスの流れ**

1.  **信頼の起点（トラストアンカー）**
    *   信頼の連鎖の出発点は、インターネットの階層構造の頂点である「ルートゾーン」です。
    *   DNSリゾルバ（例: Google Public DNSの8.8.8.8など）には、このルートゾーンの公開鍵（KSK）があらかじめ「信頼できるもの」として設定されています。これを**トラストアンカー**と呼びます。

2.  **親ゾーンによる子ゾーンの保証**
    *   あるゾーン（例: `example.jp`）は、自身のKSK（鍵署名鍵）から生成したハッシュ値を**DSレコード**として、親ゾーン（この場合は `.jp`）に登録します。
    *   親ゾーンである`.jp`は、そのDSレコードに自身の秘密鍵で署名します。

3.  **DNSリゾルバによる検証**
    *   ユーザーが `www.example.jp` にアクセスしようとすると、DNSリゾルバは `www.example.jp` のIPアドレス（Aレコード）と、その署名（RRSIGレコード）を受け取ります。
    *   リゾルバは `example.jp` のDNSKEYレコード（公開鍵）を取得し、Aレコードの署名を検証します。
    *   次に、そのDNSKEYレコード自体が信頼できるかを確認するため、親ゾーンである `.jp` に `example.jp` のDSレコードを問い合わせます。
    *   リゾルバは、取得した `example.jp` のDNSKEYレコードをハッシュ化し、親の `.jp` ゾーンが持つDSレコードの値と一致するかを比較します。
    *   一致すれば、`example.jp` の鍵は正当であると確認できます。
    *   この検証作業を、`.jp` からルートゾーンへと、トラストアンカーにたどり着くまで再帰的に繰り返します。

この階層的な検証により、ルートから目的のドメインまで信頼が鎖のようにつながり、最終的にDNS応答全体の正当性が保証されるのです。

---

### 4. 2種類の鍵：KSKとZSK

DNSSECでは、セキュリティと運用効率の観点から、役割の異なる2種類の鍵を使い分けることが一般的です。

*   **KSK (Key Signing Key / 鍵署名鍵)**
    *   **役割**: ZSKを含むDNSKEYレコードセットに署名し、**信頼の連鎖を構築する**ために使われます。
    *   **特徴**: 親ゾーンにDSレコードとして登録されるため、更新には手間がかかります。そのため、より長く強力な鍵が使われ、更新頻度は低く設定されます（例: 1年に1回）。

*   **ZSK (Zone Signing Key / ゾーン署名鍵)**
    *   **役割**: AレコードやMXレコードなど、ゾーン内の個々のレコードセットに署名するために使われます。
    *   **特徴**: ゾーン内のレコードは頻繁に更新される可能性があるため、ZSKもそれに合わせて頻繁に更新されます。KSKに比べて鍵長は短く、更新作業もゾーン内で完結するため効率的です。

この2段階の鍵構造により、日常的なレコードの署名（ZSK）と、信頼の連鎖を維持するための重要な署名（KSK）の運用負荷を分離し、安全かつ効率的な鍵管理を実現しています。

---

### 5. 「存在しないこと」の証明

DNSSECは、レコードが「存在する」ことだけでなく、「存在しない」こと（NXDOMAIN）も証明できます。 これには**NSEC**または**NSEC3**レコードが使われます。

*   **NSEC (Next Secure)**
    *   ゾーン内のドメイン名を辞書順に並べ、隣り合うドメイン名を指し示すことで、「問い合わせのあったドメイン名はこの間には存在しない」ということを証明します。
    *   **課題**: NSECレコードをたどることで、そのゾーンに存在する全てのドメイン名をリストアップできてしまう「**ゾーンウォーキング**」という問題がありました。

*   **NSEC3 (Next Secure version 3)**
    *   ゾーンウォーキングの問題を解決するために開発されました。
    *   ドメイン名をそのまま記録する代わりに、**ドメイン名のハッシュ値**を使ってチェーンを構築します。 これにより、元のドメイン名を簡単に推測できなくなり、ゾーンの内容が秘匿されます。

---

### 6. 実践例：`dig`コマンドによる確認

`dig`コマンドを使うと、DNSSECに関連するレコードを実際に確認できます。`+dnssec`オプションを付けて実行すると、RRSIGレコードなどが表示されます。

```bash
# jprs.jpのAレコードと、その署名(RRSIG)を取得する
$ dig jprs.jp A +dnssec
```

このコマンドを実行すると、通常のAレコードに加えて、`RRSIG`レコードも表示されます。

また、DNSSECの検証に対応したリゾルバ（例: 8.8.8.8）に問い合わせると、応答ヘッダに `ad` (Authenticated Data) フラグが付与されます。このフラグは、リゾルバがDNSSECの検証に成功し、その応答が正当なものであることを証明しています。

```bash
# Google Public DNSに問い合わせ、adフラグを確認する
$ dig www.iij.ad.jp @8.8.8.8 +dnssec

; <<>> DiG 9.16.1-Ubuntu <<>> www.iij.ad.jp @8.8.8.8 +dnssec
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 12345
;; flags: qr rd ra ad; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1
                     ^^  <- adフラグが立っている
```

もしDNSSECの検証に失敗した場合、リゾルバは `SERVFAIL` というエラーを返し、偽のサイトへのアクセスを防ぎます。



---





### 7. DNSSECが有効なゾーンファイルの例

ここでは、`example.jp`というドメインのゾーンファイルを例に、DNSSEC関連のレコードがどのように記述されるかを示します。

実際のゾーンファイルは、署名鍵（特にZSK）の定期的な更新（ロールオーバー）により自動生成されることが多く、非常に長大になります。以下の例は、主要なレコードを抜き出して簡略化したものです。

**ゾーンファイル: `db.example.jp`**

```dns
; ドメインの基本情報 (Start of Authority)
$TTL 3600
@   IN SOA  ns1.example.jp. hostmaster.example.jp. (
            2023040101 ; Serial
            7200       ; Refresh
            3600       ; Retry
            1209600    ; Expire
            3600 )     ; Minimum TTL

; ネームサーバー情報
@   IN NS    ns1.example.jp.
@   IN NS    ns2.example.jp.

; --- ここからDNSSEC関連レコード ---

; ◆ DNSKEYレコード (公開鍵)
; 257はKSK(鍵署名鍵)、256はZSK(ゾーン署名鍵)を示すフラグ
; アルゴリズム13はECDSA P-256 with SHA-256
example.jp. 3600 IN DNSKEY 257 3 13 (
            AbCdEfGhIjKlMnOpQrStUvWxYz1234567890AbCdEfGh
            IjKlMnOpQrStUvWxYz1234567890AbCdEfGhIjKlMnOp
            QrStUvWxYz=
            ) ; KSK (Key Signing Key) - 鍵タグ: 12345

example.jp. 3600 IN DNSKEY 256 3 13 (
            aBcDeFgHiJkLmNoPqRsTuVwXyZ0987654321aBcDeFgHi
            JkLmNoPqRsTuVwXyZ0987654321aBcDeFgHiJkLmNoPq
            RsTuVwXyZ=
            ) ; ZSK (Zone Signing Key) - 鍵タグ: 54321

; ◆ RRSIGレコード (DNSKEYレコードセットに対する署名)
; KSK(鍵タグ12345)を使って、このゾーンのDNSKEYレコードセット全体に署名している
example.jp. 3600 IN RRSIG DNSKEY 13 2 3600 20250830... 20250730... 12345 example.jp. (
            (署名データ...)
            )

; --- 通常のDNSレコードと、その署名 ---

; ◆ Aレコード (WebサーバーのIPアドレス)
www IN A 192.0.2.1

; ◆ RRSIGレコード (Aレコードに対する署名)
; ZSK(鍵タグ54321)を使って、wwwのAレコードに署名している
www.example.jp. 3600 IN RRSIG A 13 3 3600 20250830... 20250730... 54321 example.jp. (
            (署名データ...)
            )

; ◆ MXレコード (メールサーバー)
@   IN MX 10 mail.example.jp.

; ◆ RRSIGレコード (MXレコードに対する署名)
; ZSK(鍵タグ54321)を使って、MXレコードに署名している
example.jp. 3600 IN RRSIG MX 13 2 3600 20250830... 20250730... 54321 example.jp. (
            (署名データ...)
            )

; ◆ NSEC3レコード (存在しないことの証明用)
; (ハッシュ化されたドメイン名) IN NSEC3 1 1 12 aabbccdd (次のハッシュ) A NS SOA MX TXT AAAA RRSIG DNSKEY NSEC3PARAM
; ... NSEC3レコードが続く ...
```

#### **レコードの解説**

*   **DNSKEYレコード**:
    *   このゾーンで利用する公開鍵を宣言します。
    *   **KSK (フラグ 257)** は、このゾーンの鍵セット全体を署名し、親ゾーンに登録されるDSレコードの元となる、より重要な鍵です。
    *   **ZSK (フラグ 256)** は、AレコードやMXレコードといった日常的なレコードに署名するための鍵です。

*   **RRSIGレコード**:
    *   「どのレコードを」「どの鍵で」署名したかを示すレコードです。
    *   `RRSIG DNSKEY ... 12345` は、「DNSKEYレコードセットを、鍵タグが12345の鍵（この例ではKSK）で署名しました」という意味です。
    *   `RRSIG A ... 54321` は、「wwwのAレコードを、鍵タグが54321の鍵（この例ではZSK）で署名しました」という意味になります。

*   **NSEC3レコード**:
    *   この例ではNSEC3を使用しています。ドメイン名をハッシュ化したものが並び、「問い合わせのあったドメインが存在しないこと」を証明する際に使われます。

---

### 親ゾーンに登録されるDSレコードの例

上記のゾーンファイルだけでは信頼の連鎖は完成しません。親ゾーン（この例では `.jp` ゾーン）に、`example.jp` のKSKに対応する **DS (Delegation Signer) レコード** を登録する必要があります。

DSレコードは、子ゾーンのKSK（鍵署名鍵）のハッシュ値から生成されます。

```dns
; .jpゾーン側で管理されるレコード
example.jp. IN DS 12345 13 2 (
            fedcba9876543210fedcba9876543210fedcba9876543210fedcba987654
            )
```

#### **DSレコードの解説**

*   `12345`: **鍵タグ (Key Tag)**。どのKSKに対応するDSレコードかを示す番号です。`example.jp` ゾーンのKSKの鍵タグと一致します。
*   `13`: **アルゴリズム (Algorithm)**。KSKと同じアルゴリズム番号です。
*   `2`: **ダイジェストタイプ (Digest Type)**。ハッシュ値を生成したアルゴリズム（この場合はSHA-256）を示します。
*   `( ... )`: **ダイジェスト (Digest)**。`example.jp` のKSKをハッシュ化した値そのものです。

DNSリゾルバは、`.jp` ゾーンからこのDSレコードを取得し、`example.jp` ゾーンから取得したKSKを同じ方法でハッシュ化します。2つのハッシュ値が一致すれば、「`.jp` ゾーンが `example.jp` のKSKの正しさを保証している」と判断でき、信頼の連鎖がつながります。
