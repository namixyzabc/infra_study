

# AWSコスト最適化

## 1. 徹底的な可視化と説明責任 (Measurement & Accountability)

費用と利用状況を透明化し、誰が・何のために・どれだけリソースを使用しているかの「説明責任」を確立します。

### 主要な取り組みと実践テクニック

1.  **アカウント戦略とガバナンス**
    *   **解説:** **AWS Control Tower** を用いたランディングゾーンを整備し、環境（Dev/Stg/Prod）ごとにアカウントを分割します。
    *   **✅ 具体的な設定例:**
        *   **OU（組織単位）設計:** `Security`, `Infrastructure`, `Workloads` (Prod/Non-Prod) という階層を作成。
        *   **SCP (Service Control Policies):** 「特定の高額なリージョン（例：南米）でのリソース作成を禁止する」ポリシーをルートレベルで適用し、意図しない海外リージョンへのデプロイを防ぐ。
    *   **🚫 アンチパターン:**
        *   **「巨大なシングルアカウント」:** 本番環境も開発環境も1つのAWSアカウントに混在させる。
        *   **リスク:** タグ付け漏れが発生した瞬間に、そのコストが「開発の実験」なのか「本番の負荷増」なのか判別不能になり、コスト削減の意思決定が麻痺する。

2.  **コスト配分タグによる粒度向上**
    *   **解説:** 技術的属性だけでなくビジネス属性のタグ付けを強制します。
    *   **✅ 具体的な設定例:**
        *   **必須タグ:** `CostCenter` (部門コード), `Env` (Prd/Dev), `Owner` (メールアドレス), `ApplicationID`.
        *   **AWS Tag Policies:** タグキーの大文字小文字（例: `cost-center` と `CostCenter`）の揺らぎを禁止し、特定の値をリストから選択させる設定を強制する。
    *   **🚫 アンチパターン:**
        *   **「その他（Misc）タグの乱用」:** とりあえず `Project: Misc` と付けて放置する。結果として、誰もオーナーシップを持たない「不明コスト」が肥大化する。

3.  **高度な分析ツールの活用**
    *   **AWS Cost Explorer & CUR:** **AWS Cost and Usage Report (CUR)** をS3に出力し、Athena/QuickSightで分析します。

---

## 2. リソース効率化 (Resource Efficiency)

アーキテクチャの大幅な変更なしに、リソース選定や購入方法の見直しで即効性のある削減を実現します。

### 主要なアプローチと実践テクニック

1.  **最新世代・最適プロセッサへの移行**
    *   **解説:** x86ベースからARMベースの **AWS Graviton** プロセッサへ移行します。
    *   **✅ 具体的な設定例:**
        *   **RDS/ElastiCache:** マネージドサービスのため、インスタンスタイプの変更（適用時に再起動）のみで移行可能。
        *   **EC2/Container:** **【重要】** OSやライブラリの互換性確認が必要。ARM互換のAMIへの差し替えや、コンテナイメージのマルチアーキテクチャビルドを行った上で移行する。
        *   **効果:** 同スペック比でコストは約10〜20%低下し、パフォーマンスは最大40%向上するケースが多い。

2.  **ストレージの自動最適化 (EBS & S3)**
    *   **解説:** EBSボリュームタイプとS3ストレージクラスを最適化します。
    *   **✅ 具体的な設定例:**
        *   **EBS gp3移行:** 既存の `gp2` ボリュームを `gp3` に変更する。`gp3` は `gp2` より最大20%安価で、かつ容量を増やさずにIOPSとスループットを独立して設定可能。
        *   **S3 Intelligent-Tiering:** ライフサイクルルールで「作成後0日」でIntelligent-Tieringへ移行するように設定。アクセス頻度が下がれば自動的に安価なティアへ落ちる仕組みにする。（※128KB未満のオブジェクトは自動階層化の対象外となるため、小容量ファイルが大量にある場合は注意）。
    *   **🚫 アンチパターン:**
        *   **「ゾンビEBS」:** EC2インスタンスをTerminate（削除）したが、紐付いていたEBSボリュームの「終了時に削除」フラグがオフになっており、ボリュームだけが課金され続けている状態。
        *   **「無制限なスナップショット」:** 古いEBSスナップショットを数年分保持し続けている（Data Lifecycle Managerで世代管理をすべき）。

3.  **スポットインスタンスの活用**
    *   **解説:** AWSの余剰リソースを利用する **Spot Instances** を活用し、ステートレスなワークロードを大幅に安く（最大90%OFF）運用します。
    *   **✅ 具体的な設定例:**
        *   **EKS/ECS/Batch:** 開発環境の全リソースや、本番環境のWebサーバー群の一部にSpotを採用する。
        *   **リスクヘッジ:** 「中断（Rebalance）」に備え、Auto Scaling Groupで複数のインスタンスタイプを指定しておく（Attribute-based Instance Type Selectionの活用）。

4.  **購入モデルの戦略的選択**
    *   **解説:** Compute Savings Plans (CSP) をベースロードに適用します。
    *   **🚫 アンチパターン:**
        *   **「カバレッジ100%を目指す」:** ピーク時のリソース量に合わせてRI/SPを購入してしまう。
        *   **リスク:** 夜間や休日、あるいはトラフィック減少時にコミット過多となり、逆に無駄なコストが発生する。カバレッジは「常に稼働している最低ライン（ベースロード）」に合わせるのが鉄則。

---

## 3. アーキテクチャの近代化 (Architectural Modernization)

クラウドネイティブな設計により、TCO削減とアジリティ向上を達成します。

### 主要なアプローチと実践テクニック

1.  **ネットワークとデータ転送の最適化**
    *   **解説:** インターネット経由の通信を内部通信へ切り替えます。
    *   **✅ 具体的な設定例:**
        *   **S3 Gateway Endpoint:** プライベートサブネットのEC2からS3へデータを送る際、NAT Gatewayを経由させるとデータ処理料がかかる。これを無料の **VPC Endpoint (Gateway型)** に切り替える。
    *   **🚫 アンチパターン:**
        *   **「NAT Gatewayの罠」:** ログ転送や大量の画像処理などで、ギガバイト単位のデータをNAT Gateway経由でS3やDynamoDBに送っている。通信料に加え、NAT Gatewayの処理料金（$0.045/GB〜）が二重にかかる。

2.  **サーバーレスとマネージドサービスの採用**
    *   **解説:** EC2上のDBをAmazon RDS/Auroraへ、常時稼働サーバーをLambdaへ移行します。
    *   **✅ 具体的な設定例:**
        *   **開発環境のAurora Serverless v2:** ACU（容量単位）の下限を0.5（最小）に設定することで、非稼働時のコストを月額数千円程度（$45〜）に抑える。
        *   **完全停止:** コストを完全にゼロにしたい期間（長期休暇など）は、Serverless v2であっても「一時停止（7日間）」を行うか、Provisionedインスタンスの停止機能を活用する。

---

## 4. 予測と計画 (Planning & Forecasting)

ビジネス成長に伴う変動を予測し、予算超過を未然に防ぎます。

### 主要なアプローチと実践テクニック

1.  **予算アクションの自動化**
    *   **解説:** **AWS Budgets** でのアラートに加え、アクションを設定します。
    *   **✅ 具体的な設定例:**
        *   **開発環境の強制停止:** 「開発環境用予算（例: $1,000）の100%に到達したら、対象のEC2インスタンスやRDSを自動的にStopする」IAMロールとアクションをBudgetsに紐付ける。
    *   **🚫 アンチパターン:**
        *   **「オオカミ少年アラート」:** 予算アラートの閾値を低くしすぎて毎日通知が来る状態。結果、誰もメールを見なくなり、本当に危険なスパイク（AWSアカウント乗っ取りなどによる急増）を見逃す。

---

## 5. Cloud FinOpsの実践と文化醸成

### FinOps推進体制とプロセス

1.  **ユニットエコノミクスの追求**
    *   **解説:** 総額ではなく「単位あたりの経済性」をKPIにします。
    *   **✅ 具体的な設定例（KPI計算式）:**
        *   **ECサイトの場合:** `AWS月額費用 ÷ 月間アクティブユーザー数 (MAU)` または `AWS月額費用 ÷ 注文完了件数`。
        *   **SaaSの場合:** `1テナントあたりの平均インフラ原価`。
    *   **目的:** 「AWSコストが先月より100万円増えたが、ユーザー数は2倍になったので、1ユーザーあたりのコストは20%下がった（＝健全な成長）」という判断を可能にする。

2.  **ショーバックとチャージバック**
    *   **解説:** 共通費用（例: Direct Connect利用料やEnterprise Support費用）を配賦します。
    *   **✅ 具体的な設定例:**
        *   共通費用を「各部門のAWS利用額の比率」に応じて按分し、月次の社内請求書に上乗せして通知する。

---

### まとめ

コスト最適化は「一度設定して終わり」ではありません。

1.  **可視化:** 不明なコストをタグ付けで撲滅する。
2.  **効率化:** `gp3` や `Graviton`、`Spot Instances` を積極的に採用する。
3.  **近代化:** NAT Gatewayを削除し、VPC Endpointにする。
4.  **文化:** ユニットエコノミクスでビジネス判断を行う。

このサイクルを回し続けることこそが重要です。
