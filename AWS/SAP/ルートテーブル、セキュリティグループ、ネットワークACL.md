以下は、AWS VPCにおける`ルートテーブル`、`セキュリティグループ`、`ネットワークACL`の用途や違いを網羅的に比較した表です。

| 観点 | `ルートテーブル` | `セキュリティグループ` | `ネットワークACL` |
|---|---|---|---|
| 主な役割 | 宛先CIDRに基づく次ホップ選択（経路制御） | ENI（ネットワークインタフェース）単位のステートフル許可リスト | サブネット境界のステートレスL3/L4フィルタ |
| 適用スコープ/関連付け | `サブネット`に関連付け（メイン`ルートテーブル`あり）。一部`ゲートウェイエンドポイント`用の関連付けも | `ENI`にアタッチ（`EC2`、`RDS`、`ALB`、`EFS`マウントターゲット、`Lambda`のVPC ENI など） | `サブネット`に1つ関連付け（サブネット内すべてのENIに影響） |
| 処理レイヤ | L3 ルーティング（最長一致） | L3/L4 ステートフル検査 | L3/L4 ステートレス検査 |
| ステートフル性 | なし（状態管理しない） | あり（戻りトラフィックは自動許可） | なし（戻りも明示的に許可が必要） |
| 方向（イン/アウト） | 区別なし（経路は双方向で有効だが設定は宛先ベース） | `Inbound`/`Outbound`を別々に定義 | `Inbound`/`Outbound`を別々に定義 |
| 許可/拒否 | 拒否の概念なし（次ホップ未到達で実質ドロップ＝ブラックホール） | 許可のみ（拒否ルールなし、暗黙の拒否） | 許可・拒否の両方が定義可能 |
| 既定の挙動 | `local`ルートは必ず存在（VPC内通信は常に到達可能）。未関連付けサブネットはメイン`ルートテーブル`を使用 | 新規SGはInboundなし（全拒否）、Outboundは全許可。デフォルトSGは自己参照Inbound許可 | デフォルトNACLは全許可。新規作成NACLはデフォルトで全拒否 |
| 評価順序 | 最長プレフィックスマッチ（Longest Prefix Match） | ルール順序なし。いずれかが許可に一致すれば通過（なければ暗黙の拒否） | ルール番号の小さい順に評価。最初に一致した許可/拒否を適用 |
| ルールの書式 | 宛先CIDR → ターゲット（`igw`、`nat-gateway`、`tgw`、`vgw`、`vpce`、`pcx`、`eni` 等） | プロトコル/ポート範囲 + 送信元/送信先（CIDR または `sg-id` 参照） | プロトコル/ポート範囲 + CIDR（SG参照は不可） |
| 送信元/送信先の指定 | 宛先のみ（送信元条件はなし） | Inboundは送信元、Outboundは送信先。SG相互参照が可能 | Inbound/OutboundともCIDR指定のみ（SG/タグ参照不可） |
| パケットフローでの位置（簡略） | Egress: SG → NACL → ルート → ゲートウェイ／対向 | ENI直前/直後で適用 | サブネットの入口/出口で適用 |
| 代表的ユースケース | パブリック/プライベートサブネットの分離、`igw`/`nat-gateway`/`tgw`/`pcx`/`vpce` への経路設定 | アプリ間の最小権限通信制御、層間（Web→App→DB）の許可、SG相互参照で動的グルーピング | サブネット単位のガードレール、既知悪性IPの拒否、広範囲な遮断、エフェメラルポート制御 |
| よくある落とし穴 | 逆方向の経路欠如による非対称ルーティング/到達不可、`pcx`で両側に経路が必要、ターゲット削除でブラックホール化 | 戻りは自動許可だがNACLでブロックされ得る、SG参照方向の誤り、ICMP許可漏れ | エフェメラルポート未許可でセッション不成立、ルール番号順序ミス、カスタムNACLの既定全拒否に気づかない |
| ログ/可観測性 | 直接の通過ログなし。経路検証は`Reachability Analyzer`やネットワークマネージャのルート可視化が有用 | 通過/拒否は`VPC Flow Logs`でACCEPT/REJECT確認（SG自体の命中ログはなし） | 同左（NACLルール番号はFlow Logsに出ない）。変更操作は`CloudTrail`で監査 |
| 変更の反映 | 即時（秒〜数秒） | 即時（セッション途中でも反映、ステートフル） | 即時（ステートレスのため双方向にルールが必要） |
| コスト | 追加料金なし（データ転送料金は別） | 追加料金なし | 追加料金なし |
| サービスクォータ（例） | ルート数/テーブル数に上限あり | 1 ENIあたりのSG数、1 SGあたりのルール数に上限あり | 方向ごとのルール数に上限あり（番号は1–32766） |
| 関連コンポーネント | `igw`、`nat-gateway`、`tgw`、`vgw`（ルート伝播）、`vpce`、`pcx` | `ENI`、`EC2`、`RDS`、`ALB`、`EFS`、`Lambda`(VPC) 等 | `サブネット`、`VPC`、`VPC Flow Logs` |
| ベストプラクティス | 目的別にパブリック/プライベートで分離、`0.0.0.0/0`の向き先を明確化、`vgw`/`tgw`のルート伝播の有無を管理 | 最小権限、SG参照を活用、環境/層ごとにSG分割、アウトバウンドも必要最小限に制限 | サブネット単位で共通ガードレール、戻り用エフェメラルポート許可、番号は余裕を持って採番、拒否は上位に配置 |

補足
- エフェメラルポートの例: Linuxの一般的な範囲は 32768–60999 または 49152–65535。`ネットワークACL`で戻り通信を許可する際は該当範囲を開放してください。
- `ルートテーブル`は通信を「許可」するものではなく、宛先への「経路」を定義します。実際の通過可否は`セキュリティグループ`/`ネットワークACL`で決まります（いずれも満たす必要あり）。
- 典型的な選び分け: 細粒度のアクセス制御は`セキュリティグループ`、サブネット全体のガードレールや拒否は`ネットワークACL`、経路の設計は`ルートテーブル`で行うのが基本です。



# ルートテーブルの実務的設定例

## 1. 基本的な3層アーキテクチャの例

### 前提条件
- VPC CIDR: 10.0.0.0/16
- リージョン: ap-northeast-1 (東京)
- アベイラビリティゾーン: ap-northeast-1a, 1c

### サブネット構成

```
パブリックサブネット:
  - 10.0.1.0/24 (AZ-1a)
  - 10.0.2.0/24 (AZ-1c)

プライベートサブネット（アプリケーション層）:
  - 10.0.11.0/24 (AZ-1a)
  - 10.0.12.0/24 (AZ-1c)

プライベートサブネット（データベース層）:
  - 10.0.21.0/24 (AZ-1a)
  - 10.0.22.0/24 (AZ-1c)
```

---

## 2. ルートテーブル設定例

### 2-1. パブリックサブネット用ルートテーブル

**名前**: `rtb-public-prod`

| 送信先 | ターゲット | 用途 | 備考 |
|--------|-----------|------|------|
| 10.0.0.0/16 | local | VPC内通信 | 自動作成（削除不可） |
| 0.0.0.0/0 | igw-xxxxx | インターネット向け通信 | インターネットゲートウェイ |

**関連付けサブネット**:
- subnet-public-1a (10.0.1.0/24)
- subnet-public-1c (10.0.2.0/24)
