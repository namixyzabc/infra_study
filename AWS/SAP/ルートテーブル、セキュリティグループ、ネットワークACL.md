以下は、AWS VPCにおける`ルートテーブル`、`セキュリティグループ`、`ネットワークACL`の用途や違いを網羅的に比較した表です。

| 観点 | `ルートテーブル` | `セキュリティグループ` | `ネットワークACL` |
|---|---|---|---|
| 主な役割 | 宛先CIDRに基づく次ホップ選択（経路制御） | ENI（ネットワークインタフェース）単位のステートフル許可リスト | サブネット境界のステートレスL3/L4フィルタ |
| 適用スコープ/関連付け | `サブネット`に関連付け（メイン`ルートテーブル`あり）。一部`ゲートウェイエンドポイント`用の関連付けも | `ENI`にアタッチ（`EC2`、`RDS`、`ALB`、`EFS`マウントターゲット、`Lambda`のVPC ENI など） | `サブネット`に1つ関連付け（サブネット内すべてのENIに影響） |
| 処理レイヤ | L3 ルーティング（最長一致） | L3/L4 ステートフル検査 | L3/L4 ステートレス検査 |
| ステートフル性 | なし（状態管理しない） | あり（戻りトラフィックは自動許可） | なし（戻りも明示的に許可が必要） |
| 方向（イン/アウト） | 区別なし（経路は双方向で有効だが設定は宛先ベース） | `Inbound`/`Outbound`を別々に定義 | `Inbound`/`Outbound`を別々に定義 |
| 許可/拒否 | 拒否の概念なし（次ホップ未到達で実質ドロップ＝ブラックホール） | 許可のみ（拒否ルールなし、暗黙の拒否） | 許可・拒否の両方が定義可能 |
| 既定の挙動 | `local`ルートは必ず存在（VPC内通信は常に到達可能）。未関連付けサブネットはメイン`ルートテーブル`を使用 | 新規SGはInboundなし（全拒否）、Outboundは全許可。デフォルトSGは自己参照Inbound許可 | デフォルトNACLは全許可。新規作成NACLはデフォルトで全拒否 |
| 評価順序 | 最長プレフィックスマッチ（Longest Prefix Match） | ルール順序なし。いずれかが許可に一致すれば通過（なければ暗黙の拒否） | ルール番号の小さい順に評価。最初に一致した許可/拒否を適用 |
| ルールの書式 | 宛先CIDR → ターゲット（`igw`、`nat-gateway`、`tgw`、`vgw`、`vpce`、`pcx`、`eni` 等） | プロトコル/ポート範囲 + 送信元/送信先（CIDR または `sg-id` 参照） | プロトコル/ポート範囲 + CIDR（SG参照は不可） |
| 送信元/送信先の指定 | 宛先のみ（送信元条件はなし） | Inboundは送信元、Outboundは送信先。SG相互参照が可能 | Inbound/OutboundともCIDR指定のみ（SG/タグ参照不可） |
| パケットフローでの位置（簡略） | Egress: SG → NACL → ルート → ゲートウェイ／対向 | ENI直前/直後で適用 | サブネットの入口/出口で適用 |
| 代表的ユースケース | パブリック/プライベートサブネットの分離、`igw`/`nat-gateway`/`tgw`/`pcx`/`vpce` への経路設定 | アプリ間の最小権限通信制御、層間（Web→App→DB）の許可、SG相互参照で動的グルーピング | サブネット単位のガードレール、既知悪性IPの拒否、広範囲な遮断、エフェメラルポート制御 |
| よくある落とし穴 | 逆方向の経路欠如による非対称ルーティング/到達不可、`pcx`で両側に経路が必要、ターゲット削除でブラックホール化 | 戻りは自動許可だがNACLでブロックされ得る、SG参照方向の誤り、ICMP許可漏れ | エフェメラルポート未許可でセッション不成立、ルール番号順序ミス、カスタムNACLの既定全拒否に気づかない |
| ログ/可観測性 | 直接の通過ログなし。経路検証は`Reachability Analyzer`やネットワークマネージャのルート可視化が有用 | 通過/拒否は`VPC Flow Logs`でACCEPT/REJECT確認（SG自体の命中ログはなし） | 同左（NACLルール番号はFlow Logsに出ない）。変更操作は`CloudTrail`で監査 |
| 変更の反映 | 即時（秒〜数秒） | 即時（セッション途中でも反映、ステートフル） | 即時（ステートレスのため双方向にルールが必要） |
| コスト | 追加料金なし（データ転送料金は別） | 追加料金なし | 追加料金なし |
| サービスクォータ（例） | ルート数/テーブル数に上限あり | 1 ENIあたりのSG数、1 SGあたりのルール数に上限あり | 方向ごとのルール数に上限あり（番号は1–32766） |
| 関連コンポーネント | `igw`、`nat-gateway`、`tgw`、`vgw`（ルート伝播）、`vpce`、`pcx` | `ENI`、`EC2`、`RDS`、`ALB`、`EFS`、`Lambda`(VPC) 等 | `サブネット`、`VPC`、`VPC Flow Logs` |
| ベストプラクティス | 目的別にパブリック/プライベートで分離、`0.0.0.0/0`の向き先を明確化、`vgw`/`tgw`のルート伝播の有無を管理 | 最小権限、SG参照を活用、環境/層ごとにSG分割、アウトバウンドも必要最小限に制限 | サブネット単位で共通ガードレール、戻り用エフェメラルポート許可、番号は余裕を持って採番、拒否は上位に配置 |

補足
- エフェメラルポートの例: Linuxの一般的な範囲は 32768–60999 または 49152–65535。`ネットワークACL`で戻り通信を許可する際は該当範囲を開放してください。
- `ルートテーブル`は通信を「許可」するものではなく、宛先への「経路」を定義します。実際の通過可否は`セキュリティグループ`/`ネットワークACL`で決まります（いずれも満たす必要あり）。
- 典型的な選び分け: 細粒度のアクセス制御は`セキュリティグループ`、サブネット全体のガードレールや拒否は`ネットワークACL`、経路の設計は`ルートテーブル`で行うのが基本です。

---
---

# ルートテーブルの実務的設定例

## 1. 基本的な3層アーキテクチャの例

### 前提条件
- VPC CIDR: 10.0.0.0/16
- リージョン: ap-northeast-1 (東京)
- アベイラビリティゾーン: ap-northeast-1a, 1c

### サブネット構成

```
パブリックサブネット:
  - 10.0.1.0/24 (AZ-1a)
  - 10.0.2.0/24 (AZ-1c)

プライベートサブネット（アプリケーション層）:
  - 10.0.11.0/24 (AZ-1a)
  - 10.0.12.0/24 (AZ-1c)

プライベートサブネット（データベース層）:
  - 10.0.21.0/24 (AZ-1a)
  - 10.0.22.0/24 (AZ-1c)
```



## 2. ルートテーブル設定例

### 2-1. パブリックサブネット用ルートテーブル

**名前**: `rtb-public-prod`

| 送信先 | ターゲット | 用途 | 備考 |
|--------|-----------|------|------|
| 10.0.0.0/16 | local | VPC内通信 | 自動作成（削除不可） |
| 0.0.0.0/0 | igw-xxxxx | インターネット向け通信 | インターネットゲートウェイ |

**関連付けサブネット**:
- subnet-public-1a (10.0.1.0/24)
- subnet-public-1c (10.0.2.0/24)





---
---
# AWSコンソール風 セキュリティグループ設定例（Webサーバ）

以下は、AWSマネジメントコンソールの「セキュリティグループ」画面に近い見え方でまとめた実務例です。

## セキュリティグループの詳細
| 項目 | 値 |
|---|---|
| セキュリティグループ名 | sg-web-public-ec2 |
| セキュリティグループID | sg-0abc123def4567890 |
| 説明 | Public web EC2: allow 80/443 from Internet, SSH from office only |
| VPC | vpc-0a1b2c3d4e5f67890（prod-vpc） |
| 所有者 | 123456789012 |
| インバウンドルール | 5 |
| アウトバウンドルール | 2 |

## インバウンドルール
| タイプ | プロトコル | ポート範囲 | ソース | 説明 |
|---|---|---:|---|---|
| HTTP | TCP | 80 | 0.0.0.0/0（Anywhere-IPv4） | Allow HTTP from anywhere (IPv4) |
| HTTP | TCP | 80 | ::/0（Anywhere-IPv6） | Allow HTTP from anywhere (IPv6) |
| HTTPS | TCP | 443 | 0.0.0.0/0（Anywhere-IPv4） | Allow HTTPS from anywhere (IPv4) |
| HTTPS | TCP | 443 | ::/0（Anywhere-IPv6） | Allow HTTPS from anywhere (IPv6) |
| SSH | TCP | 22 | 203.0.113.10/32（Custom） | Allow SSH from office IP only |

## アウトバウンドルール
| タイプ | プロトコル | ポート範囲 | 送信先 | 説明 |
|---|---|---:|---|---|
| すべてのトラフィック | すべて | すべて | 0.0.0.0/0（Anywhere-IPv4） | Allow all outbound (IPv4) |
| すべてのトラフィック | すべて | すべて | ::/0（Anywhere-IPv6） | Allow all outbound (IPv6) |

## タグ
| キー | 値 |
|---|---|
| Name | sg-web-public-ec2 |
| Environment | prod |
| Owner | platform-team |




---
---
# AWSコンソール風 ネットワークACL（NACL）設定例（プライベートAppサブネット用）

シナリオ:
- VPC内のプライベートサブネットにあるアプリケーションEC2
- パブリックサブネットのALBから`HTTP/HTTPS`で受信
- DBサブネットのRDS(MySQL)へ`3306`で送信
- インターネットへのアウトバウンドはNAT経由（OSアップデート等の`80/443`）
- 管理用にバスティオン（踏み台）から`SSH(22)`を許可
- NACLはステートレスのため、戻りトラフィック用にエフェメラルポート（`1024-65535`）を明示許可

実際のAWSマネジメントコンソール（NACL詳細）に近い見え方で記載します。

## ネットワークACLの詳細
| 項目 | 値 |
|---|---|
| 名称タグ | nacl-private-app |
| ネットワークACL ID | acl-0abc123def4567890 |
| VPC | vpc-0a1b2c3d4e5f67890（prod-vpc） |
| 関連付けられているサブネット | 2 |
| エントリ（インバウンド/アウトバウンド） | 7 / 8 |
| 所有者 | 123456789012 |

## 関連付けられているサブネット
| サブネットID | IPv4 CIDR | アベイラビリティーゾーン | 関連付け |
|---|---|---|---|
| subnet-0aaa111bbb222ccc1 | 10.0.2.0/24 | ap-northeast-1a | メイン |
| subnet-0ddd444eee555fff2 | 10.0.4.0/24 | ap-northeast-1c |  |

- 想定VPC CIDR: `10.0.0.0/16`  
- パブリック(ALB)サブネット例: `10.0.1.0/24`  
- アプリ(プライベート)サブネット例: `10.0.2.0/24`、`10.0.4.0/24`  
- DBサブネット例: `10.0.3.0/24`  
- 管理(バスティオン)サブネット例: `10.0.10.0/24`  
- VPC DNSリゾルバー: `10.0.0.2`（VPCベースアドレス+2）

## インバウンドルール
| ルール番号 | タイプ | プロトコル | ポート範囲 | 送信元 | 許可/拒否 | 説明 |
|---:|---|---|---|---|---|---|
| 100 | HTTP | TCP | 80 | 10.0.1.0/24 | 許可 | ALB(パブリックサブネット)からのHTTP |
| 110 | HTTPS | TCP | 443 | 10.0.1.0/24 | 許可 | ALB(パブリックサブネット)からのHTTPS |
| 120 | SSH | TCP | 22 | 10.0.10.0/24 | 許可 | バスティオンからのSSH |
| 150 | カスタムTCP | TCP | 1024-65535 | 10.0.3.0/24 | 許可 | DBからの戻りトラフィック（エフェメラル） |
| 160 | カスタムTCP | TCP | 1024-65535 | 0.0.0.0/0 | 許可 | NAT経由のインターネット戻りトラフィック（エフェメラル） |
| 170 | カスタムTCP | TCP | 1024-65535 | 10.0.0.2/32 | 許可 | VPC DNSの戻り（TCPフォールバック） |
| 171 | カスタムUDP | UDP | 1024-65535 | 10.0.0.2/32 | 許可 | VPC DNSの戻り（UDP） |
| 32767 | すべてのトラフィック | すべて | すべて | 0.0.0.0/0 | 拒否 | デフォルト（暗黙） |

## アウトバウンドルール
| ルール番号 | タイプ | プロトコル | ポート範囲 | 送信先 | 許可/拒否 | 説明 |
|---:|---|---|---|---|---|---|
| 100 | カスタムTCP | TCP | 1024-65535 | 10.0.1.0/24 | 許可 | ALBへの戻りトラフィック（エフェメラル） |
| 110 | MySQL/Aurora | TCP | 3306 | 10.0.3.0/24 | 許可 | RDS(MySQL)への接続 |
| 120 | HTTP | TCP | 80 | 0.0.0.0/0 | 許可 | NAT経由でのOS更新・HTTP外向き |
| 130 | HTTPS | TCP | 443 | 0.0.0.0/0 | 許可 | NAT経由でのHTTPS外向き |
| 140 | カスタムTCP | TCP | 1024-65535 | 10.0.10.0/24 | 許可 | バスティオンへの戻り（エフェメラル） |
| 150 | DNS(UDP) | UDP | 53 | 10.0.0.2/32 | 許可 | VPC DNS（UDP） |
| 151 | DNS(TCP) | TCP | 53 | 10.0.0.2/32 | 許可 | VPC DNS（TCPフォールバック） |
| 32767 | すべてのトラフィック | すべて | すべて | 0.0.0.0/0 | 拒否 | デフォルト（暗黙） |

## ポイント（実運用メモ）
- NACLはステートレスのため、行きの許可に対応する戻りの許可（エフェメラル `1024-65535`）が必須です。
- `0.0.0.0/0` 宛のアウトバウンド（80/443）を許可する場合、戻りのインバウンド・エフェメラルも必要です。プライベートサブネットはインターネットから直接ルーティングされないため、実質的な露出は限定的ですが、可能なら通信先をさらに絞るとより安全です。
- セキュリティグループと併用が基本。SGはステートフルのため、SG側では戻りトラフィックの明示許可は不要ですが、NACL側では必要になります。
- 管理アクセスは`SSM Session Manager`に移行できる場合、`SSH(22)`を閉じるとより堅牢です。
- Windowsなどでエフェメラルレンジが異なるケースがありますが、AWSの一般的な推奨は`1024-65535`です。
- ルール番号は小さいほど優先されます。明示的な`DENY`を上に置いて特定CIDRを遮断する設計も可能です（本例はデフォルト`DENY`のみ）。
