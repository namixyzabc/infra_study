# Transit Gateway 概要

`AWS Transit Gateway` は、複数の `VPC`、オンプレミス（`Site-to-Site VPN`、`Direct Connect`）や他リージョンの `Transit Gateway` を「ハブ＆スポーク」型で集約・中継するマネージドなルーティングハブです。個々の `VPC Peering` では実現しづらい大規模・多拠点のトランジティブ（中継）接続を、シンプルな運用とスケーラビリティで提供します。リージョン単位の冗長性を持ち、アタッチメント（接続）とルートテーブル（経路制御）で柔軟にネットワーク分割・集約が可能です。

用語補足:
- ハブ＆スポーク: 中央の「ハブ」に全ての拠点（スポーク）を接続し、拠点間通信をハブで中継する設計。
- トランジティブ: A—ハブ—B のように、中継点を通じて第三者同士の通信を成立させること（VPC Peering は基本非トランジティブ）。


# 覚えるべき要点

## 1) サービスの位置づけと特性
- リージョン単位のハブ: `Transit Gateway` は1リージョン内の中心ハブ。複数作成も可能。
- フルマネージド・高可用: 障害時の冗長化はAWS側で提供。ユーザーが台数やクラスタを管理する必要はない。
- トランジティブ接続: 同一 `Transit Gateway` 配下のスポーク（`VPC`/オンプレ）が相互通信可能（ルート許可前提）。

## 2) 基本コンポーネント
- アタッチメント（Attachment）
  - 種類: `VPC`、`Site-to-Site VPN`、`Direct Connect Gateway`、`Transit Gateway Peering`、`Connect`（SD-WAN/GRE+BGP）、`Multicast`
  - 役割: `Transit Gateway` に接続するための「ポート」のようなもの
- `Transit Gateway` ルートテーブル
  - 経路の集約点。複数作成可
  - 各アタッチメントは「関連付け（Association）」でき、また経路を「伝播（Propagation）」できる
  - スタティックルート（手動）と動的ルート（BGPなどの伝播）を保持。静的が同一プレフィクスなら優先
- 用語補足
  - 関連付け: そのアタッチメント発のトラフィックが参照するTGWルートテーブルを決める
  - 伝播: アタッチメントから学習した経路をTGWルートテーブルへ自動登録（VPCは基本伝播しない）

## 3) VPCアタッチメントの要点
- AZごとにサブネットを選択: 選んだ各AZに `TGW` の `ENI` が作られる
- イン-AZ最適化: 送受信は可能な限り同一AZのアタッチメントを使い、クロスAZデータ処理コストを低減
- `VPC` 側ルートテーブル設定が必須: 送信先プレフィクスを `Transit Gateway` ターゲットへ向ける
- 帰り道も要確認: 対向側（他VPC/オンプレ）→`TGW`→該当VPC へ戻る経路が `TGW` ルートテーブルにあること

## 4) ルーティング制御（設計のキモ）
- 最長一致ルックアップ: より具体的なプレフィクスが選ばれる（例: /24 は /16 に優先）
- 複数ルートテーブルでセグメント化: 開発/本番、共有サービス、検査用など、用途ごとに分離
- ブラックホールルート: マッチしたトラフィックを明示的に破棄し、リークやループを防ぐ
- 伝播の使い分け
  - `VPN`/`DX Gateway`: BGPで経路伝播可能
  - `VPC`: 伝播しないため、TGWルートは静的に定義（または他の動的経路と組み合わせ）
- 静的ルート優先: 同一プレフィクスでは静的が動的より優先される

## 5) インスペクション（セキュリティ）設計
- 集中型検査VPC（Inspection VPC）パターン
  - 全トラフィックをファイアウォールVPC経由にするため、`TGW` の複数ルートテーブルで経路を誘導
  - `AWS Network Firewall`、`Gateway Load Balancer` 組み合わせが定番
- `Appliance mode`（アプライアンスモード）
  - ステートフル装置の左右対称ルーティングを実現（往路と復路が同じAZ/装置を通る）
  - AZを跨いだ非対称経路によるセッション破棄を防ぐ

## 6) リージョン間接続（TGW Peering）
- `Transit Gateway Peering` アタッチメントでリージョン間を接続
- 非トランジティブ: TGW-A—TGW-B—TGW-C の直列で A→C はデフォルト不可（Bを中継にできない）
- 暗号化済みでAWSバックボーンを使用。マルチキャストはピアリング非対応

## 7) オンプレ接続
- `Site-to-Site VPN`（IPsec）
  - BGPにより経路学習・フェイルオーバー
  - `ECMP`（Equal-Cost Multi-Path）で複数トンネルの帯域を並列活用
- `Direct Connect` 経由
  - `Direct Connect Gateway` と接続し、プライベートVIFで `TGW` 到達
  - 大規模ハイブリッドでも中核に据えやすい
- `Connect` アタッチメント
  - GREトンネル＋BGPでSD-WANアプライアンスと連携（クラウド内で動的ルーティング）

用語補足:
- BGP: ルータ同士が経路を動的に交換するプロトコル
- ECMP: 同じコストの複数経路へ負荷分散

## 8) マルチキャスト
- `Transit Gateway` マルチキャストドメインで1対多配信をサポート
- `IGMP` によるメンバー管理（主にVPC内の受信ホスト）。ピアリング越えは不可

## 9) 共有と組織連携
- `AWS RAM`（Resource Access Manager）で他アカウントの `VPC` を同一 `Transit Gateway` に参加可能
- 複数アカウント・複数VPCを中央集権的に接続・分離できる

## 10) DNS連携の考え方
- `Transit Gateway` はDNSを転送しない
- 中央DNSを使いたい場合は、`Route 53 Resolver` のインバウンド/アウトバウンドエンドポイントやルール共有で設計
- 検査VPC経由にする場合はDNSトラフィックの経路も要計画

## 11) 可用性・スケーリングと制限
- 自動スケール・冗長化はマネージド。設計者はAZごとのアタッチメント配置を意識
- 帯域目安（代表例）
  - `VPC` アタッチメント: 最大およそ数十Gbps級（例: 50 Gbps）
  - `TGW Peering`: 最大およそ数十Gbps級（例: 50 Gbps）
  - `Site-to-Site VPN`: 1トンネルあたりの上限あり。ECMPでスケール
  - `Connect` GREピア単位で上限あり
- クォータ例（試験向けに意識）
  - ルート数、アタッチメント数、伝播数に上限あり（最新値はドキュメントで要確認）

## 12) 監視・運用
- `Transit Gateway Flow Logs`: トラフィック情報を `CloudWatch Logs`／`S3` へ
- `CloudWatch` メトリクス/アラーム、`EventBridge` でイベント連携
- トラブル時は
  - VPCルート → TGWルートテーブルの関連付け/伝播 → 対向側の戻り経路 → セキュリティグループ/NACL
  - `Reachability Analyzer` も有用（経路探索）

## 13) 料金モデル（設計に効く）
- 課金は主に以下
  - アタッチメント時間課金（接続単位）
  - データ処理料（通過トラフィックのGB課金）
  - リージョン間ピアリングの転送料（別料金）
- 料金最適化の定石
  - 不要なクロスAZを避ける（イン-AZ最適化）
  - 経路設計で無駄な経由を減らす
  - 共有ハブを集約しすぎてボトルネック/高額化しないよう分割

## 14) よくある比較・選定ポイント（試験対策）
- `VPC Peering` vs `Transit Gateway`
  - Peering: シンプル・安価、非トランジティブ、小規模メッシュ向け
  - TGW: トランジティブ、大規模・多アカウント・オンプレ連携向け、中心集約で運用容易
- `PrivateLink`（`NLB` 経由のサービス公開）
  - L4サービス公開に最適。汎用的な双方向ルーティングには不向き
- `Cloud WAN` vs `Transit Gateway`
  - Cloud WAN: グローバル一元化（ポリシーベース、セグメント、マルチリージョンを抽象化）
  - TGW: リージョン単位のハブ。Cloud WAN配下で各リージョンのハブとして併用する構成もあり
- NAT/インターネットアクセス
  - TGW自体はNATしない。出口制御は `NAT Gateway`、ファイアウォール、`Gateway Load Balancer` で設計

## 15) 試験でのひっかけ／設計Tips
- 同一TGW内はトランジティブだが、`TGW Peering` は非トランジティブ
- `VPC` からの経路はTGWに自動伝播しない（静的にTGWルートへ登録）
- 中央検査の左右対称性は `Appliance mode` とAZ設計が鍵
- マルチアカウントは `AWS RAM` でTGW共有
- 静的ルートは動的ルートより優先
- DNSは別設計（`Route 53 Resolver`）
- ECMPでVPNスループットを水平スケール
- 料金は「アタッチメント時間＋データ処理＋ピアリング転送」を意識

このセットを押さえておくと、設計問題での判断（どの接続方式・どのルートテーブルに何を関連付け/伝播するか、検査VPCをどう経由させるか、リージョン間をどう張るか）が安定します。
