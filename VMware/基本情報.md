

## vSphere解説

### 1. vSphereとは

**vSphere**は、VMware社が提供するサーバー仮想化を実現するための製品群の総称です。物理サーバー上にハイパーバイザーである**ESXi**をインストールし、その上で複数の仮想マシン（VM）を稼働させます。さらに、管理サーバーである**vCenter Server**を導入することで、多数のESXiホストと仮想マシンを一元的に管理し、可用性や運用効率を高める高度な機能を利用できます。

#### 全体像のイメージ

管理者はWebブラウザから**vSphere Client**という管理ツールを使ってvCenter Serverにアクセスし、仮想環境全体を操作します。

```
[管理者]
   │ (vSphere Clientでアクセス)
   ↓
[vCenter Server] <--- 複数のESXiホストを一元管理
   │
   ├─ [ESXi #1] ─ [VM群]
   ├─ [ESXi #2] ─ [VM群]
   └─ [ESXi #3] ─ [VM群]
        │
        └─ [共有ストレージ (VMFS/vSANなど)] <--- 全ESXiからアクセス
```

---

### 2. コアコンポーネント

vSphere環境を構成する中心的な要素です。

#### ESXi

物理サーバーのハードウェアに直接インストールして動作する**Type-1（ベアメタル型）ハイパーバイザー**です。OSを介さず直接ハードウェアを制御するため、高性能で信頼性が高い仮想化基盤を構築できます。

*   **主なメリット**
| メリット | 説明 |
| :--- | :--- |
| **コスト削減** | 複数の物理サーバーを1台に集約し、ハードウェアや設置スペース、電力コストを削減します。 |
| **省スペース** | データセンターの物理的なラックスペースを大幅に削減できます。 |
| **柔軟なリソース管理** | 仮想マシンのCPUやメモリといったリソースを、OSを再起動することなく動的に変更できます。 |
| **迅速な展開** | VMテンプレートを利用することで、OSがインストール済みのサーバーを数分で展開できます。 |

*   **競合製品との比較**
    *   **Microsoft Hyper-V:** Windows Serverに統合されたハイパーバイザー。
    *   **KVM:** Linuxカーネルに組み込まれているオープンソースのハイパーバイザー。
    *   **Proxmox VE:** KVMをベースとしたオープンソースの仮想化プラットフォーム。

#### vCenter Server

複数のESXiホストと、その上で稼働する全ての仮想マシンを**一元的に管理するためのサーバー**です。vSphereが提供するHAやvMotionといった高度な機能は、vCenter Serverを導入することで利用可能になります。

*   **主な機能**
    *   **一括操作:** 複数ホストへのパッチ適用や設定変更を一度に実行できます。
    *   **集中監視:** 全てのESXiホストと仮想マシンの状態やパフォーマンスを単一の画面で監視できます。
    *   **テンプレート管理:** 標準構成の仮想マシンをテンプレートとして保存し、迅速な展開を可能にします。

---

### 3. 高可用性・移行機能

システムの停止時間を最小限にし、メンテナンスを柔軟に行うための機能群です。

#### vSphere HA (High Availability)

*   **機能概要:** ESXiホストに障害が発生した際、その上で稼働していた仮想マシンを、クラスタ内の他の正常なホスト上で**自動的に再起動**する機能です。これにより、ハードウェア障害からのダウンタイムを数分程度に抑えます。
*   **使用例:** 物理サーバーの電源障害やハードウェア故障時に、サービスを自動で復旧させます。
*   **前提条件:**
    *   共有ストレージ（VMFS, NFS, vSANなど）が必須。
    *   障害発生時にVMを引き継ぐための十分な空きリソースがクラスタ内に必要。

#### vSphere Fault Tolerance (FT)

*   **機能概要:** 仮想マシンをプライマリとセカンダリの2台で**完全に同期させながら常時稼働**させる機能です。プライマリに障害が発生すると、瞬時にセカンダリに切り替わるため、**ダウンタイムが一切発生しません**。
*   **vSphere HAとの違い**
| 項目 | vSphere HA | Fault Tolerance (FT) |
| :--- | :--- | :--- |
| **ダウンタイム** | 数分（OS再起動が発生） | ゼロ（瞬時に切り替え） |
| **リソース消費** | 低い | 高い（常に2倍のリソースが必要） |
| **用途** | 一般的なシステム | ミッションクリティカルなシステム |
| **CPU制限** | なし | vCPU数に制限あり |
*   **使用例:** 金融取引システムや医療機器制御など、一瞬の停止も許されないシステム。
*   **注意点:** 2倍のリソースを消費し、同期のために10Gbps以上の専用ネットワークが推奨されます。Snapshotなど一部機能と併用できません。

#### vMotion

*   **機能概要:** 仮想マシンを**サービスを停止することなく**、あるESXiホストから別のESXiホストへ移動させる機能です。メモリの状態やネットワーク接続を維持したまま移行します。
*   **使用例:** 物理サーバーのメンテナンス（ハードウェア交換など）を、ユーザーに影響を与えず実施できます。
*   **技術的な仕組み:**
    1.  VMを稼働させたまま、メモリ内容の転送を開始。
    2.  転送中に変更されたメモリの差分を繰り返し転送。
    3.  最終段階でVMを数ミリ秒だけ静止させ、残りのデータを完全に同期。
    4.  移行先のホストでVMの実行を再開。
*   **前提条件:** 共有ストレージへのアクセス、互換性のあるCPU、vMotion用の専用ネットワークが必要です。

#### Storage vMotion

*   **機能概要:** 仮想マシンを**稼働させたまま**、そのディスクファイルをあるストレージ（データストア）から別のストレージへ移動させる機能です。通常のvMotionと組み合わせることで、ホストとストレージを同時に変更することも可能です。
*   **使用例:** ストレージ装置の入れ替え作業や、より高性能なストレージへの移行、ストレージ容量の再配置に利用します。

#### DRS (Distributed Resource Scheduler)

*   **機能概要:** クラスタ全体のCPUやメモリの負荷を常に監視し、負荷が偏った場合に**vMotionを利用して仮想マシンを自動的に移動**させ、リソースバランスを最適化します。
*   **動作モード**
| モード | 説明 |
| :--- | :--- |
| **Manual (手動)** | 移行の推奨のみを表示し、実行は管理者が判断します。 |
| **Partially Automated (半自動)** | VMの初回起動時のみ最適なホストに自動配置し、その後の移行は手動です。 |
| **Fully Automated (全自動)** | VMの起動から稼働中の負荷分散まで、すべてを自動で行います。 |
*   **注意点:** アフィニティルール（特定のVMを特定のホストに配置する設定）と競合する可能性があります。

#### Storage DRS

*   **機能概要:** 複数のデータストアを「データストアクラスタ」として一つにまとめ、**容量とI/O負荷を自動的に最適化**する機能です。Storage vMotionを自動実行します。
*   **主な機能:**
    *   **容量バランシング:** データストアの使用率を均等化し、容量枯渇を防ぎます。
    *   **I/O負荷分散:** I/Oの応答時間が悪化したデータストアからVMを自動的に移動させ、パフォーマンスを改善します。
*   **使用例:** ストレージ容量が偏った場合の自動再配分や、データベースなどI/O負荷の高いVMの分散配置。
*   **注意点:** 頻繁な移行はネットワーク帯域を消費し、パフォーマンスに影響を与える可能性があるため、閾値の調整が重要です。

---

### 4. データ保護・バックアップ機能

データの保全と迅速な復旧を実現するための機能群です。

#### Snapshots (スナップショット)

*   **機能概要:** 仮想マシンの**特定時点の状態（ディスク、メモリ、設定）を瞬時に保存**する機能です。問題が発生した際に、取得した時点の状態へ数クリックで戻すことができます。
*   **仕組み:** スナップショットを取得すると、元の仮想ディスク（VMDK）は読み取り専用になり、以降の変更は別の差分ディスクファイルに書き込まれます。
*   **使用例:** Windowsアップデートやアプリケーション更新など、システムに変更を加える前の「保険」として利用します。
*   **⚠️ 重要な注意点**
| 注意事項 | 理由 |
| :--- | :--- |
| **長期保存は厳禁** | 差分ファイルが肥大化し、VMのパフォーマンスが著しく低下します。 |
| **バックアップではない** | 元のディスクファイルに依存するため、ストレージ障害からは保護できません。 |
| **削除に時間がかかる** | 削除時に差分データを元のディスクに統合する処理が発生し、時間がかかる場合があります。 |
*   **ベストプラクティス:** 保持期間は**24～72時間以内**に留め、作業完了後は速やかに削除します。

#### vSphere Replication

*   **機能概要:** 仮想マシンのデータを、**別のサイトやデータセンターへ非同期で複製（レプリケーション）**する機能です。RPO（目標復旧時点）を15分～24時間の間で柔軟に設定でき、ストレージ製品に依存せずに利用できます。
*   **使用例:** 地震や火災などの大規模災害に備える**ディザスタリカバリ（DR）対策**として利用します。
*   **ストレージレプリケーションとの違い:**
| 項目 | vSphere Replication | ストレージレプリケーション |
| :--- | :--- | :--- |
| **ストレージ依存** | 不要（どのストレージでも利用可能） | 同一ベンダーの対応製品が必要 |
| **柔軟性** | VMごとに異なるRPOを設定可能 | ストレージ単位で一律の設定 |
| **コスト** | vSphereライセンスに含まれる | ストレージの追加ライセンス費用がかかる場合がある |
*   **注意点:** レプリケーションはネットワーク帯域を消費します。災害時の切り替え（フェイルオーバー）は手動操作が必要です。

#### vSphere Data Protection (VDP)

*   **機能概要:** vSphere環境に統合された、**エージェントレスのイメージベースバックアップ・リカバリ機能**です。強力な重複排除機能により、バックアップ先のストレージ容量を大幅に削減できます。
*   **主な特徴:**
    *   **エージェントレス:** VM内にバックアップ用ソフトをインストールする必要がありません。
    *   **増分バックアップ:** 初回以降は変更されたブロックのみをバックアップするため、時間と容量を節約できます。
    *   **多様なリカバリ:** VM全体の復元だけでなく、特定のファイルのみを取り出すことも可能です。
*   **注意点:** VDPは現在、後継製品（Dell EMC Avamarベース製品など）へ移行しています。

---

### 5. ストレージ機能

仮想化環境の基盤となるストレージを構成・管理するための機能です。

#### VMFS (Virtual Machine File System)

*   **機能概要:** vSphereに最適化された**高性能なクラスタファイルシステム**です。複数のESXiホストから一つの共有ストレージ領域へ同時にアクセスすることを可能にし、vMotionやHAの基盤となります。
*   **バージョンの進化**
| バージョン | 最大ファイルサイズ | ブロックサイズ | 主な特徴 |
| :--- | :--- | :--- | :--- |
| **VMFS-5** | 62TB | 1MB（統一） | 2TB以上のディスクをサポート、自動スペース回収機能。 |
| **VMFS-6** | 62TB | 1MB | 4Kネイティブストレージ対応、自動スペース回収の改善。 |
*   **主な機能:**
    *   **ファイルロック機構:** 複数ホストからの同時書き込みを制御し、データ整合性を保ちます。
    *   **VAAI対応:** ストレージ側の処理能力を活用（オフロード）し、ESXiの負荷を軽減します。

#### vSAN (Virtual SAN)

*   **機能概要:** 複数のESXiホストが持つ**内蔵ディスクを束ねて、ソフトウェアで単一の共有ストレージプールを構築**する、ソフトウェア定義ストレージ（SDS）です。
*   **アーキテクチャ:** 各ホストのSSD（キャッシュ用）とHDD/SSD（データ用）を組み合わせ、全ホストからアクセス可能な仮想データストアを形成します。
*   **vSAN vs 従来型SAN**
| 項目 | vSAN | 従来型SAN |
| :--- | :--- | :--- |
| **初期コスト** | 低い（サーバー内蔵ディスクを活用） | 高い（専用ストレージ装置が必要） |
| **スケーラビリティ** | ホストを追加するだけで容量と性能が向上 | ストレージの拡張作業が必要 |
| **管理** | vSphere Clientに統合 | 専用の管理ツールが必要 |
*   **最小構成要件:** データ冗長性確保のため、最低3台のホストが必要です。

#### Thin Provisioning (シンプロビジョニング)

*   **機能概要:** 仮想ディスク作成時に、**実際にデータが書き込まれた分だけ**物理ストレージを消費する技術です。ストレージ容量を効率的に利用できます。
*   **Thick vs Thin の違い**
    *   **Thick Provisioning:** 作成時に指定した容量（例: 100GB）を物理ストレージから即座に確保します。
    *   **Thin Provisioning:** 作成時は最小限の容量のみ確保し、データの増加に応じて物理消費量が増えます（例: 実際の使用量が20GBなら物理消費も20GB）。
*   **種類の比較**
| 種類 | 説明 | パフォーマンス |
| :--- | :--- | :--- |
| **Thick Lazy Zeroed** | 容量を確保するが、データのゼロクリアは書き込み時に行う。 | 中 |
| **Thick Eager Zeroed** | 容量確保時に全領域をゼロクリアするため、初回書き込みが速い。 | 高 |
| **Thin Provision** | 使用した分だけ容量を確保する。 | 低～中 |
*   **⚠️ 注意点とリスク:** 物理容量以上の仮想ディスクを割り当て（オーバーコミット）できますが、**空き容量の監視を怠ると、容量不足で全VMが停止する危険**があります。アラーム設定や定期的な監視が必須です。

---

### 6. ネットワーク機能

#### vSphere Distributed Switch (vDS)

*   **機能概要:** 複数のESXiホストにまたがるネットワーク設定を、**vCenter Serverから一元的に管理**できる高機能な仮想スイッチです。ホストごとに設定が必要な標準スイッチ（vSS）と異なり、設定の統一と管理の効率化を実現します。
*   **vSSとの違い**
| 項目 | Standard Switch (vSS) | Distributed Switch (vDS) |
| :--- | :--- | :--- |
| **管理方式** | ホストごとに個別管理 | vCenter Serverで一元管理 |
| **ライセンス** | 全エディションで利用可能 | Enterprise Plusエディションが必要 |
| **高度な機能** | 制限あり | NIOC, NetFlow, ポートミラーリングなど豊富 |
*   **主な機能:**
    *   **ネットワークI/O制御 (NIOC):** トラフィックの種類（vMotion、VM通信など）ごとに帯域を保証・制御します。
    *   **LACP:** 複数の物理NICを束ねて帯域を拡張し、冗長性を高めます。

---

### 7. 運用管理機能

日々の運用を自動化し、環境を標準化するための機能です。

#### vSphere Update Manager (VUM) / Lifecycle Manager

*   **機能概要:** ESXiホストや仮想マシンの**パッチ適用、アップデート、アップグレードを自動化**する機能です。vSphere 7.0以降は**Lifecycle Manager**に統合・進化しました。
*   **主な機能:**
    *   **ベースライン管理 (VUM):** 適用すべきパッチの基準（ベースライン）を作成し、ホストが準拠しているかスキャン・修正します。
    *   **オーケストレーション:** VMを自動で退避させ、ホストをメンテナンスモードに移行し、パッチ適用後、次のホストへ…という一連の作業を自動化します。
    *   **イメージベース管理 (Lifecycle Manager):** あるべきESXiのバージョン、ドライバ、ファームウェアを単一の「イメージ」として定義し、クラスタ全体をその状態に維持します。設定のズレ（ドリフト）も自動で検出します。
*   **⚠️ 注意点**
| 注意事項 | 対策 |
| :--- | :--- |
| **互換性確認** | 適用前にハードウェア互換性リスト（HCL）を必ず確認する。 |
| **バックアウト計画** | 問題発生時に元の状態に戻す手順を準備しておく。 |
| **リソース不足** | DRSと連携し、VM退避のための十分な空きリソースを確保する。 |
*   **ベストプラクティス:** 本番適用前にテスト環境で検証し、段階的に適用を進めます。

#### vSphere Profiles (ホストプロファイル)

*   **機能概要:** 正しく設定されたESXiホストをテンプレート（参照ホスト）として、その**設定（ネットワーク、ストレージ、セキュリティ等）を抽出し、他のホストに一括で適用**する機能です。これにより、設定の標準化とコンプライアンス維持を支援します。
*   **主な機能:**
    *   **プロファイル作成・適用:** 参照ホストからプロファイルを作成し、新規ホストや既存ホストに適用して設定を統一します。
    *   **コンプライアンスチェック:** 定期的にスキャンを実行し、プロファイルから逸脱した設定（設定ドリフト）を自動で検出し、修復できます。
*   **使用例:**
    *   **データセンター拡張時:** 新規サーバーへ迅速に標準設定を展開できます。
    *   **セキュリティ監査対応:** 全ホストでSSHを無効化するなど、セキュリティポリシーの遵守を徹底できます。
*   **Auto Deployとの組み合わせ:** ネットワークブートでESXiを起動し、起動時にホストプロファイルを自動適用することで、完全に自動化・標準化されたホストを数分で展開できます。
*   **注意点:** ハードウェア構成が異なる場合は考慮が必要です。一部の設定変更はホストの再起動を伴います。

