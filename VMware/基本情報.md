# vSphere 完全解説ガイド

## 📘 vSphereとは

**vSphere**は、VMware社が提供するエンタープライズ向け仮想化プラットフォームの総称です。サーバー仮想化、ストレージ、ネットワークを統合管理し、データセンターのインフラをソフトウェアで制御します。

---

## 🏗️ 基盤コンポーネント

### 1. **ESXi**
- **役割**: ハイパーバイザー（物理サーバーに直接インストール）
- **特徴**:
  - Type 1ハイパーバイザー（ベアメタル型）
  - 軽量なLinuxベースOS
  - 複数の仮想マシンを実行・管理

```
┌─────────────────────────────────────┐
│  VM1    VM2    VM3    VM4    VM5   │ ← 仮想マシン
├─────────────────────────────────────┤
│         ESXi ハイパーバイザー        │ ← 仮想化レイヤー
├─────────────────────────────────────┤
│      物理サーバー（ハードウェア）     │
│  CPU / メモリ / NIC / ストレージ    │
└─────────────────────────────────────┘
```

### 2. **vCenter Server**
- **役割**: ESXiホストの集中管理サーバー
- **機能**:
  - 複数ESXiホストの統合管理
  - リソースプール、クラスター管理
  - 高度な機能（vMotion、DRSなど）の制御中枢

```
                 ┌─────────────────┐
                 │ vCenter Server  │ ← 集中管理
                 └────────┬────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
    ┌─────▼─────┐   ┌─────▼─────┐   ┌─────▼─────┐
    │  ESXi #1  │   │  ESXi #2  │   │  ESXi #3  │
    │  VM VM VM │   │  VM VM VM │   │  VM VM VM │
    └───────────┘   └───────────┘   └───────────┘
```

### 3. **vSphere Client**
- **役割**: Webベースの管理インターフェース
- **機能**:
  - HTML5対応の最新UI
  - ESXi、vCenterへのアクセス
  - VM作成、監視、設定変更

```
┌──────────────┐
│   管理者PC   │
│  ブラウザ    │
└──────┬───────┘
       │ HTTPS
       ▼
┌──────────────┐     ┌──────────────┐
│   vSphere    │────→│   vCenter    │
│   Client     │     │    Server    │
│  (Web UI)    │     └──────────────┘
└──────────────┘
```

---

## 💾 ストレージ技術

### 4. **VMFS (Virtual Machine File System)**
- **役割**: VMware専用の共有ストレージファイルシステム
- **特徴**:
  - クラスター化されたファイルシステム
  - 複数ESXiから同時アクセス可能
  - VMDKファイル（仮想ディスク）の格納

```
    ESXi #1          ESXi #2          ESXi #3
       │                │                │
       └────────────────┼────────────────┘
                        │ 共有アクセス
                        ▼
              ┌──────────────────┐
              │  共有ストレージ   │
              │   (SAN/NAS)      │
              ├──────────────────┤
              │  VMFS Volume     │
              │  ├─ VM1.vmdk     │
              │  ├─ VM2.vmdk     │
              │  └─ VM3.vmdk     │
              └──────────────────┘
```

### 5. **vSAN**
- **役割**: ソフトウェア定義ストレージ（SDS）
- **仕組み**:
  - ESXiホストのローカルディスクを統合
  - 分散型共有ストレージを構築
  - 外部SANが不要

```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  ESXi #1    │  │  ESXi #2    │  │  ESXi #3    │
│  VM VM VM   │  │  VM VM VM   │  │  VM VM VM   │
├─────────────┤  ├─────────────┤  ├─────────────┤
│ vSAN Layer  │  │ vSAN Layer  │  │ vSAN Layer  │
├─────────────┤  ├─────────────┤  ├─────────────┤
│ ローカルSSD │  │ ローカルSSD │  │ ローカルSSD │
│ ローカルHDD │  │ ローカルHDD │  │ ローカルHDD │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       └─────────────────┴─────────────────┘
              vSAN クラスター
          （統合された仮想データストア）
```

### 6. **Thin Provisioning**
- **役割**: ストレージの効率的利用
- **仕組み**:
  - 仮想ディスクに100GB割り当てても実使用分だけ消費
  - 過剰割り当て（オーバーコミット）が可能

```
【Thick Provisioning（固定割り当て）】
仮想ディスク: 100GB  →  物理使用: 100GB (即時確保)
├──────────────────────────────────────┤
■■■■■■■■■■■■■■■■■■■■ (全領域確保)

【Thin Provisioning（シンプロビジョニング）】
仮想ディスク: 100GB  →  物理使用: 30GB (実使用分のみ)
├──────────────────────────────────────┤
■■■■■■■□□□□□□□□□□□□□ (必要に応じて拡張)
    ↑実使用
```

---

## 🛡️ 可用性・保護機能

### 7. **vSphere HA (High Availability)**
- **役割**: 自動フェイルオーバー
- **動作**:
  1. ESXiホストが故障
  2. 他のホストでVMを自動再起動
  3. 数分でサービス復旧

```
【正常時】
┌─────────┐  ┌─────────┐  ┌─────────┐
│ ESXi #1 │  │ ESXi #2 │  │ ESXi #3 │
│ VM1 VM2 │  │ VM3 VM4 │  │ VM5 VM6 │
└─────────┘  └─────────┘  └─────────┘
      ↓           ↓            ↓
    ┌─────────────────────────────┐
    │     共有ストレージ (VMFS)    │
    └─────────────────────────────┘

【ESXi #1 障害発生】
┌─────────┐  ┌─────────┐  ┌─────────┐
│ ESXi #1 │  │ ESXi #2 │  │ ESXi #3 │
│   ✗✗✗   │  │ VM3 VM4 │  │ VM5 VM6 │
└─────────┘  │ VM1 VM2 │← │自動再起動│
             └─────────┘  └─────────┘
                ↑              ↑
    HAが検知して自動的に他ホストでVM再起動
```

### 8. **vSphere Fault Tolerance (FT)**
- **役割**: ゼロダウンタイム保護
- **仕組み**:
  - VMのミラーコピー（セカンダリVM）を別ホストで稼働
  - プライマリ障害時、瞬時に切り替え

```
【通常動作】
┌─────────────────┐         ┌─────────────────┐
│    ESXi #1      │         │    ESXi #2      │
│                 │ リアル  │                 │
│  ┌───────────┐  │ タイム  │  ┌───────────┐  │
│  │Primary VM │  │ 同期    │  │Secondary  │  │
│  │  (稼働中) │◄─┼────────►│  │    VM     │  │
│  └───────────┘  │         │  │(ミラー)   │  │
└─────────────────┘         └──┴───────────┴──┘
        ↑                        ↑
    ユーザー接続              待機状態

【ESXi #1 障害時】
┌─────────────────┐         ┌─────────────────┐
│    ESXi #1      │         │    ESXi #2      │
│      ✗✗✗        │         │  ┌───────────┐  │
│                 │         │  │Secondary  │  │
│                 │         │  │    VM     │  │
│                 │         │  │→Primary昇格│  │
└─────────────────┘         └──┴───────────┴──┘
                                    ↑
                            瞬時に切り替え
                           (ユーザーは気づかない)
```

### 9. **Snapshots**
- **役割**: VM状態の瞬間バックアップ
- **用途**:
  - パッチ適用前の保護ポイント作成
  - ロールバック（元の状態に戻す）

```
時系列：
t0          t1              t2              t3
│           │               │               │
│    スナップショット作成      パッチ適用      問題発覚
│           │               │               │
▼           ▼               ▼               ▼
┌─────┐   ┌─────┐         ┌─────┐
│VM   │──→│VM   │────────→│VM   │
│初期 │   │状態 │         │変更後│
└─────┘   └─────┘         └─────┘
            ↑                 │
            │    ロールバック  │
            └─────────────────┘
          (t1の状態に復元可能)

【ディスク構造】
Base Disk: [==================]  元のVMDK
              ↓
Snapshot:     [====] ← 差分データのみ保存
```

### 10. **vSphere Replication**
- **役割**: VM単位の非同期レプリケーション
- **特徴**:
  - 別サイトへのDR（災害対策）
  - RPO（目標復旧時点）は15分～

```
【本番サイト】              【DRサイト】
┌─────────────┐            ┌─────────────┐
│  vCenter A  │            │  vCenter B  │
└──────┬──────┘            └──────┬──────┘
       │                          │
┌──────▼──────┐   レプリ   ┌──────▼──────┐
│   ESXi      │   ケーション│   ESXi      │
│  ┌──────┐   │   ========>│  ┌──────┐   │
│  │VM(本)│   │   15分毎   │  │VM(複)│   │
│  └──────┘   │            │  └──────┘   │
└─────────────┘            └─────────────┘
     ↑                           ↑
  通常稼働                   障害時に起動
```

### 11. **vSphere Data Protection (VDP)**
- **役割**: バックアップソリューション
- **注意**: 製品終了（EOS）→後継は**Veeam**などサードパーティへ移行

---

## 🚀 移行・最適化機能

### 12. **vMotion**
- **役割**: 稼働中VMのライブマイグレーション
- **動作**:
  - 無停止でVMを別ESXiホストへ移動
  - メモリ内容をネットワーク経由で転送

```
【移行前】                    【移行中】
┌─────────────┐              ┌─────────────┐
│  ESXi #1    │              │  ESXi #1    │
│  ┌──────┐   │   vMotion    │  ┌──────┐   │
│  │ VM1  │   │   ========>  │  │ VM1  │   │
│  │稼働中│   │   メモリ転送  │  └──┬───┘   │
│  └──────┘   │              │     │コピー │
└─────────────┘              └─────┼───────┘
       ↓                           ↓
   共有ストレージ              ┌─────▼───────┐
  (VMDK は移動不要)            │  ESXi #2    │
                              │  ┌──────┐   │
【移行後】                     │  │ VM1  │   │
┌─────────────┐              │  │起動中│   │
│  ESXi #1    │              │  └──────┘   │
│             │              └─────────────┘
│  (空き)     │                    ↑
└─────────────┘              サービス無停止で移行完了
```

### 13. **Storage vMotion**
- **役割**: 稼働中VMのストレージ移行
- **用途**:
  - ストレージメンテナンス
  - パフォーマンス最適化

```
【移行前】
┌─────────────┐
│   ESXi      │
│   ┌─────┐   │
│   │ VM1 │   │
│   └──┬──┘   │
└──────┼──────┘
       ↓
┌──────▼──────────┐
│ Datastore A     │
│  VM1.vmdk       │
└─────────────────


```

【移行中】
┌─────────────┐
│   ESXi      │
│   ┌─────┐   │
│   │ VM1 │   │ ← 稼働継続
│   └──┬──┘   │
└──────┼──────┘
       │
   データコピー
       ├─────────────┐
       ↓             ↓
┌─────────────┐  ┌─────────────┐
│Datastore A  │  │Datastore B  │
│ VM1.vmdk    │→ │ VM1.vmdk    │
└─────────────┘  └─────────────┘

【移行後】
┌─────────────┐
│   ESXi      │
│   ┌─────┐   │
│   │ VM1 │   │
│   └──┬──┘   │
└──────┼──────┘
       │
       ↓
┌─────────────┐  ┌─────────────┐
│Datastore A  │  │Datastore B  │
│  (削除済)   │  │ VM1.vmdk    │
└─────────────┘  └─────────────┘
```

### 14. **DRS (Distributed Resource Scheduler)**
- **役割**: リソース負荷分散の自動化
- **動作**:
  - クラスター内のCPU/メモリ使用率を監視
  - 不均衡時に自動vMotion実行

```
【負荷不均衡検出】
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  ESXi #1    │  │  ESXi #2    │  │  ESXi #3    │
│ CPU: 90%    │  │ CPU: 30%    │  │ CPU: 25%    │
│ ┌─┐┌─┐┌─┐  │  │   ┌─┐       │  │   ┌─┐       │
│ │A││B││C│  │  │   │D│       │  │   │E│       │
│ └─┘└─┘└─┘  │  │   └─┘       │  │   └─┘       │
└─────────────┘  └─────────────┘  └─────────────┘
       ↓               ↑
       └───DRS判断─────┘

【自動バランシング後】
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  ESXi #1    │  │  ESXi #2    │  │  ESXi #3    │
│ CPU: 50%    │  │ CPU: 50%    │  │ CPU: 45%    │
│ ┌─┐┌─┐     │  │ ┌─┐┌─┐     │  │ ┌─┐┌─┐     │
│ │A││B│     │  │ │C││D│     │  │ │E││F│     │
│ └─┘└─┘     │  │ └─┘└─┘     │  │ └─┘└─┘     │
└─────────────┘  └─────────────┘  └─────────────┘
         負荷が均等に分散
```

### 15. **Storage DRS**
- **役割**: ストレージの負荷分散
- **機能**:
  - データストアクラスターの容量・I/O管理
  - 自動的にStorage vMotion実行

```
【Datastoreクラスター】

初期状態（不均衡）:
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Datastore 1  │  │ Datastore 2  │  │ Datastore 3  │
│ 容量: 85%    │  │ 容量: 40%    │  │ 容量: 35%    │
│ I/O: 高      │  │ I/O: 低      │  │ I/O: 低      │
│ VM1 VM2 VM3  │  │     VM4      │  │     VM5      │
│ VM6 VM7      │  │              │  │              │
└──────────────┘  └──────────────┘  └──────────────┘
        ↓                  ↑                 ↑
        └──Storage DRS─────┴─────────────────┘
               自動移動判断

Storage DRS実行後（均衡）:
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Datastore 1  │  │ Datastore 2  │  │ Datastore 3  │
│ 容量: 55%    │  │ 容量: 52%    │  │ 容量: 53%    │
│ I/O: 中      │  │ I/O: 中      │  │ I/O: 中      │
│ VM1 VM2      │  │ VM3 VM4 VM6  │  │ VM5 VM7      │
└──────────────┘  └──────────────┘  └──────────────┘
```

---

## 🌐 ネットワーク機能

### 16. **vSphere Distributed Switch (vDS)**
- **役割**: 集中管理型仮想スイッチ
- **メリット**:
  - vCenterから一括設定
  - 複数ESXiで一貫したネットワーク構成

```
【Standard Switch（従来型）】
各ESXiで個別設定が必要

┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│    ESXi #1      │  │    ESXi #2      │  │    ESXi #3      │
│  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │
│  │ vSwitch0  │  │  │  │ vSwitch0  │  │  │  │ vSwitch0  │  │
│  │ VLAN:10   │  │  │  │ VLAN:10   │  │  │  │ VLAN:10   │  │
│  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │
└─────────────────┘  └─────────────────┘  └─────────────────┘
   個別設定必要        個別設定必要        個別設定必要


【Distributed Switch（vDS）】
vCenterから一括管理

              ┌─────────────────┐
              │  vCenter Server │
              │                 │
              │  ┌───────────┐  │
              │  │    vDS    │  │ ← 一括設定
              │  │  (論理)   │  │
              │  └─────┬─────┘  │
              └────────┼────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────▼──────┐ ┌─────▼──────┐ ┌─────▼──────┐
│   ESXi #1    │ │  ESXi #2   │ │  ESXi #3   │
│ ┌──────────┐ │ │┌──────────┐│ │┌──────────┐│
│ │vDS (実体)│ │ ││vDS (実体)││ ││vDS (実体)││
│ └──────────┘ │ │└──────────┘│ │└──────────┘│
└──────────────┘ └────────────┘ └────────────┘
  設定自動反映      設定自動反映    設定自動反映
```

---

## 🔧 運用管理・自動化

### 17. **vSphere Update Manager (VUM)**
- **役割**: パッチ管理ツール
- **機能**:
  - ESXi、VMのパッチスキャン
  - 修正プログラムの一括適用

```
【パッチ適用フロー】

1. ベースライン作成
   ┌──────────────────┐
   │  VUM Server      │
   │  ┌────────────┐  │
   │  │ベースライン│  │ ← 適用すべきパッチ定義
   │  │ ESXi 7.0U3 │  │
   │  └────────────┘  │
   └──────────────────┘

2. スキャン実行
   ┌──────┐  ┌──────┐  ┌──────┐
   │ESXi1 │  │ESXi2 │  │ESXi3 │
   │ ✓準拠│  │ ✗不適│  │ ✗不適│
   └──────┘  └──────┘  └──────┘

3. 修復（自動化可能）
   ESXi2, ESXi3に対して:
   ① メンテナンスモード移行
   ② パッチ適用
   ③ 再起動
   ④ 運用モード復帰
   
   ┌──────┐  ┌──────┐  ┌──────┐
   │ESXi1 │  │ESXi2 │  │ESXi3 │
   │ ✓準拠│  │ ✓準拠│  │ ✓準拠│
   └──────┘  └──────┘  └──────┘
```

### 18. **Lifecycle Manager**
- **役割**: 次世代ライフサイクル管理
- **特徴**:
  - イメージベース管理（Desired State）
  - ESXi、ドライバー、ファームウェアの統合更新

```
【従来型（VUM）】
パッチ単位での管理
ESXi ──→ パッチA + パッチB + パッチC

【Lifecycle Manager】
イメージ全体での管理

┌────────────────────────────┐
│   Desired State Image      │
│  ┌──────────────────────┐  │
│  │ ESXi 7.0U3c          │  │
│  │ + ドライバー v2.5     │  │
│  │ + ファームウェア v1.8 │  │
│  │ + セキュリティパッチ  │  │
│  └──────────────────────┘  │
└────────────┬───────────────┘
             │ 一括適用
    ┌────────┼────────┐
    ▼        ▼        ▼
┌───────┐┌───────┐┌───────┐
│ESXi #1││ESXi #2││ESXi #3│
└───────┘└───────┘└───────┘
 全て同一構成に自動収束
```

### 19. **ホストプロファイル (vSphere Profiles)**
- **役割**: ESXi設定の標準化
- **仕組み**:
  1. リファレンスホストから設定を抽出
  2. プロファイル作成
  3. 他のホストへ適用

```
【ホストプロファイル適用フロー】

Step 1: リファレンスホストから抽出
┌──────────────────────┐
│  リファレンスホスト   │
│  ┌────────────────┐  │
│  │ NTP設定        │  │
│  │ DNS設定        │  │
│  │ vSwitch構成    │  │
│  │ セキュリティ設定│  │
│  └────────────────┘  │
└──────────┬───────────┘
           │ 設定抽出
           ▼
    ┌─────────────┐
    │ホストプロファイル│
    │  (テンプレート) │
    └────────┬────────┘
             │
Step 2: 適用
             │
    ┌────────┼────────┬────────┐
    ▼        ▼        ▼        ▼
┌───────┐┌───────┐┌───────┐┌───────┐
│ESXi #1││ESXi #2││ESXi #3││ESXi #4│
└───────┘└───────┘└───────┘└───────┘

Step 3: コンプライアンスチェック
┌───────┐┌───────┐┌───────┐┌───────┐
│  ✓   ││  ✓   ││  ✗   ││  ✓   │
│準拠  ││準拠  ││不準拠 ││準拠  │
└───────┘└───────┘└───────┘└───────┘
                   ↑
              自動検出・修復
```

### 20. **Auto Deploy**
- **役割**: ESXiのステートレス展開
- **動作**:
  - PXEブートでネットワークからESXiをロード
  - ホストプロファイルで設定自動適用
  - ローカルディスク不要

```
【Auto Deploy 起動フロー】

1. 物理サーバー起動
┌──────────────────┐
│  物理サーバー     │
│  (ディスクレス)  │ ← ローカルディスク不要
└────────┬─────────┘
         │ PXE Boot
         ▼
2. DHCP/TFTP経由でブート
┌──────────────────┐
│ Auto Deploy      │
│ Server           │
├──────────────────┤
│ ESXiイメージ     │
│ ホストプロファイル│
└────────┬─────────┘
         │ ネットワーク経由で配信
         ▼
3. メモリ上でESXi起動
┌──────────────────┐
│  ESXi (メモリ上) │
│  ┌────────────┐  │
│  │完全な設定  │  │
│  │自動適用済  │  │
│  └────────────┘  │
└──────────────────┘
         │
         ▼
4. vCenterに自動登録
┌──────────────────┐
│   vCenter Server │
│   (管理下に追加) │
└──────────────────┘

【メリット】
- サーバー再起動で常にクリーンな状態
- 大量展開が容易
- セキュリティ強化（永続的な変更不可
